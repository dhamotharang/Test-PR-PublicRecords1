import ut;

export Rollup_Base( dataset(Layouts.Base) pDataset) := function

	Layouts.Base  trans_RecID(Layouts.Base l ):=transform
		self.Source_rec_id := (unsigned8)(hash64( l.Experian_Bus_Id,
																							l.Business_Name,
																							l.Address,
																							l.City,
																							l.State,
																							l.ZIP_Code,
																							l.ZIP_Plus_4,
																							l.Carrier_Route,
																							l.County_Code,
																							l.County_Name,
																							l.Phone_Number,
																							l.MSA_Code,
																							l.MSA_Description,
																							l.GEO_Code_Latitude,
																							l.GEO_Code_Latitude_Direction,
																							l.GEO_Code_Longitude,
																							l.GEO_Code_Longitude_Direction,
																							l.Recent_Update_Code,
																							l.Years_in_Business_Code,
																							l.Year_Business_Started,
																							l.Address_Type_Code,
																							l.Estimated_Number_of_Employees,
																							l.Employee_Size_Code,
																							l.Estimated_Annual_Sales_Amount_Sign,
																							l.Estimated_Annual_Sales_Amount,
																							l.Annual_Sales_Size_Code,
																							l.Location_Code,
																							l.Primary_SIC_Code_Industry_Classification,
																							l.Primary_SIC_Code_4_Digit,
																							l.Primary_SIC_Code,
																							l.Second_SIC_Code,
																							l.Third_SIC_Code,
																							l.Fourth_SIC_Code,
																							l.Fifth_SIC_Code,
																							l.Sixth_SIC_Code,
																							l.Primary_NAICS_Code,
																							l.Second_NAICS_Code,
																							l.Third_NAICS_Code,
																							l.Fourth_NAICS_Code,
																							l.Executive_Count,
																							l.Executive_Last_Name,
																							l.Executive_First_Name,
																							l.Executive_Middle_Initial,
																							l.Executive_Title,
																							l.Business_Type,
																							l.Ownership_Code,
																							l.URL,
																							l.Derogatory_Indicator,
																							l.Recent_Derogatory_Filed_Date,
																							l.Derogatory_Liability_Amount_Sign,
																							l.Derogatory_Liability_Amount,
																							l.UCC_Data_Indicator,
																							l.UCC_Count,
																							l.Number_of_Legal_Items,
																							l.Legal_Balance_Sign,
																							l.Legal_Balance_Amount,
																							l.PMTKBankruptcy,
																							l.PMTKJudgment,
																							l.PMTKTaxlien,
																							l.PMTKPayment,
																							l.Bankruptcy_filed,
																							l.Number_of_Derogatory_Legal_Items,
																							l.Lien_count,
																							l.Judgment_count,
																							l.BKC006,
																							l.BKC007,
																							l.BKC008,
																							l.BKO009,
																							l.BKB001_Sign,
																							l.BKB001,
																							l.BKB003_Sign,
																							l.BKB003,
																							l.BKO010,
																							l.BKO011,
																							l.JDC010,
																							l.JDC011,
																							l.JDC012,
																							l.JDB004,
																							l.JDB005,
																							l.JDB006,
																							l.JDO013,
																							l.JDO014,
																							l.JDB002,
																							l.JDP016,
																							l.LGC004,
																							l.PRO001,
																							l.PRO003,
																							l.TXC010,
																							l.TXC011,
																							l.TXB004_Sign,
																							l.TXB004,
																							l.TXO013,
																							l.TXB002_Sign,
																							l.TXB002,
																							l.TXP016,
																							l.UCC001,
																							l.UCC002,
																							l.UCC003,
																							l.Model_action,
																							l.Score_Factor_1,
																							l.Score_Factor_2,
																							l.Score_Factor_3,
																							l.Score_Factor_4,
																							l.Model_Code,
																							l.Model_type,
																							l.Last_Experian_Inquiry_Date,
																							l.Recent_High_Credit_Sign,
																							l.Recent_High_Credit,
																							l.Median_Credit_Amount_Sign,
																							l.Median_Credit_Amount,
																							l.Total_Combined_Trade_Lines_Count,
																							l.DBT_of_Combined_Trade_Totals,
																							l.Combined_Trade_Balance,
																							l.Aged_Trade_Lines,
																							l.Experian_Credit_Rating,
																							l.Quarter_1_Average_DBT,
																							l.Quarter_2_Average_DBT,
																							l.Quarter_3_Average_DBT,
																							l.Quarter_4_Average_DBT,
																							l.Quarter_5_Average_DBT,
																							l.Combined_DBT,
																							l.Total_Account_Balance_Sign,
																							l.Total_Account_Balance,
																							l.Combined_Account_Balance_Sign,
																							l.Combined_Account_Balance,
																							l.Collection_count,
																							l.ATC021,
																							l.ATC022,
																							l.ATC023,
																							l.ATC024,
																							l.ATC025,
																							l.Cottage_Indicator,
																							l.NonProfit_Indicator,
																							l.Financial_Stability_Risk_Score,
																							l.FSR_Risk_Class,
																							l.FSR_Score_Factor_1,
																							l.FSR_Score_Factor_2,
																							l.FSR_Score_Factor_3,
																							l.FSR_Score_Factor_4,
																							l.IP_Score_change_sign,
																							l.FSR_Score_change_sign,
																							l.FSR_Score_change,
																							l.DBA_Name	));
		self							 :=l;
	end;
  DS_RecID      :=project(pDataset ,trans_RecID(left));
	
	pDataset_sort := sort(distribute(DS_RecID, hash(Experian_Bus_Id)), Experian_Bus_Id, source_rec_id, -dt_vendor_last_reported, local);
	
	Layouts.Base RollupUpdate(Layouts.Base l, Layouts.Base r) := transform
		SELF.dt_first_seen 						:= ut.EarliestDate(l.dt_first_seen , r.dt_first_seen);
	  SELF.dt_last_seen							:= Max(l.dt_last_seen	, r.dt_last_seen);
		SELF.Establish_Date 					:= (string) ut.EarliestDate((unsigned4)l.Establish_Date , (unsigned4)r.Establish_Date);
	  SELF.Latest_Reported_Date			:= (string) Max((unsigned4)l.Latest_Reported_Date	,(unsigned4) r.Latest_Reported_Date);
		SELF.dt_vendor_first_reported := ut.EarliestDate(l.dt_vendor_first_reported	, r.dt_vendor_first_reported);
		SELF.dt_vendor_last_reported 	:= Max(l.dt_vendor_last_reported	, r.dt_vendor_last_reported	);
		self 													:= l;
	end;

	pDataset_rollup := rollup( pDataset_sort
														,left.Experian_Bus_Id = right.Experian_Bus_Id and 
														 left.source_rec_id = right.source_rec_id
														,RollupUpdate(left, right)
														,local
													 );
	
	return pDataset_rollup;

end;