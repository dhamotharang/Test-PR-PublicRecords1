IMPORT SALT311,STD;
EXPORT HVCCW_Delta(DATASET(HVCCW_Layout_eMerges)old_s, DATASET(HVCCW_Layout_eMerges) new_s) := MODULE//Routines to compute the differences between two instances of a file
  SHARED inFieldList := ['append_seqnum','persistent_record_id','process_date','date_first_seen','date_last_seen','score','best_ssn','did_out','source','file_id','vendor_id','source_state','source_code','file_acquired_date','_use','title_in','lname_in','fname_in','mname_in','maiden_prior','name_suffix_in','votefiller','source_voterid','dob_str_in','agecat','headhousehold','place_of_birth','occupation','maiden_name','motorvoterid','regsource','regdate_in','race','gender','poliparty','phone','work_phone','other_phone','active_status','votefiller2','active_other','voterstatus','resaddr1','resaddr2','res_city','res_state','res_zip','res_county','mail_addr1','mail_addr2','mail_city','mail_state','mail_zip','mail_county','addr_filler1','addr_filler2','city_filler','state_filler','zip_filler','county_filler','towncode','distcode','countycode','schoolcode','cityinout','spec_dist1','spec_dist2','precinct1','precinct2','precinct3','villageprecinct','schoolprecinct','ward','precinct_citytown','ancsmdindc','citycouncildist','countycommdist','statehouse','statesenate','ushouse','elemschooldist','schooldist','schoolfiller','commcolldist','dist_filler','municipal','villagedist','policejury','policedist','publicservcomm','rescue','fire','sanitary','sewerdist','waterdist','mosquitodist','taxdist','supremecourt','justiceofpeace','judicialdist','superiorctdist','appealsct','courtfiller','contributorparty','recptparty','dateofcontr_in','dollaramt','officecontto','cumuldollaramt','contfiller1','contfiller2','conttype','contfiller3','primary02','special02','other02','special202','general02','primary01','special01','other01','special201','general01','pres00','primary00','special00','other00','special200','general00','primary99','special99','other99','special299','general99','primary98','special98','other98','special298','general98','primary97','special97','other97','special297','general97','pres96','primary96','special96','other96','special296','general96','lastdayvote_in','historyfiller','huntfishperm','datelicense_in','homestate','resident','nonresident','hunt','fish','combosuper','sportsman','trap','archery','muzzle','drawing','day1','day3','day7','day14to15','dayfiller','seasonannual','lifetimepermit','landowner','family','junior','seniorcit','crewmemeber','retarded','indian','serviceman','disabled','lowincome','regioncounty','blind','huntfiller','salmon','freshwater','saltwater','lakesandresevoirs','setlinefish','trout','fallfishing','steelhead','whitejubherring','sturgeon','shellfishcrab','shellfishlobster','deer','bear','elk','moose','buffalo','antelope','sikebull','bighorn','javelina','cougar','anterless','pheasant','goose','duck','turkey','snowmobile','biggame','skipass','migbird','smallgame','sturgeon2','gun','bonus','lottery','otherbirds','huntfill1','boatindexnum','boatcoowner','hullidnum','yearmade','model','manufacturer','lengt','hullconstruct','primuse','fueltype','propulsion','modeltype','regexpdate_in','titlenum','stprimuse','titlestatus','vessel','specreg','boatfill1','boatfill2','boatfill3','ccwpermnum','ccwweapontype','ccwregdate_in','ccwexpdate_in','ccwpermtype','ccwfill1','ccwfill2','ccwfill3','ccwfill4','miscfill1','miscfill2','miscfill3','miscfill4','miscfill5','fillerother1','fillerother2','fillerother3','fillerother4','fillerother5','fillerother6','fillerother7','fillerother8','fillerother9','fillerother10','eor','stuff','dob_str','regdate','dateofcontr','lastdayvote','datelicense','regexpdate','ccwregdate','ccwexpdate','title','fname','mname','lname','name_suffix','score_on_input','append_prep_resaddress1','append_prep_resaddress2','append_resrawaid','append_prep_mailaddress1','append_prep_mailaddress2','append_mailrawaid','append_prep_cassaddress1','append_prep_cassaddress2','append_cassrawaid','aid_resclean_prim_range','aid_resclean_predir','aid_resclean_prim_name','aid_resclean_addr_suffix','aid_resclean_postdir','aid_resclean_unit_desig','aid_resclean_sec_range','aid_resclean_p_city_name','aid_resclean_v_city_name','aid_resclean_st','aid_resclean_zip','aid_resclean_zip4','aid_resclean_cart','aid_resclean_cr_sort_sz','aid_resclean_lot','aid_resclean_lot_order','aid_resclean_dpbc','aid_resclean_chk_digit','aid_resclean_record_type','aid_resclean_ace_fips_st','aid_resclean_fipscounty','aid_resclean_geo_lat','aid_resclean_geo_long','aid_resclean_msa','aid_resclean_geo_blk','aid_resclean_geo_match','aid_resclean_err_stat','aid_mailclean_prim_range','aid_mailclean_predir','aid_mailclean_prim_name','aid_mailclean_addr_suffix','aid_mailclean_postdir','aid_mailclean_unit_desig','aid_mailclean_sec_range','aid_mailclean_p_city_name','aid_mailclean_v_city_name','aid_mailclean_st','aid_mailclean_zip','aid_mailclean_zip4','aid_mailclean_cart','aid_mailclean_cr_sort_sz','aid_mailclean_lot','aid_mailclean_lot_order','aid_mailclean_dpbc','aid_mailclean_chk_digit','aid_mailclean_record_type','aid_mailclean_ace_fips_st','aid_mailclean_fipscounty','aid_mailclean_geo_lat','aid_mailclean_geo_long','aid_mailclean_msa','aid_mailclean_geo_blk','aid_mailclean_geo_match','aid_mailclean_err_stat','prim_range','predir','prim_name','suffix','postdir','unit_desig','sec_range','p_city_name','city_name','st','zip','zip4','cart','cr_sort_sz','lot','lot_order','dpbc','chk_digit','record_type','ace_fips_st','county','geo_lat','geo_long','msa','geo_blk','geo_match','err_stat','mail_prim_range','mail_predir','mail_prim_name','mail_addr_suffix','mail_postdir','mail_unit_desig','mail_sec_range','mail_p_city_name','mail_v_city_name','mail_st','mail_ace_zip','mail_zip4','mail_cart','mail_cr_sort_sz','mail_lot','mail_lot_order','mail_dpbc','mail_chk_digit','mail_record_type','mail_ace_fips_st','mail_fipscounty','mail_geo_lat','mail_geo_long','mail_msa','mail_geo_blk','mail_geo_match','mail_err_stat','cass_prim_range','cass_predir','cass_prim_name','cass_addr_suffix','cass_postdir','cass_unit_desig','cass_sec_range','cass_p_city_name','cass_v_city_name','cass_st','cass_ace_zip','cass_zip4','cass_cart','cass_cr_sort_sz','cass_lot','cass_lot_order','cass_dpbc','cass_chk_digit','cass_record_type','cass_ace_fips_st','cass_fipscounty','cass_geo_lat','cass_geo_long','cass_msa','cass_geo_blk','cass_geo_match','cass_err_stat'];
  EXPORT Differences := SALT311.mod_Delta.mac_DifferencesByFieldList(old_s, new_s, inFieldList);
  EXPORT DifferenceSummary := HVCCW_hygiene(old_s).Summary('Old') + HVCCW_hygiene(new_s).Summary('New') + HVCCW_hygiene(PROJECT(Differences(deleted), TRANSFORM(HVCCW_Layout_eMerges, SELF := LEFT.old_rec))).Summary('Deletions') + HVCCW_hygiene(PROJECT(Differences(added), TRANSFORM(HVCCW_Layout_eMerges, SELF := LEFT.new_rec))).Summary('Additions');
  EXPORT StandardStats(BOOLEAN doHygieneSummaryGlobal = TRUE) := FUNCTION
    myTimeStamp := (UNSIGNED6)SALT311.Fn_Now('YYYYMMDDHHMMSS') : INDEPENDENT;
    hygieneDiffOverall := DifferenceSummary;
    SALT311.mod_StandardStatsTransforms.mac_hygieneSummaryTransform(Scrubs_eMerges, HVCCW_Fields, 'RECORDOF(hygieneDiffOverall)', FALSE);
    hygieneDiffOverall_Standard := IF(doHygieneSummaryGlobal, NORMALIZE(hygieneDiffOverall, COUNT(inFieldList) * 6, xSummary(LEFT, COUNTER, myTimeStamp, LEFT.txt + '_all', LEFT.txt + '_all')));
 
    RETURN hygieneDiffOverall_Standard;
  END;
END;
