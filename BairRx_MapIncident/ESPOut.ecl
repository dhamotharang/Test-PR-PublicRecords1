/*2017-06-02T18:17:47Z (sperur)
C:\Users\perusr01\AppData\Roaming\HPCC Systems\eclide\sperur\Bair_Dev\BairRx_MapIncident\ESPOut\2017-06-02T18_17_47Z.ecl
*/
import BairRx_Common, BairRx_MapIncident, iesp, SALT32;

EXPORT ESPOut := MODULE

	SHARED iesp.bair_event.t_BAIRMOBaseRecord xtEventMO(BairRx_Common.Layouts.LayoutEventMO L) := TRANSFORM
		SELF.GeoCoded := L.geocoded;
		SELF.IRNumber := L.ir_number,
		SELF.UCRGroup := (STRING) L.ucr_group,
		SELF.Class := BairRx_Common.Functions.GetClass(BairRx_Common.Constants.Mode.EVE,(STRING) L.ucr_group),
		SELF.Crime := L.Crime,
		SELF.FirstDate := L.first_date,
		SELF.LastDate := L.last_date,
		SELF.FirstDateTime := L.first_date_time,
		SELF.LastDateTime := L.last_date_time,
		SELF.FirstTime := (STRING) L.first_time,
		SELF.LastTime := (STRING) L.last_time,
		SELF.FirstDay :=	L.first_day,
		SELF.LastDay :=	L.last_day,
		SELF.LocationType  := L.location_type,
		SELF.AddressName   :=	L.address_name,
		SELF.AddressOfCrime := L.address_of_crime,
		SELF.AptNum := L.apt,
		SELF.Accuracy := L.accuracy,
		SELF.XCoordinate := (STRING) L.x_coordinate,
		SELF.YCoordinate := (STRING) L.y_coordinate,		
		SELF.XOffset := (STRING) L.x_offset,
		SELF.YOffset := (STRING) L.y_offset,
		SELF.TCoordinate   :=	(STRING)L.t_coordinate,
		SELF.EditDate := L.edit_date, 
		SELF.ObjectOfAttack1 := L.object_of_attack_1,
		SELF.ObjectOfAttack2 := L.object_of_attack_2,
		SELF.PointOfEntry1 := L.point_of_entry_1,
		SELF.PointOfEntry2 := L.point_of_entry_2,
		SELF.MethodOfEntry1 := L.method_of_entry_1, 
		SELF.MethodOfEntry2 := L.method_of_entry_2,
		SELF.SuspectsActionsAgainstPerson1 := L.suspects_actions_against_person_1,
		SELF.SuspectsActionsAgainstPerson2 := L.suspects_actions_against_person_2,
		SELF.SuspectsActionsAgainstPerson3 := L.suspects_actions_against_person_3,
		SELF.SuspectsActionsAgainstPerson4 := L.suspects_actions_against_person_4,
		SELF.SuspectsActionsAgainstPerson5 := L.suspects_actions_against_person_5,
		SELF.SuspectsActionsAgainstProperty1 := L.suspects_actions_against_property_1,
		SELF.SuspectsActionsAgainstProperty2 := L.suspects_actions_against_property_2,
		SELF.SuspectsActionsAgainstProperty3 := L.suspects_actions_against_property_3,
		SELF.PropertyTaken1 := L.property_taken_1,
		SELF.PropertyTaken2 := L.property_taken_2,
		SELF.PropertyTaken3 := L.property_taken_3,
		SELF.PropertyValue := L.property_value,
		SELF.WeaponType1 := L.weapon_type_1,
		SELF.WeaponType2 := L.weapon_type_2,
		SELF.MethodOfDeparture := L.method_of_departure,
		SELF.Beat := L.beat,
		SELF.RD := L.rd,
		SELF.NumOfCompanions := L.companions,		
		SELF.MoStamp := (STRING) L.mostamp,
		SELF.AddressOfCrimeClean.City := L.City,
		SELF.AddressOfCrimeClean.State := L.State,
		SELF.AddressOfCrimeClean.Zip5 := L.Zip,
		SELF := []
	END;
	
	SHARED iesp.bair_event.t_BAIRMOBaseRecord xtSlimEventMO(BairRx_Common.Layouts.LayoutEventMO L) := TRANSFORM                                
    SELF.IRNumber := L.ir_number,
    SELF.UCRGroup := (STRING) L.ucr_group,
    SELF.Class := BairRx_Common.Functions.GetClass(BairRx_Common.Constants.Mode.EVE,(STRING) L.ucr_group),
    SELF.Crime := L.Crime,
    SELF.FirstDateTime := L.first_date_time,
    SELF.LocationType  := L.location_type,
    SELF.AddressOfCrime := L.public_address,
    SELF.Accuracy := L.accuracy,
    SELF.XCoordinate := (STRING) L.x_coordinate,
    SELF.YCoordinate := (STRING) L.y_coordinate,                          
    SELF.XOffset := (STRING) L.x_offset,
    SELF.YOffset := (STRING) L.y_offset,
    SELF := []
   END;


	SHARED iesp.bair_cfs.t_BAIRCfsBaseCallRecord xtCFSCall(BairRx_Common.Layouts.LayoutCFSCall L) := TRANSFORM
		SELF.InitialUCR := (STRING) L.initial_ucr_group,
		SELF.FinalUCR := (STRING) L.final_ucr_group,
		SELF.EventNumber := L.event_number,
		SELF.InitialType := L.initial_type,
		SELF.FinalType := L.final_type,
		SELF.HowReceived := L.how_received,
		SELF.DateTimeReceived := L.date_time_received,
		SELF.TotalMinutesOnCall := (STRING) L.total_minutes_on_call,
		SELF.EventAddress := L.address,		
		SELF.Accuracy := L.accuracy,
		SELF.District := L.district,
		SELF.Beat := L.beat,
		SELF.ReportingDistrict := L.rd,
		SELF.XCoordinate := (STRING) L.x_coordinate,
		SELF.YCoordinate := (STRING) L.y_coordinate,
		SELF.DateTimeArchived := L.date_time_archived,
		SELF.City := L.city,
		SELF.CallTaker := L.call_taker,
		SELF.ContactingOfficer := L.contacting_officer,
		SELF.Status := L.status,
		SELF.ApartmentNumber := L.apartment_number,
		SELF.PlaceName := L.place_name,
		SELF.IncidentCode := L.incident_code,
		SELF.IncidentProgress := L.incident_progress,
		SELF.Complainant := L.complainant,
		SELF.ComplainantAddress := L.complainant_address,
		SELF.ReportNumber := L.report_number,
		SELF.ComplainantXCoordinate := (STRING) L.complainant_x_coordinate,
		SELF.ComplainantYCoordinate := (STRING) L.complainant_y_coordinate,
		SELF.GeoCoded := L.geocoded,
		SELF.calleraddress := L.caller_address,
		SELF.CurrentPhone	:=	L.current_phone,
		SELF.disposition	:=	L.disposition,
		SELF.priority	:=	L.priority1,
		SELF.LocationType := L.location_type,
		SELF := []
	END;
	
	SHARED iesp.bair_crash.t_BAIRCrashBaseIncidentRecord xtCrashIncident(BairRx_Common.Layouts.LayoutCrashIncident L) := TRANSFORM
		SELF.CaseNumber := L.case_number,
		SELF.ReportDateTime := L.report_date,
		SELF.Address := L.address,
		SELF.County := L.county,
		SELF.City := L.crash_city,
		SELF.State := L.crash_state,
		SELF.IntersectionRelated := L.intersectionrelated,
		SELF.OfficerName := L.officername,
		SELF.CrashType := L.crashtype,
		SELF.LocationType := L.locationtype,
		SELF.XCoordinate := (STRING) L.x,
		SELF.YCoordinate := (STRING) L.y,
		SELF.AccidentClass := L.accidentclass,
		SELF.LightCondition := L.lightcondition,
		SELF.WeatherCondition := L.weathercondition,
		SELF.SurfaceType := L.surfacetype,
		SELF.SurfaceCondition := L.surfacecondition,
		SELF.ReportNumber := L.reportnumber,
		SELF.HitAndRun := L.hitandrun,
		SELF.SpecialCircumstance1 := L.specialcircumstance1,
		SELF.SpecialCircumstance2 := L.specialcircumstance2,
		SELF.SpecialCircumstance3 := L.specialcircumstance3,
		SELF.RoadSpecialFeature1 := L.roadspecialfeature1,
		SELF.RoadSpecialFeature2 := L.roadspecialfeature2,
		SELF.RoadSpecialFeature3 := L.roadspecialfeature3,
		SELF.TrafficControlPresent := L.trafficcontrolpresent
	END;

	EXPORT iesp.bair_mapincident.t_BAIRMapLPRRecord xtLPR(BairRx_Common.Layouts.LayoutLPR L) := TRANSFORM
		SELF.LicensePlateRecordGUID := L.licenseplaterecordguid,
		SELF.EventNumber := L.eventnumber,
		SELF.PlateNumber := L.plate,
		SELF.CaptureDateTime := L.capturedatetime,
		SELF.XCoordinate := (STRING) L.x_coordinate,
		SELF.YCoordinate := (STRING) L.y_coordinate,
		SELF.ImageAvailable := L.has_image
	END;
	
	EXPORT iesp.bair_mapincident.t_BAIRMapOffenderRecord xtOFfender(BairRx_Common.Layouts.LayoutOffender L) := TRANSFORM
		SELF.Classification := BairRx_Common.ClassificationCode.GetClassification(L.class_code),	
		SELF.OffenderID := L.agency_offender_id,
		SELF.PhotoURL := L.picture,
		SELF.Address := L.address,
		SELF.LexID := (STRING) L.lexid,
		SELF.FirstName := L.first_name,
		SELF.MiddleName := L.middle_name,
		SELF.LastName := L.last_name,
		SELF.Moniker := L.moniker,
		SELF.NameType := L.name_type,
		SELF.DOB := L.dob,
		SELF.Race := L.race,
		SELF.Sex := L.sex,
		SELF.Hair := L.hair,
		SELF.HairLength := L.hair_length,
		SELF.Eyes := L.eyes,
		SELF.HandUse := L.hand_use,
		SELF.Speech := L.speech,
		SELF.Teeth := L.teeth,
		SELF.PhysicalCondition := L.physical_condition,
		SELF.Build := L.build,
		SELF.Complexion := L.complexion,
		SELF.FacialHair := L.facial_hair,
		SELF.Hat := L.hat,
		SELF.Mask := L.mask,
		SELF.Glasses := L.glasses,
		SELF.Appearance := L.Appearance,
		SELF.Shirt := L.shirt,
		SELF.Pants := L.pants,
		SELF.Shoes := L.shoes,
		SELF.Jacket := L.jacket,
		SELF.Weight1 := (STRING) L.weight_1,
		SELF.Weight2 := (STRING) L.weight_2,
		SELF.Height1 := (STRING) L.height_1,
		SELF.Height2 := (STRING) L.height_2,
		SELF.Age1 := (STRING) L.age_1,
		SELF.Age2 := (STRING) L.age_2,
		SELF.AgencyName := L.agency_name, // not the same as agency name
		SELF.SID := L.offenders_sid,
		SELF.DLNumber := L.dl_number,
		SELF.DLState := L.dl_state,
		SELF.FBINumber := L.fbi_number,
		SELF.EditDate := L.edit_date,
		SELF.AdminState := L.admin_state,
		SELF.Category := L.agency_category,
		SELF.Level := L.agency_level,
		SELF.Score := L.agency_score,
		SELF.CaseReferenceNumber := L.case_reference_number,
		SELF.ChargeOffense := L.charge_offense,
		SELF.ProbationType := L.probation_type,
		SELF.ProbationOfficer := L.probation_officer,
		SELF.WarrantType := L.warrant_type,
		SELF.WarrantNumber := L.warrant_number,
		SELF.GangName := L.gang_name,
		SELF.GangRole := L.gang_role,
		SELF.ClassificationDate := L.classification_date,
		SELF.ExpirationDate := L.expiration_date,
		SELF.Expired := '', //L.expired
		SELF.XCoordinate := (STRING) L.x_coordinate,
		SELF.YCoordinate := (STRING) L.y_coordinate,
		SELF.OffenderPK := L.id, 
		SELF.ImageAvailable := L.has_image,
		SELF := []
	END;
	
	EXPORT iesp.bair_mapincident.t_BAIRMapShotSpotterRecord xtShotSpotter(BairRx_Common.Layouts.LayoutShotSpotter L) := TRANSFORM
		SELF.Shots := (STRING) L.shots,	
		SELF.ShotID := L.shot_id,	
		SELF.Address := L.address,	
		SELF.Beat := L.beat,	
		SELF.District := L.district,	
		SELF.Source := L.shot_source,	
		SELF.ShotType := IF(L.shot_incident_type in [1,2], '0', '')+(STRING)L.shot_incident_type,
		SELF.ShotStatus := L.shot_incident_status,	
		SELF.XCoordinate := (STRING) L.x_coordinate,	
		SELF.YCoordinate := (STRING) L.y_coordinate,	
		SELF.DateTime := L.shot_datetime,
		SELF := []
	END;

	EXPORT iesp.bair_mapincident.t_BAIRMapIncidentSearchRecord MapView(
		BairRx_Common.Layouts.MapPayload L, REAL geo_lat, REAL geo_lon, BOOLEAN inc_details = FALSE, BOOLEAN is_raids = FALSE
		) := TRANSFORM
		_distance := IF(L.distance=0 AND L.longitude<>'' AND L.latitude<>'', 
			(SALT32.MOD_LL.Distance((REAL)L.latitude,(REAL)L.longitude,geo_lat,geo_lon)), 			
			(L.distance/BairRx_Common.Constants.REAL_TO_INT_SCALE));
		SELF.Distance := REALFORMAT(_distance,10,2),
		SELF.EntityID := L.eid,
		SELF.ReferenceID := L.ReferenceID,
		SELF.UCRGroup := (STRING) L.class_code,
		SELF.Class := L.class, 
		SELF.AgencyID := L.ori,
		SELF.Agency := L.agency,
		SELF.DateTime :=  BairRx_Common.Functions.DateTimeToString(L.date),
		SELF.Latitude := L.latitude,
		SELF.Longitude := L.longitude,
		SELF.GeoHash := L.gh12,
		SELF.Address := L.address,
		// --- INCLUDE INCIDENT DETAILS OR isRaids 
		SELF.EventRecord.MOs 		:= IF (inc_details AND BairRx_Common.EID.IsEvent(L.eid),
																IF (is_raids, ROW(L.event_MO, xtSlimEventMO(LEFT)), ROW(L.event_MO, xtEventMO(LEFT))));
		SELF.CFSRecord					:= IF(inc_details AND BairRx_Common.EID.IsCFS(L.eid), ROW(L.cfs_call, xtCFSCall(LEFT)));
		SELF.CrashRecord				:= IF(inc_details AND BairRx_Common.EID.IsCrash(L.eid), ROW(L.crash_incident, xtCrashIncident(LEFT)));
		SELF.LPRRecord 					:= IF(inc_details AND BairRx_Common.EID.IsLPR(L.eid), ROW(L.lpr, xtLPR(LEFT))), 
		SELF.OffenderRecord 		:= IF(inc_details AND BairRx_Common.EID.IsOffender(L.eid), ROW(L.offender, xtOffender(LEFT))),
		SELF.ShotSpotterRecord 	:= IF(inc_details AND BairRx_Common.EID.IsShotSpotter(L.eid), ROW(L.shot_spotter, xtShotSpotter(LEFT))),
		SELF := []
	END;

END;
	