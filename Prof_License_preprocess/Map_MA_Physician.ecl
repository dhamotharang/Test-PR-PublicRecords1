import lib_StringLib,Prof_License;

EXPORT Map_MA_Physician(string fdate) := module

inFile := Prof_License_preprocess.File_MA_Physician.raw;

Prof_License.Layout_proLic_in tmaphy( inFile l) := transform
self.date_first_seen            := fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
self.date_last_seen             := fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
self.license_number             := l.license;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.status                     := l.license_status;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
self.license_type               := l.license_class;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
self.orig_name                  := trim(l.first_name)+' '+ trim(l.middle_init)+ ' '+ trim(l.last_name)+' '+ trim(l.generation);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.name_order                 := 'FML';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
self.dob                   := StringLib.Stringfilterout(l.birthdate[1..10],'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.sex                        := map ( l.gender = 'M' => 'Male',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                         l.gender = 'F' => 'Female','');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.education_1_school_attended := l.grad_school_name[1..30];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.education_1_dates_attended  := StringLib.Stringfilterout(l.graduation_date[1..10],'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
self.education_1_degree          := l.degree;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
self.orig_addr_1                 := l.addr_line_1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
self.orig_addr_2                 := l.addr_line_2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
self.orig_city                   := trim(l.addr_city)[1..40];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
self.orig_st                     := trim(l.addr_state);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.orig_zip                    := StringLib.Stringfilter(l.addr_zip_code,'0123456789');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
self.country_str                 := l.addr_country;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.phone                       := StringLib.Stringfilter(l.addr_phone_nbr,'0123456789');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
self.source_st                   := 'MA';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
self.vendor                      := 'Commonwealth of Massachusetts';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.profession_or_board         := 'Physicians';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
self.misc_practice_type          := l.specialty_1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
self.issue_date                  := StringLib.Stringfilter(l.license_orig_approval_date[1..10], '0123456789');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
self.last_renewal_date           := StringLib.Stringfilter(l.license_renewal_date[1..10], '0123456789');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.misc_other_id               := l.NPI;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.misc_other_id_type          := 'BORIM ID';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
self.additional_licensing_specifics := map ( l.specialty_2 <> '' =>  trim(l.specialty_2) ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
				                                    l.specialty_2 = '' and  l.specialty_3 <> '' =>  trim(l.specialty_3) ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
				                                    l.specialty_2 = '' and l.specialty_3 = '' and l.specialty_4 <> '' => trim(l.specialty_4) , '');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
self := [];

end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
dMAPhyout := project(  inFile, tmaphy(left));

dMAPhyClean := Sequential(  
                        FileServices.ClearSuperfile( '~thor_data400::in::prolic::ma::physician'),

                        output(dMAPhyout,,'~thor_data400::in::prolic::ma::physician_'+fdate,overwrite),
                         FileServices.StartSuperfiletransaction(),
												 if ( NOT FileServices.SuperFileExists( '~thor_data400::in::prolic::ma::physician'),FileServices.CreateSuperfile('~thor_data400::in::prolic::ma::physician')),

												 
												 FileServices.AddSuperfile( '~thor_data400::in::prolic::ma::physician','~thor_data400::in::prolic::ma::physician_'+fdate),
											   FileServices.FinishSuperfiletransaction()
											 );
											 
											 
outfile := proc_clean_all(dMAPhyout,'MA').cleanout;

export buildprep := Sequential(dMAPhyClean, 
                  FileServices.StartSuperfiletransaction(),
                                   FileServices.RemoveSuperFile('~thor_data400::in::prolic::allsources', '~thor_data400::in::prolic_ma'),
																	   if ( FileServices.FindSuperfilesubname(  '~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_ma_old') <> 0,      FileServices.RemoveSuperFile(	'~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_ma_old')),
								       if ( FileServices.FileExists( '~thor_data400::in::prolic_ma_old'), FileServices.Deletelogicalfile('~thor_data400::in::prolic_ma_old')),
                       FileServices.RenameLogicalfile( '~thor_data400::in::prolic_ma','~thor_data400::in::prolic_ma_old'),
										    FileServices.AddSuperfile( '~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_ma_old'),
										            FileServices.FinishSuperfiletransaction(),
                         
											output( outfile,,'~thor_data400::in::prolic_ma',overwrite),
                         FileServices.StartSuperfiletransaction(),
							
												 
												 FileServices.AddSuperfile( '~thor_data400::in::prolic::allsources', '~thor_data400::in::prolic_ma'),
	
											   FileServices.FinishSuperfiletransaction()
											 );

end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
