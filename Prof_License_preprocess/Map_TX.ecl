import Prof_License,ut;

EXPORT Map_TX (dataset({string ftype,string fdate})infile) := module

dRegNurseIn := Files_TX.RN_raw;

Prof_License.Layout_proLic_in map2RNall( dRegNurseIn l) := transform

  self.business_flag      := 'N';
  self.source_st          := 'TX';
  self.profession_or_board         := 'Nurses';
  self.license_type       := if ( trim(Stringlib.Stringfilterout(l.Primary_Practice_Position_Type,'0123456789-')) <> 'UNKNOWN' ,  trim(Stringlib.Stringfilterout(l.Primary_Practice_Position_Type,'0123456789-')) , 'Registered Nurse' );
  self.status             := l.License_Status;
  self.orig_name          := l.Last_Name + ' ' + l.First_Name + ' ' + l.Middle_Name;
  self.name_order         := 'LFM';
  self.vendor             := 'Texas Board of Nurse Examiners';
  self.date_first_seen    := infile(ftype = 'nurses')[1].fdate;
  self.date_last_seen     := infile(ftype = 'nurses')[1].fdate;
  self.license_number     := l.License_Number;
  self.orig_addr_1        := l.Mailing_Address_Line_1;
  self.orig_addr_2        := l.Mailing_Address_Line_2;
  self.orig_addr_3        := l.Mailing_Address_Foreign_Line;
  self.orig_city          := l.Mailing_Address_City;
  self.orig_st            := l.Mailing_Address_State;
  self.orig_zip           := l.Mailing_Address_Zip_code;
  self.dob           := if ( l.Date_of_Birth <> '' and length(l.Date_of_Birth) = 8 , l.Date_of_Birth [5..8] + l.Date_of_Birth[1..4] , '') ;
  self.sex                := l.Gender;
  self.county_str         := l.County_of_Residence;
  self.last_renewal_date  := if(l.Date_of_Last_Renewal <> '' and length(l.Date_of_Last_Renewal) = 8 , l.Date_of_Last_Renewal[5..8] + l.Date_of_Last_Renewal[1..4],'');
  self.education_1_degree := Stringlib.Stringfilterout(l.Highest_Degree,'0123456789-')[1..15];
  self.additional_licensing_specifics := 'Primary Specialty: ' + trim(Stringlib.Stringfilterout(l.Primary_Specialty, '0123456789-'));
  self.education_1_dates_attended := if(l.Graduation_Date_from_Basic_Nursing_ <> '' and length(l.Graduation_Date_from_Basic_Nursing_) = 8 , l.Graduation_Date_from_Basic_Nursing_[5..8] + l.Graduation_Date_from_Basic_Nursing_[1..4], '');
  self.education_1_school_attended := trim(l.Name_of_Basic_Nursing_School)[1..30];
  self.board_action_indicator := l.Current_Board_Action;
  self.issue_date          := if ( l.Texas_License_Issuance_Date <> '' and  length(l.Texas_License_Issuance_Date) = 8 , l.Texas_License_Issuance_Date[5..8] + l.Texas_License_Issuance_Date[1..4] , '' );
  self.status_effective_dt := if (l.License_Status_Date <> '' and length(l.License_Status_Date) = 8 , l.License_Status_Date[5..8] + l.License_Status_Date[1..4] , '');
  self.action_effective_dt := l.Date_of_Board_Action_Imposed;
  self.personal_race_desc  := trim(Stringlib.Stringfilterout(l.Ethnicity,'0123456789-'));
  self.personal_race_cd    := trim(Stringlib.stringfilter(l.Ethnicity,'0123456789'));
	self := [];
	end;
	
dRegNurseOut := project( 	dRegNurseIn, map2RNall(left));
	
dAPRegNurseIn := Files_TX.APRN_raw;

	
	Prof_License.Layout_proLic_in map2APRNall( dAPRegNurseIn l) := transform

	self.business_flag       := 'N';
  self.source_st            := 'TX';
  self.profession_or_board           := 'Nurses';
  self.license_type         := if ( l.APN_Category <> '', l.APN_Category , 'Advanced Practical Nurse');
  self.status               := l.APNStatus;
  self.orig_name            := l.Last_Name + ' ' + l.First_Name + ' ' + l.Middle_Name;
  self.name_order           := 'LFM';
  self.vendor               := 'Texas Board of Nurse Examiners';
  self.date_first_seen      := infile(ftype = 'nurses')[1].fdate;
  self.date_last_seen       := infile(ftype = 'nurses')[1].fdate;
  self.license_number       := l.License_Number;
  self.orig_addr_1          := l.Mailing_Address_Line1;
  self.orig_addr_2          := l.Mailing_Address_Line2;
  self.orig_addr_3          := l.Mailing_Address_Foreign_Line;
  self.orig_city            := l.Mailing_Address_City;
  self.orig_st              := l.Mailing_Address_State;
  self.orig_zip             := l.Mailing_Address_Zipcode;
  self.dob             := if(l.Date_of_Birth <> '' and length(l.Date_of_Birth) = 8 , l.Date_of_Birth[5..8] + l.Date_of_Birth[1..4], '');
  self.sex                  := l.Gender;
  self.expiration_date      := if (l.APNExpiration_Date <> '' and length(l.APNExpiration_Date) = 8 , l.APNExpiration_Date[5..8] + l.APNExpiration_Date[1..4] , '' );
  self.issue_date           := if (l.APNApproval_Date <> ''  and length(l.APNApproval_Date) = 8 , l.APNApproval_Date[5..8] + l.APNApproval_Date[1..4] ,'' );
  self.misc_practice_type   := l.APNSub_Catergory;
  self.county_str            := l.County_of_Residence;
  self.misc_other_id         := l.APNPrescriptive_AuthorizationNumber;
  self.misc_other_id_type     := 'Presc.Auth';
		self := [];

	end;
	
dAPRegNurseOut := project( 	dAPRegNurseIn, map2APRNall(left));

dLVNIn := Files_TX.LVN_raw;

	Prof_License.Layout_proLic_in map2LVNall( dLVNIn l) := transform

self.business_flag             := 'N';
  self.source_st                  := 'TX';
  self.profession_or_board                 := 'Nurses';
  self.license_type               := 'Vocational Nurse';
  self.status                     := l.License_Status;
  self.orig_name                  :=  l.Last_Name + ' ' + l.First_Name + ' ' + l.Middle_Name;
  self.name_order                 := 'LFM';
  self.vendor                     := 'Texas Board of Nurse Examiners';
  self.date_first_seen            := infile(ftype = 'nurses')[1].fdate;
  self.date_last_seen             := infile(ftype = 'nurses')[1].fdate;
  self.license_number             := l.License_Number;
  self.orig_addr_1                := l.Mailing_Address_Line_1;
  self.orig_addr_2                := l.Mailing_Address_Line_2;
  self.orig_addr_3                := l.Mailing_Address_Foreign_Line;
  self.orig_city                  := l.Mailing_Address_City;
  self.orig_st                    := l.Mailing_Address_State;
  self.orig_zip                   := l.Mailing_Address_Zip_code;
  self.dob                   := if ( l.Date_of_Birth <> '' and length(l.Date_of_Birth) = 8 , l.Date_of_Birth[5..8] + l.Date_of_Birth[1..4], '') ;
  self.sex                        := l.Gender;
  self.county_str                 := l.County_of_Residence;
  self.last_renewal_date          := if ( l.Date_of_Last_Renewal <> '' and length(l.Date_of_Last_Renewal) = 8 , l.Date_of_Last_Renewal[5..8] + l.Date_of_Last_Renewal[1..4] , '') ;
  self.education_1_degree         := Stringlib.stringfilterout(l.Highest_Degree,'0123456789-')[1..15];
  self.additional_licensing_specifics :=  'Primary Specialty: ' +  trim(Stringlib.Stringfilterout(l.Primary_Specialty, '0123456789-'));
  self.education_1_dates_attended     := if (l.Graduation_Date_from_Basic_Nursing_ <> '' and length(l.Graduation_Date_from_Basic_Nursing_) = 8 , l.Graduation_Date_from_Basic_Nursing_[5..8]  + l.Graduation_Date_from_Basic_Nursing_[1..4],  '' ) ;
  self.education_1_school_attended    := trim(l.Name_of_Basic_Nursing_School)[1..30];
  self.board_action_indicator         := l.Current_Board_Action;
  self.issue_date                     := if (l.Texas_License_Issuance_Date <> '' and length(l.Texas_License_Issuance_Date)= 8 , l.Texas_License_Issuance_Date[5..8] + l.Texas_License_Issuance_Date[1..4], '');
  self.status_effective_dt           :=  if (l.License_Status_Date <> '' and length(l.License_Status_Date) = 8 , l.License_Status_Date[5..8] + l.License_Status_Date[1..4] ,  '' ) ;
  self.action_effective_dt            := l.Date_of_Board_Action_Imposed;
  self.personal_race_desc             := trim(StringLib.stringfilterout(l.Ethnicity,'0123456789-'));
  self.personal_race_cd               := trim(StringLib.stringfilter(l.Ethnicity,'0123456789'));
		self := [];

end;

dLVNOut := project( 	dLVNIn, map2LVNall(left));

dNurseout := dRegNurseOut + dAPRegNurseOut + dLVNOut;

dNurseSF := Sequential ( FileServices.ClearSuperfile( '~thor_data400::in::prolic::tx::nurse'),
                         Output( dNurseout,,'~thor_data400::in::prolic::tx::nurse'+ut.GetDate,overwrite),
		                                                                                   
													FileServices.AddSuperfile( '~thor_data400::in::prolic::tx::nurse','~thor_data400::in::prolic::tx::nurse'+ut.GetDate)
                        );
//Process Medical License

dPHYIn := Files_TX.phy_raw;

	Prof_License.Layout_proLic_in map2phyall( dPHYIn l) := transform

  self.source_st               := 'TX';                                                                                                                                                                             
  self.vendor                  := 'Texas State Board of Examiners';                                                                                                                                                 
  self.date_first_seen         := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                   
  self.date_last_seen          := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                   
  self.orig_name               :=  l.LAST_NAME + ',' + l.FIRST_NAME;                                                                                                                                                  
  self.name_order              := 'LFM';                                                                                                                                                                            
  self.profession_or_board              := 'Medical';                                                                                                                                                                        
  self.license_number          := l.PHYSICIAN_LICENSE_NUMBER;                                                                                                                                                         
  self.orig_addr_1             := trim(l.MAILING_ADDRESS_LINE_1)[1..80];                                                                                                                                               
  self.orig_addr_2             := trim(l.MAILING_ADDRESS_LINE_2)[1..80];                                                                                                                                               
  self.orig_city               := trim(l.MAILING_ADDRESS_CITY)[1..40];                                                                                                                                                
  self.orig_st                 := trim(l.MAILING_ADDRESS_STATE)[1..2];                                                                                                                                                
  self.orig_zip                := StringLib.Stringfilterout(trim(l.MAILING_ADDRESS_ZIP_CODE),'-')[1..9];                                                                                                               
  self.dob                := l.YEAR_OF_BIRTH;                                                                                                                                                                    
  self.education_1_school_attended := regexreplace(   'MEDICAL' ,                                                                                                                                                   
                                             regexreplace(  'UNIVERSITY'   ,                                                                                                                                        
                                                                                                                                                                                                                    
                                                          l.MEDICAL_SCHOOL,'UNV'),                                                                                                                                   
                                                           'MED')                                                                                                                                                   
                                                                  [1..StringLib.Stringfind(l.MEDICAL_SCHOOL,',',1)-1 ] [1..30];                                                                                        
  self.education_1_dates_attended := l.MEDICAL_SCHOOL_GRAD_YEAR;                                                                                                                                                      
  self.education_1_degree         := l.MEDICAL_SCHOOL_DEGREE;                                                                                                                                                         
  self.issue_date                 :=  map( length(trim(l.LICENSE_ISSUANCE_DATE))= 7 =>                                                                                                                                
                                                                                    trim(l.LICENSE_ISSUANCE_DATE)[4..7] + '0' + trim(l.LICENSE_ISSUANCE_DATE) [1..3] ,                                                  
                                            length(trim(l.LICENSE_ISSUANCE_DATE)) = 8  =>                                                                                                                             
                                                                                     trim(l.LICENSE_ISSUANCE_DATE)[5..8] + trim(l.LICENSE_ISSUANCE_DATE)[1..4] ,trim(l.LICENSE_ISSUANCE_DATE));                           
  self.sex                         := map ( l.GENDER_CODE = 'M' => 'Male',                                                                                                                                           
                                            l.GENDER_CODE ='F' => 'Female','');                                                                                                                                      
  self.personal_race_desc :=             map( trim(l.RACE_CODE)= 'ASN' => 'ASIAN' ,                                                                                                                             
                                              trim(l.RACE_CODE)= 'BLK' => 'BLACK OR AFRICAN AMERICAN' ,                                                                                                         
                                              trim(l.RACE_CODE)= 'HAW' => 'HAWAIIAN OR OTHER PACIFIC ISLANDER',                                                                                                 
                                              trim(l.RACE_CODE) = 'IND' => 'AMERICAN INDIAN OR ALASKA NATIVE' ,                                                                                                 
                                              trim(l.RACE_CODE) = 'OTH' => 'OTHER' ,                                                                                                                            
                                              trim(l.RACE_CODE) ='WHT' => 'WHITE', l.RACE_CODE ) [1..25] ;                                                                                                  
  self.additional_orig_additional_1 := trim(l.PRACTICE_ADDRESS_LINE_1)[1..80];                                                                                                                                         
  self.additional_orig_additional_2 := trim(l.PRACTICE_ADDRESS_LINE_2)[1..80];                                                                                                                                         
  self.additional_orig_city         := l.PRACTICE_ADDRESS_CITY;                                                                                                                                                       
  self.additional_orig_st           := trim(l.PRACTICE_ADDRESS_STATE)[1..2];                                                                                                                                          
  self.additional_orig_zip          := StringLib.Stringfilter(trim(l.PRACTICE_ADDRESS_ZIP_CODE),'0123456789')[1..9];                                                                                                   
  self.personal_pob_desc            :=  l.BIRTHPLACE[1..25];                                                                                                                                                        
  self.status                       := map ( trim(l.REGISTRATION_STATUS_CODE)='AC'=>'ACTIVE',                                                                                                                         
                                            trim(l.REGISTRATION_STATUS_CODE)='ACN'=>'ACTIVE NOT PRACTICING',                                                                                                          
                                            trim(l.REGISTRATION_STATUS_CODE)='BC'=>'BAD CREDIT - PRIOR TO 3/7/2005',                                                                                                  
                                            trim(l.REGISTRATION_STATUS_CODE)='CC'=>'CONSIDERED CANCELED ',                                                                                                            
                                            trim(l.REGISTRATION_STATUS_CODE)='CN'=>'CANCELLED NON PAYMENT',                                                                                                           
                                            trim(l.REGISTRATION_STATUS_CODE)='CNB'=>'CANCELLED NON PAYMENT BY BOARD',                                                                                                 
                                            trim(l.REGISTRATION_STATUS_CODE)='CP'=>'COMPLETE, PENDING REINSTATEMENT',                                                                                                 
                                            trim(l.REGISTRATION_STATUS_CODE)='CR'=>'CANCELLED BY REQUEST',                                                                                                            
                                            trim(l.REGISTRATION_STATUS_CODE)='CRB'=>'CANCELLED BY REQUEST BY BOARD',                                                                                                  
                                            trim(l.REGISTRATION_STATUS_CODE)='CTL'=>'CME TEMPORARY LICENSE',                                                                                                          
                                            trim(l.REGISTRATION_STATUS_CODE)='DC'=>'DECEASED',                                                                                                                        
                                            trim(l.REGISTRATION_STATUS_CODE)='DQ'=>'DELINQUENT-NON PAYMENT',                                                                                                          
                                            trim(l.REGISTRATION_STATUS_CODE)='IA'=>'INACTIVE-PRELIM TO BECOMING CR',                                                                                                  
                                            trim(l.REGISTRATION_STATUS_CODE)='LI'=>'LICENSE ISSUED',                                                                                                                  
                                            trim(l.REGISTRATION_STATUS_CODE)='LD'=>'LOAN DEFAULT',                                                                                                                    
                                            trim(l.REGISTRATION_STATUS_CODE)='NA'=>'NOT ACTIVE',                                                                                                                      
                                            trim(l.REGISTRATION_STATUS_CODE)='NR'=>'NON-STANDARD RETIRED AFFIDAVIT',                                                                                                  
                                            trim(l.REGISTRATION_STATUS_CODE)='PPD'=>'PAYMENT PROCESSING DELAY',                                                                                                       
                                            trim(l.REGISTRATION_STATUS_CODE)='PR'=>'PENDING REINSTATEMENT',                                                                                                           
                                            trim(l.REGISTRATION_STATUS_CODE)='SBA'=>'SUSPENED BY THE BOARD-ACTIVE',                                                                                                   
                                            trim(l.REGISTRATION_STATUS_CODE)='TI'=>'TEXAS LICENSE ISSUED',                                                                                                            
                                            trim(l.REGISTRATION_STATUS_CODE)='TR'=>'TEXAS RETIRED',                                                                                                                   
                                            trim(l.REGISTRATION_STATUS_CODE)='VC'=>'VOLUNTARY CHARITY CARE ONLY', '' ) ;                                                                                              
                                                                                                                                                                                                                    
  self.status_effective_dt := map ( length(trim(l.REGISTRATION_STATUS_DATE))=7 =>                                                                                                                                     
                                 trim(l.REGISTRATION_STATUS_DATE)[4..7] + '0' + trim(l.REGISTRATION_STATUS_DATE)[1..3] ,                                                                                                
                              length(trim(l.REGISTRATION_STATUS_DATE))=8=>                                                                                                                                            
                                 trim(l.REGISTRATION_STATUS_DATE)[5..8] + trim(l.REGISTRATION_STATUS_DATE)[1..4], trim(l.REGISTRATION_STATUS_DATE));                                                                      
  self.license_type := 'Physician:' + trim(l.PRIMARY_SPECIALTY_CODE)[1..60];                                                                                                                                         
  self.additional_name_addr_type := 'Practice';                                                                                                                                                                     
  self.additional_licensing_specifics := l.SECONDARY_SPECIALTY_CODE;                                                                                                                                                 
  self.misc_practice_type := map ( l.PRACTICE_TYPE_CODE='1'=>' DIRECT PATIENT CARE',                                                                                                                                 
                                   l.PRACTICE_TYPE_CODE='2'=>' MEDICAL TEACHING',                                                                                                                                    
                                   l.PRACTICE_TYPE_CODE='3'=>' ADMINISTRATIVE MEDICINE',                                                                                                                             
                                   l.PRACTICE_TYPE_CODE='4'=>' RESEARCH',                                                                                                                                            
                                   l.PRACTICE_TYPE_CODE='5'=>' NOT IN PRACTICE',                                                                                                                                     
                                   l.PRACTICE_TYPE_CODE='6'=>' RESIDENT, FELLOW',                                                                                                                                    
                                   l.PRACTICE_TYPE_CODE='0'=> 'DID NOT ANSWER', l.PRACTICE_TYPE_CODE ) ;                                                                                                              
  self.misc_practice_hours := map ( l.PRACTICE_TIME_CODE='1'=>'40+ HOURS PER WEEK',                                                                                                                                 
                                    l.PRACTICE_TIME_CODE='2'=>'20-39 HOURS PER WEEK',                                                                                                                               
                                    l.PRACTICE_TIME_CODE='3'=>'11-19 HOURS PER WEEK',                                                                                                                               
                                    l.PRACTICE_TIME_CODE='4'=>'1-10 HOURS PER WEEK',                                                                                                                                
                                    l.PRACTICE_TIME_CODE='0'=> 'DID NOT ANSWER',                                                                                                                                    
                                    l.PRACTICE_TIME_CODE='5'=> 'NOT APPLICABLE',l.PRACTICE_TIME_CODE ) ;                                                                                                            
  self.expiration_date :=  map ( length(trim(l.LICENSE_EXPIRATION_DATE))=7 =>                                                                                                                                        
                                    trim(l.LICENSE_EXPIRATION_DATE)[4..7 ] + '0' + trim(l.LICENSE_EXPIRATION_DATE)[1..3] ,                                                                                            
                           length(trim(l.LICENSE_EXPIRATION_DATE)) =8 =>                                                                                                                                             
                                     trim(l.LICENSE_EXPIRATION_DATE)[5..8] + trim(l.LICENSE_EXPIRATION_DATE)[1..4] , trim(l.LICENSE_EXPIRATION_DATE) ) ;                                                               
  self.license_obtained_by := map ( l.METHOD_OF_LICENSURE_CODE='E' => 'EXAM' ,                                                                                                                                          
                                     l.METHOD_OF_LICENSURE_CODE='R' =>'RECIPROCITY' ,                                                                                                                                   
                                     l.METHOD_OF_LICENSURE_CODE='L' => 'LICENSURE', '' ) ; 
  self := [];

end;                                                                                                                                                                                                                


dPHYout := project ( dPHYIn , map2phyall(left));


dPasIn := Files_TX.pas_raw;

	Prof_License.Layout_proLic_in map2pasall( dPasIn l) := transform

self.source_st                   := 'TX';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
self.vendor                      := 'Texas State Board of Examiners';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
self.date_first_seen             := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.date_last_seen              := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.orig_name                   := l.LAST_NAME + ',' + l.FIRST_NAME;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.name_order                  := 'LFM';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.profession_or_board                  := 'Medical';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.license_number              := l.TEXAS_PA_LICENSE_NUMBER;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
self.orig_addr_1                 := l.MAILING_ADDRESS_LINE_1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.orig_addr_2                 := l.MAILING_ADDRESS_LINE_2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.orig_city                   := l.MAILING_ADDRESS_CITY;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
self.orig_st                     := trim(l.MAILING_ADDRESS_STATE)[1..2];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
self.orig_zip                    := StringLib.Stringfilterout(trim(l.MAILING_ADDRESS_ZIP_CODE),'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
self.dob                         := l.YEAR_OF_BIRTH;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
self.education_1_dates_attended := l.PA_PROGRAM_GRADUATION_YEAR;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.sex                        := map ( l.GENDER_CODE ='M'=>'Male',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                         l.GENDER_CODE ='F'=>'Female','');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
self.personal_race_desc          := map (l.RACE_CODE ='1'=>'WHITE',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                            l.RACE_CODE ='2'=>'BLACK',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                            l.RACE_CODE ='3'=>'HISPANIC',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                            l.RACE_CODE ='4'=>'ASIAN OR PACIFIC ISLANDER',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                            l.RACE_CODE ='5'=>'AMERICAN INDIAN OR ALASKAN NATIVE',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                            l.RACE_CODE)[1..25];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
self.issue_date                := map ( length(trim(l.PA_LICENSE_ISSUANCE_DATE))= 7 =>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                         trim(l.PA_LICENSE_ISSUANCE_DATE)[4..7] + '0' + trim(l.PA_LICENSE_ISSUANCE_DATE)[1..3] ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                        length(trim(l.PA_LICENSE_ISSUANCE_DATE)) = 8 =>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                          trim(l.PA_LICENSE_ISSUANCE_DATE)[5..8] + trim(l.PA_LICENSE_ISSUANCE_DATE)[1..4] , trim(l.PA_LICENSE_ISSUANCE_DATE));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.expiration_date          :=  map  (length(trim(l.PA_LICENSE_EXPIRATION_DATE)) = 7=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                            trim(l.PA_LICENSE_EXPIRATION_DATE)[4..7] + '0' + trim(l.PA_LICENSE_EXPIRATION_DATE)[1..3] ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                        length(trim(l.PA_LICENSE_EXPIRATION_DATE)) = 8 =>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                            trim(l.PA_LICENSE_EXPIRATION_DATE)[5..8] + trim(l.PA_LICENSE_EXPIRATION_DATE)[1..4] ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                         trim(l.PA_LICENSE_EXPIRATION_DATE) );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
self.personal_pob_desc        := l.BIRTHPLACE[1..25];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
self.status                   := map ( trim(l.PA_REGISTRATION_STATUS_CODE) ='AC'=>'Active',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                         trim(l.PA_REGISTRATION_STATUS_CODE)='BC'=>'Bad Credit',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                         trim(l.PA_REGISTRATION_STATUS_CODE)='LI'=>'License Issued',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                         trim(l.PA_REGISTRATION_STATUS_CODE) ='IA'=>'Inactive',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                         trim(l.PA_REGISTRATION_STATUS_CODE) ='TI'=>'Texad Issued','');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
self.additional_orig_additional_1 := l.PRACTICE_ADDRESS_LINE_1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
self.additional_orig_additional_2 := l.PRACTICE_ADDRESS_LINE_2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
self.additional_orig_city := l.PRACTICE_ADDRESS_CITY;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.additional_orig_st :=  trim(l.PRACTICE_ADDRESS_STATE)[1..2];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.additional_orig_zip := StringLib.Stringfilterout(trim(l.PRACTICE_ADDRESS_ZIP_CODE),'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.education_1_school_attended := regexreplace(    'MEDICAL',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                           regexreplace(  'UNIVERSITY' ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                        l.PA_PROGRAM,'UNV'),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                         'MED')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                         [1..StringLib.Stringfind(l.PA_PROGRAM,',',1)-1 ] [1..30];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
self.status_effective_dt := MAP( length(trim(l.PA_REGISTRATION_STATUS_DATE))= 7=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                   trim(l.PA_REGISTRATION_STATUS_DATE)[4..7] + '0' + trim(l.PA_REGISTRATION_STATUS_DATE)[1..3] ,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                            length(trim(l.PA_REGISTRATION_STATUS_DATE))= 8 =>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                   trim(l.PA_REGISTRATION_STATUS_DATE)[5..8] + trim(l.PA_REGISTRATION_STATUS_DATE)[1..4] , trim(l.PA_REGISTRATION_STATUS_DATE) );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
self.license_type       := 'Physician Assistant';   

	self := [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 end;
 
 
 dPASout := project ( dPasIn , map2pasall(left));
 
 dActIn := Files_TX.acpt_raw;

	Prof_License.Layout_proLic_in map2actall( dActIn l) := transform                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
 self.source_st                                    := 'TX';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.vendor                                       := 'Texas State Board of Examiners';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
self.date_first_seen                              := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.date_last_seen                               := infile(ftype = 'medical')[1].fdate;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.orig_name                                    := l.LASTNAME + ',' + l.FIRSTNAME;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.name_order                                   := 'LFM';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.profession_or_board                                   := 'Medical';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.license_number                               := l.ACUPUNCTURELICENSENUMBER;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
self.orig_addr_1                                  := l.MAILINGADDRESSLINE1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.orig_addr_2                                  := l.MAILINGADDRESSLINE2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.orig_city                                    := l.MAILINGADDRESSCITY;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.orig_st                                      := l.MAILINGADDRESSSTATE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
self.orig_zip                                     := StringLib.stringfilterout(trim(l.MAILINGADDRESSZIPCODE),'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.dob                                     := l.YEAROFBIRTH;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
self.education_1_dates_attended                   := l.ACSCHOOLGRADUATIONYEAR;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
self.sex                                          := map ( l.GENDERCODE ='M'=> 'Male',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                           l.GENDERCODE ='F'=> 'Female','') ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
self.personal_race_desc                           := map (l.RACECODE ='1'=> 'WHITE',                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                        l.RACECODE ='2'=> 'BLACK',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                        l.RACECODE ='3'=> 'HISPANIC',                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                        l.RACECODE ='4'=> 'ASIAN OR PACIFIC ISLANDER',                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                        l.RACECODE ='5'=> 'AMERICAN INDIAN OR ALASKAN NATIVE',                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                        l.RACECODE)[1..25];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
self.education_1_school_attended                  := regexreplace(  'MEDICAL',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                             regexreplace(   'UNIVERSITY',                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                         l.ACUPUNCTURESCHOOLCODE,'UNV'),                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                    'MED')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                          [1..StringLib.StringFind(l.ACUPUNCTURESCHOOLCODE,',',1)-1 ] [1..30];                                                                                                                                                                                                                                                                                                                                                                                                                           
self.issue_date                                    := map( length(trim(l.ACLICENSEISSUANCEDT))= 7=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                           trim(l.ACLICENSEISSUANCEDT)[4..7] + '0' + trim(l.ACLICENSEISSUANCEDT)[1..3],                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                           length(trim(l.ACLICENSEISSUANCEDT)) = 8=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                           trim(l.ACLICENSEISSUANCEDT)[5..8] + trim(l.ACLICENSEISSUANCEDT)[1..4] , trim(l.ACLICENSEISSUANCEDT));                                                                                                                                                                                                                                                                                                                                                                                                       
self.expiration_date                                :=  map ( length(trim(l.ACLICENSEEXPIRATIONDATE))= 7=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                             trim(l.ACLICENSEEXPIRATIONDATE)[4..7] + '0' + trim(l.ACLICENSEEXPIRATIONDATE)[1..3] ,                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                             length(trim(l.ACLICENSEEXPIRATIONDATE)) = 8=>                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                             trim(l.ACLICENSEEXPIRATIONDATE)[5..8] + trim(l.ACLICENSEEXPIRATIONDATE)[1..4], trim(l.ACLICENSEEXPIRATIONDATE));                                                                                                                                                                                                                                                                                                                                                                                          
self.personal_pob_desc                             := l.BIRTHPLACE[1..25];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.status                                         := map( trim(l.ACREGISTRATIONSTATUSCODE)= 'AC'=> 'Active',                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                           trim(l.ACREGISTRATIONSTATUSCODE) = 'BC'=> 'Bad Credit',                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                           trim(l.ACREGISTRATIONSTATUSCODE) = 'LI'=> 'License Issued','');                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.additional_orig_additional_1                  := l.PRACTICEADDRESSLINE1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
self.additional_orig_additional_2                  := l.PRACTICEADDRESSLINE2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
self.additional_orig_city                          := l.PRACTICEADDRESSCITY;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
self.additional_orig_st                            :=  trim(l.PRACTICEADDRESSSTATE)[1..2];                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
self.additional_orig_zip                           := Stringlib.stringfilterout(trim(l.PRACTICEADDRESSZIPCODE),'-');                                                                                                                                                                                                                                                                                                                                                                                                                                                   
self.status_effective_dt                           := map( length(trim(l.ACREGISTRATIONSTATUSDATE)) = 7=>                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                           trim(l.ACREGISTRATIONSTATUSDATE)[4..7] + '0' + trim(l.ACREGISTRATIONSTATUSDATE)[1..3],                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                      length(trim(l.ACREGISTRATIONSTATUSDATE)) =8 =>                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                           trim(l.ACREGISTRATIONSTATUSDATE)[5..8] + trim(l.ACREGISTRATIONSTATUSDATE)[1..4], trim(l.ACREGISTRATIONSTATUSDATE));                                                                                                                                                                                                                                                                                                                                                                                         
self.additional_name_addr_type                     := 'Practice';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
self.license_type                                   := 'Acupuncturist';   
	self := [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 end;
 
 
 dACTout := project ( dACTIn , map2actall(left));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
 dMedicalout :=    dPHYout + dPASout + dACTout  ;
 
dMedicalSF := Sequential(   
                            FileServices.ClearSuperfile( '~thor_data400::in::prolic::tx::medical'),

                             Output( dMedicalout,,'~thor_data400::in::prolic::tx::medical'+ut.GetDate,overwrite),
														FileServices.AddSuperfile( '~thor_data400::in::prolic::tx::medical','~thor_data400::in::prolic::tx::medical'+ut.GetDate)
															 ) ; 
 
 
 doutfinal := map ( count(infile(ftype = 'nurses')) = 1 and count(infile) = 1 => dNurseout, 
               count(infile(ftype = 'medical')) = 1 and count(infile) = 1  => dMedicalout,
								  dNurseout + dMedicalout );

 
 
dout :=  map ( count(infile(ftype = 'nurses')) = 1 and count(infile) = 1 => dNurseSF,
												                                                        
								        	count(infile(ftype = 'medical')) = 1	and count(infile) = 1 =>	   dMedicalSF,
													Sequential( dNurseSF,dMedicalSF)
							);

															 
outfile := proc_clean_all(doutfinal,'TX').cleanout;

export buildprep := Sequential(dout, 
                        FileServices.RemoveSuperFile('~thor_data400::in::prolic::allsources', '~thor_data400::in::prolic_tx'),
                if ( FileServices.FindSuperfilesubname(  '~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_tx_old') <> 0,      FileServices.RemoveSuperFile(	'~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_tx_old')),
								       if ( FileServices.FileExists( '~thor_data400::in::prolic_tx_old'), FileServices.Deletelogicalfile('~thor_data400::in::prolic_tx_old')),
                   					   FileServices.RenameLogicalfile( '~thor_data400::in::prolic_tx','~thor_data400::in::prolic_tx_old'),

                         
											output( outfile,,'~thor_data400::in::prolic_tx',compressed,overwrite),
                         FileServices.StartSuperfiletransaction(),
						
												 
												 FileServices.AddSuperfile( '~thor_data400::in::prolic::allsources', '~thor_data400::in::prolic_tx'),
	 										    FileServices.AddSuperfile( '~thor_data400::in::prolic::allsources::old','~thor_data400::in::prolic_tx_old'),  

	
											   FileServices.FinishSuperfiletransaction()
											 );

end;                                                                                                                             
		
		



                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
