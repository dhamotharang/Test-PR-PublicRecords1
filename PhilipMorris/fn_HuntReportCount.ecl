
import header, business_header, address, _control;

export fn_HuntReportCount(SET OF STRING SetValidValues) := FUNCTION 

hunt_layout := RECORD
  unsigned6 did;
  unsigned2 did_score;
  unsigned4 append_seqnum;
  string8 process_date;
  string8 date_first_seen;
  string8 date_last_seen;
  string3 score;
  string9 best_ssn;
  string12 did_out;
  string7 source;
  string4 file_id;
  string13 vendor_id;
  string2 source_state;
  string2 source_code;
  string8 file_acquired_date;
  string2 _use;
  string10 title_in;
  string30 lname_in;
  string30 fname_in;
  string30 mname_in;
  string30 maiden_prior;
  string3 name_suffix_in;
  string15 votefiller;
  string12 source_voterid;
  string8 dob_str_in;
  string2 agecat;
  string2 headhousehold;
  string18 place_of_birth;
  string30 occupation;
  string30 maiden_name;
  string15 motorvoterid;
  string10 regsource;
  string8 regdate_in;
  string2 race;
  string1 gender;
  string2 poliparty;
  string10 phone;
  string10 work_phone;
  string10 other_phone;
  string1 active_status;
  string1 votefiller2;
  string1 active_other;
  string2 voterstatus;
  string40 resaddr1;
  string40 resaddr2;
  string40 res_city;
  string2 res_state;
  string9 res_zip;
  string3 res_county;
  string40 mail_addr1;
  string40 mail_addr2;
  string40 mail_city;
  string2 mail_state;
  string9 mail_zip;
  string3 mail_county;
  string40 addr_filler1;
  string40 addr_filler2;
  string40 city_filler;
  string2 state_filler;
  string9 zip_filler;
  string3 county_filler;
  string5 towncode;
  string5 distcode;
  string5 countycode;
  string5 schoolcode;
  string1 cityinout;
  string20 spec_dist1;
  string20 spec_dist2;
  string7 precinct1;
  string7 precinct2;
  string7 precinct3;
  string7 villageprecinct;
  string7 schoolprecinct;
  string7 ward;
  string7 precinct_citytown;
  string7 ancsmdindc;
  string4 citycouncildist;
  string4 countycommdist;
  string3 statehouse;
  string3 statesenate;
  string3 ushouse;
  string4 elemschooldist;
  string4 schooldist;
  string5 schoolfiller;
  string4 commcolldist;
  string5 dist_filler;
  string4 municipal;
  string4 villagedist;
  string4 policejury;
  string4 policedist;
  string4 publicservcomm;
  string4 rescue;
  string4 fire;
  string4 sanitary;
  string4 sewerdist;
  string4 waterdist;
  string4 mosquitodist;
  string4 taxdist;
  string4 supremecourt;
  string4 justiceofpeace;
  string4 judicialdist;
  string4 superiorctdist;
  string4 appealsct;
  string4 courtfiller;
  string2 contributorparty;
  string2 recptparty;
  string8 dateofcontr_in;
  string7 dollaramt;
  string3 officecontto;
  string7 cumuldollaramt;
  string21 contfiller1;
  string21 contfiller2;
  string5 conttype;
  string15 contfiller3;
  string2 primary02;
  string2 special02;
  string2 other02;
  string2 special202;
  string2 general02;
  string2 primary01;
  string2 special01;
  string2 other01;
  string2 special201;
  string2 general01;
  string2 pres00;
  string2 primary00;
  string2 special00;
  string2 other00;
  string2 special200;
  string2 general00;
  string2 primary99;
  string2 special99;
  string2 other99;
  string2 special299;
  string2 general99;
  string2 primary98;
  string2 special98;
  string2 other98;
  string2 special298;
  string2 general98;
  string2 primary97;
  string2 special97;
  string2 other97;
  string2 special297;
  string2 general97;
  string2 pres96;
  string2 primary96;
  string2 special96;
  string2 other96;
  string2 special296;
  string2 general96;
  string8 lastdayvote_in;
  string10 historyfiller;
  string15 huntfishperm;
  string8 datelicense_in;
  string2 homestate;
  string1 resident;
  string1 nonresident;
  string1 hunt;
  string1 fish;
  string1 combosuper;
  string1 sportsman;
  string1 trap;
  string1 archery;
  string1 muzzle;
  string1 drawing;
  string1 day1;
  string1 day3;
  string1 day7;
  string1 day14to15;
  string1 dayfiller;
  string1 seasonannual;
  string1 lifetimepermit;
  string1 landowner;
  string1 family;
  string1 junior;
  string1 seniorcit;
  string1 crewmemeber;
  string1 retarded;
  string1 indian;
  string1 serviceman;
  string1 disabled;
  string1 lowincome;
  string3 regioncounty;
  string1 blind;
  string47 huntfiller;
  string1 salmon;
  string1 freshwater;
  string1 saltwater;
  string1 lakesandresevoirs;
  string1 setlinefish;
  string1 trout;
  string1 fallfishing;
  string1 steelhead;
  string1 whitejubherring;
  string1 sturgeon;
  string1 shellfishcrab;
  string1 shellfishlobster;
  string1 deer;
  string1 bear;
  string1 elk;
  string1 moose;
  string1 buffalo;
  string1 antelope;
  string1 sikebull;
  string1 bighorn;
  string1 javelina;
  string1 cougar;
  string1 anterless;
  string1 pheasant;
  string1 goose;
  string1 duck;
  string1 turkey;
  string1 snowmobile;
  string1 biggame;
  string1 skipass;
  string1 migbird;
  string1 smallgame;
  string1 sturgeon2;
  string1 gun;
  string1 bonus;
  string1 lottery;
  string1 otherbirds;
  string83 huntfill1;
  string10 boatindexnum;
  string1 boatcoowner;
  string20 hullidnum;
  string4 yearmade;
  string20 model;
  string20 manufacturer;
  string3 lengt;
  string2 hullconstruct;
  string2 primuse;
  string2 fueltype;
  string2 propulsion;
  string2 modeltype;
  string8 regexpdate_in;
  string10 titlenum;
  string2 stprimuse;
  string3 titlestatus;
  string2 vessel;
  string15 specreg;
  string15 boatfill1;
  string5 boatfill2;
  string15 boatfill3;
  string15 ccwpermnum;
  string15 ccwweapontype;
  string8 ccwregdate_in;
  string8 ccwexpdate_in;
  string46 ccwpermtype;
  string10 ccwfill1;
  string20 ccwfill2;
  string15 ccwfill3;
  string15 ccwfill4;
  string15 miscfill1;
  string15 miscfill2;
  string15 miscfill3;
  string15 miscfill4;
  string15 miscfill5;
  string19 fillerother1;
  string40 fillerother2;
  string10 fillerother3;
  string10 fillerother4;
  string10 fillerother5;
  string11 fillerother6;
  string11 fillerother7;
  string11 fillerother8;
  string11 fillerother9;
  string11 fillerother10;
  string2 eor;
  string2 stuff;
  string8 dob_str;
  string8 regdate;
  string8 dateofcontr;
  string8 lastdayvote;
  string8 datelicense;
  string8 regexpdate;
  string8 ccwregdate;
  string8 ccwexpdate;
  string5 title;
  string20 fname;
  string20 mname;
  string20 lname;
  string5 name_suffix;
  string3 score_on_input;
  string100 append_prep_resaddress1;
  string50 append_prep_resaddress2;
  unsigned8 append_resrawaid;
  string100 append_prep_mailaddress1;
  string50 append_prep_mailaddress2;
  unsigned8 append_mailrawaid;
  string100 append_prep_cassaddress1;
  string50 append_prep_cassaddress2;
  unsigned8 append_cassrawaid;
  string10 aid_resclean_prim_range;
  string2 aid_resclean_predir;
  string28 aid_resclean_prim_name;
  string4 aid_resclean_addr_suffix;
  string2 aid_resclean_postdir;
  string10 aid_resclean_unit_desig;
  string8 aid_resclean_sec_range;
  string25 aid_resclean_p_city_name;
  string25 aid_resclean_v_city_name;
  string2 aid_resclean_st;
  string5 aid_resclean_zip;
  string4 aid_resclean_zip4;
  string4 aid_resclean_cart;
  string1 aid_resclean_cr_sort_sz;
  string4 aid_resclean_lot;
  string1 aid_resclean_lot_order;
  string2 aid_resclean_dpbc;
  string1 aid_resclean_chk_digit;
  string2 aid_resclean_record_type;
  string2 aid_resclean_ace_fips_st;
  string3 aid_resclean_fipscounty;
  string10 aid_resclean_geo_lat;
  string11 aid_resclean_geo_long;
  string4 aid_resclean_msa;
  string7 aid_resclean_geo_blk;
  string1 aid_resclean_geo_match;
  string4 aid_resclean_err_stat;
  string10 aid_mailclean_prim_range;
  string2 aid_mailclean_predir;
  string28 aid_mailclean_prim_name;
  string4 aid_mailclean_addr_suffix;
  string2 aid_mailclean_postdir;
  string10 aid_mailclean_unit_desig;
  string8 aid_mailclean_sec_range;
  string25 aid_mailclean_p_city_name;
  string25 aid_mailclean_v_city_name;
  string2 aid_mailclean_st;
  string5 aid_mailclean_zip;
  string4 aid_mailclean_zip4;
  string4 aid_mailclean_cart;
  string1 aid_mailclean_cr_sort_sz;
  string4 aid_mailclean_lot;
  string1 aid_mailclean_lot_order;
  string2 aid_mailclean_dpbc;
  string1 aid_mailclean_chk_digit;
  string2 aid_mailclean_record_type;
  string2 aid_mailclean_ace_fips_st;
  string3 aid_mailclean_fipscounty;
  string10 aid_mailclean_geo_lat;
  string11 aid_mailclean_geo_long;
  string4 aid_mailclean_msa;
  string7 aid_mailclean_geo_blk;
  string1 aid_mailclean_geo_match;
  string4 aid_mailclean_err_stat;
  string10 prim_range;
  string2 predir;
  string28 prim_name;
  string4 suffix;
  string2 postdir;
  string10 unit_desig;
  string8 sec_range;
  string25 p_city_name;
  string25 city_name;
  string2 st;
  string5 zip;
  string4 zip4;
  string4 cart;
  string1 cr_sort_sz;
  string4 lot;
  string1 lot_order;
  string2 dpbc;
  string1 chk_digit;
  string2 record_type;
  string2 ace_fips_st;
  string3 county;
  string10 geo_lat;
  string11 geo_long;
  string4 msa;
  string7 geo_blk;
  string1 geo_match;
  string4 err_stat;
  string10 mail_prim_range;
  string2 mail_predir;
  string28 mail_prim_name;
  string4 mail_addr_suffix;
  string2 mail_postdir;
  string10 mail_unit_desig;
  string8 mail_sec_range;
  string25 mail_p_city_name;
  string25 mail_v_city_name;
  string2 mail_st;
  string5 mail_ace_zip;
  string4 mail_zip4;
  string4 mail_cart;
  string1 mail_cr_sort_sz;
  string4 mail_lot;
  string1 mail_lot_order;
  string2 mail_dpbc;
  string1 mail_chk_digit;
  string2 mail_record_type;
  string2 mail_ace_fips_st;
  string3 mail_fipscounty;
  string10 mail_geo_lat;
  string11 mail_geo_long;
  string4 mail_msa;
  string7 mail_geo_blk;
  string1 mail_geo_match;
  string4 mail_err_stat;
  string10 cass_prim_range;
  string2 cass_predir;
  string28 cass_prim_name;
  string4 cass_addr_suffix;
  string2 cass_postdir;
  string10 cass_unit_desig;
  string8 cass_sec_range;
  string25 cass_p_city_name;
  string25 cass_v_city_name;
  string2 cass_st;
  string5 cass_ace_zip;
  string4 cass_zip4;
  string4 cass_cart;
  string1 cass_cr_sort_sz;
  string4 cass_lot;
  string1 cass_lot_order;
  string2 cass_dpbc;
  string1 cass_chk_digit;
  string2 cass_record_type;
  string2 cass_ace_fips_st;
  string3 cass_fipscounty;
  string10 cass_geo_lat;
  string11 cass_geo_long;
  string4 cass_msa;
  string7 cass_geo_blk;
  string1 cass_geo_match;
  string4 cass_err_stat;
  string1 addressind;
  unsigned8 append_rawaid;
  string100 append_prep_address1;
  string50 append_prep_address2;
  string10 aid_aceclean_prim_range;
  string2 aid_aceclean_predir;
  string28 aid_aceclean_prim_name;
  string4 aid_aceclean_addr_suffix;
  string2 aid_aceclean_postdir;
  string10 aid_aceclean_unit_desig;
  string8 aid_aceclean_sec_range;
  string25 aid_aceclean_p_city_name;
  string25 aid_aceclean_v_city_name;
  string2 aid_aceclean_st;
  string5 aid_aceclean_zip;
  string4 aid_aceclean_zip4;
  string4 aid_aceclean_cart;
  string1 aid_aceclean_cr_sort_sz;
  string4 aid_aceclean_lot;
  string1 aid_aceclean_lot_order;
  string2 aid_aceclean_dbpc;
  string1 aid_aceclean_chk_digit;
  string2 aid_aceclean_record_type;
  string2 aid_aceclean_ace_fips_st;
  string3 aid_aceclean_fipscounty;
  string10 aid_aceclean_geo_lat;
  string11 aid_aceclean_geo_long;
  string4 aid_aceclean_msa;
  string7 aid_aceclean_geo_blk;
  string1 aid_aceclean_geo_match;
  string4 aid_aceclean_err_stat;
 END;

//******************************   VALID States    ***************************//
r := {STRING2 state, unsigned cnt};
SetValidStates := DATASET([{'AK',0},{'AL',0},{'AR',0},{'AZ',0},{'CA',0},{'CO',0},{'CT',0},{'DC',0},{'DE',0},{'FL',0},{'GA',0},{'HI',0},{'IA',0},
				   {'ID',0},{'IL',0},{'IN',0},{'KS',0},{'KY',0},{'LA',0},{'MA',0},{'MD',0},{'ME',0},{'MI',0},{'MN',0},{'MO',0},{'MS',0},{'MT',0},
				   {'NC',0},{'ND',0},{'NE',0},{'NH',0},{'NJ',0},{'NM',0},{'NV',0},{'NY',0},{'OH',0},{'OK',0},{'OR',0},{'PA',0},{'RI',0},{'SC',0},
				   {'SD',0},{'TN',0},{'TX',0},{'UT',0},{'VA',0},{'VT',0},{'WA',0},{'WI',0},{'WV',0},{'WY',0}],r);

AllStates := SET(SetValidStates(),state);

Header_source := dataset('~thor_data400::persist::emerges::hunt_ccw_did',hunt_layout,flat);
IsValidState := Header_source.homestate IN AllStates;
ValRecsState := Header_source(IsValidState);
					  
IsValidRec := ValRecsState.file_id IN SetValidValues;
ValRecs := ValRecsState(IsValidRec);

rec_StateCount := record
	string2 state;
	string src;
	unsigned cnt := 1;
end;

rec_StateCount xfm(recordof(ValRecs) L) := transform
	self.state := L.homestate;
	self.src := L.file_id;
	self.cnt := 1;
end;

f_StateCount := project(ValRecs, xfm(left));


f_srt := sort(DISTRIBUTE(f_StateCount,hash32(src)),src,local);

rec_StateCount xfm_cnt(rec_StateCount L, rec_StateCount R) := transform
	self.state := L.state;
	self.src := L.src;
	self.cnt := L.cnt + 1;
end;

f_rlp := rollup(f_srt, 
				left.src = right.src, 
				xfm_cnt(left, right));

r doHalfJoin(r L,rec_StateCount R) := TRANSFORM
self.state := if(R.cnt <> 0, R.state,L.state);
self.cnt := if(R.cnt <> 0, R.cnt,L.cnt);
SELF := L;
END;

f_return := JOIN(SetValidStates,f_rlp, 
LEFT.state=RIGHT.state,doHalfJoin(LEFT,RIGHT),full outer);


 RETURN f_return;
END;