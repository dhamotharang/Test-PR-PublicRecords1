export Delta := MODULE//Routines to compute the differences between two instances of a file
export Differences(dataset(layout_as_bh)old_s, dataset(layout_as_bh) new_s) := function
  Diff_Layout := RECORD(layout_as_bh)
    boolean  Added;
    boolean Deleted;
  END;
  Diff_Layout Take_Record(old_s le, new_s ri) := transform
    boolean left_null := le.rcid=(typeof(le.rcid))'' AND le.bdid=(typeof(le.bdid))'' AND le.source=(typeof(le.source))'' AND le.source_group=(typeof(le.source_group))'' AND le.pflag=(typeof(le.pflag))'' AND le.group1_id=(typeof(le.group1_id))'' AND le.vendor_id=(typeof(le.vendor_id))'' AND le.dt_first_seen=(typeof(le.dt_first_seen))'' AND le.dt_last_seen=(typeof(le.dt_last_seen))'' AND le.dt_vendor_first_reported=(typeof(le.dt_vendor_first_reported))'' AND le.dt_vendor_last_reported=(typeof(le.dt_vendor_last_reported))'' AND le.company_name=(typeof(le.company_name))'' AND le.prim_range=(typeof(le.prim_range))'' AND le.predir=(typeof(le.predir))'' AND le.prim_name=(typeof(le.prim_name))'' AND le.addr_suffix=(typeof(le.addr_suffix))'' AND le.postdir=(typeof(le.postdir))'' AND le.unit_desig=(typeof(le.unit_desig))'' AND le.sec_range=(typeof(le.sec_range))'' AND le.city=(typeof(le.city))'' AND le.state=(typeof(le.state))'' AND le.zip=(typeof(le.zip))'' AND le.zip4=(typeof(le.zip4))'' AND le.county=(typeof(le.county))'' AND le.msa=(typeof(le.msa))'' AND le.geo_lat=(typeof(le.geo_lat))'' AND le.geo_long=(typeof(le.geo_long))'' AND le.phone=(typeof(le.phone))'' AND le.phone_score=(typeof(le.phone_score))'' AND le.fein=(typeof(le.fein))'' AND le.current=(typeof(le.current))'' AND le.dppa=(typeof(le.dppa))'' AND le.vl_id=(typeof(le.vl_id))'' AND le.RawAID=(typeof(le.RawAID))'';
    boolean right_null := ri.rcid=(typeof(ri.rcid))'' AND ri.bdid=(typeof(ri.bdid))'' AND ri.source=(typeof(ri.source))'' AND ri.source_group=(typeof(ri.source_group))'' AND ri.pflag=(typeof(ri.pflag))'' AND ri.group1_id=(typeof(ri.group1_id))'' AND ri.vendor_id=(typeof(ri.vendor_id))'' AND ri.dt_first_seen=(typeof(ri.dt_first_seen))'' AND ri.dt_last_seen=(typeof(ri.dt_last_seen))'' AND ri.dt_vendor_first_reported=(typeof(ri.dt_vendor_first_reported))'' AND ri.dt_vendor_last_reported=(typeof(ri.dt_vendor_last_reported))'' AND ri.company_name=(typeof(ri.company_name))'' AND ri.prim_range=(typeof(ri.prim_range))'' AND ri.predir=(typeof(ri.predir))'' AND ri.prim_name=(typeof(ri.prim_name))'' AND ri.addr_suffix=(typeof(ri.addr_suffix))'' AND ri.postdir=(typeof(ri.postdir))'' AND ri.unit_desig=(typeof(ri.unit_desig))'' AND ri.sec_range=(typeof(ri.sec_range))'' AND ri.city=(typeof(ri.city))'' AND ri.state=(typeof(ri.state))'' AND ri.zip=(typeof(ri.zip))'' AND ri.zip4=(typeof(ri.zip4))'' AND ri.county=(typeof(ri.county))'' AND ri.msa=(typeof(ri.msa))'' AND ri.geo_lat=(typeof(ri.geo_lat))'' AND ri.geo_long=(typeof(ri.geo_long))'' AND ri.phone=(typeof(ri.phone))'' AND ri.phone_score=(typeof(ri.phone_score))'' AND ri.fein=(typeof(ri.fein))'' AND ri.current=(typeof(ri.current))'' AND ri.dppa=(typeof(ri.dppa))'' AND ri.vl_id=(typeof(ri.vl_id))'' AND ri.RawAID=(typeof(ri.RawAID))'';
    self.Added := left_null;
    self.Deleted := right_null;
    self := if ( right_null, le, ri );
  end;
  return join(old_s,new_s,left.rcid=right.rcid AND left.bdid=right.bdid AND left.source=right.source AND left.source_group=right.source_group AND left.pflag=right.pflag AND left.group1_id=right.group1_id AND left.vendor_id=right.vendor_id AND left.dt_first_seen=right.dt_first_seen AND left.dt_last_seen=right.dt_last_seen AND left.dt_vendor_first_reported=right.dt_vendor_first_reported AND left.dt_vendor_last_reported=right.dt_vendor_last_reported AND left.company_name=right.company_name AND left.prim_range=right.prim_range AND left.predir=right.predir AND left.prim_name=right.prim_name AND left.addr_suffix=right.addr_suffix AND left.postdir=right.postdir AND left.unit_desig=right.unit_desig AND left.sec_range=right.sec_range AND left.city=right.city AND left.state=right.state AND left.zip=right.zip AND left.zip4=right.zip4 AND left.county=right.county AND left.msa=right.msa AND left.geo_lat=right.geo_lat AND left.geo_long=right.geo_long AND left.phone=right.phone AND left.phone_score=right.phone_score AND left.fein=right.fein AND left.current=right.current AND left.dppa=right.dppa AND left.vl_id=right.vl_id AND left.RawAID=right.RawAID,Take_Record(left,right),hash,full outer)(Added OR Deleted);
end;
export Difference_Summary(dataset(layout_as_bh)old_s, dataset(layout_as_bh) new_s) := function
  d := Differences(old_s,new_s);
  return  hygiene(old_s).Summary('Old')+ hygiene(new_s).Summary('New')+ hygiene(d(deleted)).Summary('Deletions')+ hygiene(d(added)).Summary('Additions');
end;
end;
