import ln_propertyv2;

assr      := distribute(ln_propertyv2.file_assessment,hash(ln_fares_id));
deed      := distribute(ln_propertyv2.file_deed,hash(ln_fares_id));
addl_assr := distribute(ln_propertyv2.File_addl_Fares_tax,hash(ln_fares_id));
addl_deed := distribute(ln_propertyv2.File_addl_fares_deed,hash(ln_fares_id));

r_merge_assr := record
 assr;
 //addl_assr;
 string60  fares_iris_apn;
 string60  fares_non_parsed_assessee_name;
 string60  fares_non_parsed_second_assessee_name;
 string10  fares_land_use;
 string60  fares_seller_name;
 string11  fares_calculated_land_value;
 string11  fares_calculated_improvement_value;
 string11  fares_calculated_total_value;
 string7   fares_living_square_feet;
 string7   fares_adjusted_gross_square_feet;
 string5   fares_no_of_full_baths;
 string5   fares_no_of_half_baths;
 string1   fares_pool_indicator;
 string3   fares_frame;
 string3   fares_electric_energy;
 string3   fares_sewer;
 string3   fares_water;
 string3   fares_condition;
end;

r_merge_deed := record
 deed;
 //addl_deed;
 string1  fares_corporate_indicator;
 string3  fares_transaction_type;
 string60 fares_lender_address;
 string8  fares_mortgage_date;
 string6  fares_mortgage_deed_type;
 string4  fares_mortgage_term_code;
 string5  fares_mortgage_term;
 string9  fares_building_square_feet;
 string1  fares_foreclosure;
 string1  fares_refi_flag;
 string1  fares_equity_flag;
 string60 fares_iris_apn;
end;

r_merge_assr t1(assr le, addl_assr ri) := transform
 self := le;
 self := ri;
end;

r_merge_deed t2(deed le, addl_deed ri) := transform
 self := le;
 self := ri;
end;

j1 := join(assr,addl_assr,left.ln_fares_id=right.ln_fares_id,t1(left,right),left outer,local);
j2 := join(deed,addl_deed,left.ln_fares_id=right.ln_fares_id,t2(left,right),left outer,local);

r3 := record
 string1  vendor2;
 string2  st2;
 string40 county2;
 j1;
 string2  st_lookup    :='';
 string40 county_lookup:='';
end;

r4 := record
 string1  vendor2;
 string2  st2;
 string40 county2;
 j2;
 string2  st_lookup    :='';
 string40 county_lookup:='';
end;

r3 t3(j1 le) := transform
 self.vendor2      := if(le.vendor_source_flag in ['F','S'],'F','L');
 self.st2          := le.state_code;
 self.county2      := ln_propertyv2.fn_patch_county(le.county_name,le.state_code);
 self              := le;
end;

r4 t4(j2 le) := transform
 self.vendor2      := if(le.vendor_source_flag in ['F','S'],'F','L');
 self.st2          := le.state;
 self.county2      := ln_propertyv2.fn_patch_county(le.county_name,le.state);
 self              := le;
end;

p1 := project(j1,t3(left));
p2 := project(j2,t4(left));

fips_rec := record
 string2  st;
 string5  fips;
 string40 county;
 string3  not_relevant;
end;

fips_lookup := dedup(sort(dataset('~thor_data400::in::fips_code_lookup',fips_rec,flat),fips),fips);

r3 t5(p1 le, fips_lookup ri) := transform
 self.st_lookup     := ri.st;
 self.county_lookup := ri.county;
 self               := le;
end;

r4 t6(p2 le, fips_lookup ri) := transform
 self.st_lookup     := ri.st;
 self.county_lookup := ri.county;
 self               := le;
end;

j3 := join(p1,fips_lookup,left.fips_code=right.fips,t5(left,right),lookup, left outer);
j4 := join(p2,fips_lookup,left.fips_code=right.fips,t6(left,right),lookup, left outer);

r3 t7(j3 le) := transform
 self.st2     := if(trim(le.st2)='' or (le.st2<>'' and le.st_lookup<>'' and le.st2<>le.st_lookup),le.st_lookup,le.st2);
 self.county2 := if(trim(le.county2)='' or (le.county2<>'' and le.county_lookup<>'' and le.county2<>le.county_lookup),le.county_lookup,le.county2);
 self         := le;
end;

r4 t8(j4 le) := transform
 self.st2     := if(trim(le.st2)='' or (le.st2<>'' and le.st_lookup<>'' and le.st2<>le.st_lookup),le.st_lookup,le.st2);
 self.county2 := if(trim(le.county2)='' or (le.county2<>'' and le.county_lookup<>'' and le.county2<>le.county_lookup),le.county_lookup,le.county2);
 self        := le;
end;

p3 := project(j3,t7(left));
p4 := project(j4,t8(left));

// TAX    
r_strata_assr :=  record
    CountGroup                                                    := count(group);
	p3.vendor2;
	p3.st2;
	//p3.county2;
	//p3.vendor_source_flag;
    //ln_fares_id_CountNonBlank                                     := sum(group,if(p3.ln_fares_id<>'',1,0));
    process_date_CountNonBlank                                    := sum(group,if(p3.process_date<>'',1,0));
    //vendor_source_flag_CountNonBlank                              := sum(group,if(p3.vendor_source_flag<>'',1,0));
    current_record_CountNonBlank                                  := sum(group,if(p3.current_record<>'',1,0));
    fips_code_CountNonBlank                                       := sum(group,if(p3.fips_code<>'',1,0));
    state_code_CountNonBlank                                      := sum(group,if(p3.state_code<>'',1,0));
    county_name_CountNonBlank                                     := sum(group,if(p3.county_name<>'',1,0));
    apna_or_pin_number_CountNonBlank                              := sum(group,if(p3.apna_or_pin_number<>'',1,0));
    fares_unformatted_apn_CountNonBlank                           := sum(group,if(p3.fares_unformatted_apn<>'',1,0));
    duplicate_apn_multiple_address_id_CountNonBlank               := sum(group,if(p3.duplicate_apn_multiple_address_id<>'',1,0));
    assessee_name_CountNonBlank                                   := sum(group,if(p3.assessee_name<>'',1,0));
    second_assessee_name_CountNonBlank                            := sum(group,if(p3.second_assessee_name<>'',1,0));
    assessee_ownership_rights_code_CountNonBlank                  := sum(group,if(p3.assessee_ownership_rights_code<>'',1,0));
    assessee_relationship_code_CountNonBlank                      := sum(group,if(p3.assessee_relationship_code<>'',1,0));
    assessee_phone_number_CountNonBlank                           := sum(group,if(p3.assessee_phone_number<>'',1,0));
    tax_account_number_CountNonBlank                              := sum(group,if(p3.tax_account_number<>'',1,0));
    contract_owner_CountNonBlank                                  := sum(group,if(p3.contract_owner<>'',1,0));
    assessee_name_type_code_CountNonBlank                         := sum(group,if(p3.assessee_name_type_code<>'',1,0));
    second_assessee_name_type_code_CountNonBlank                  := sum(group,if(p3.second_assessee_name_type_code<>'',1,0));
    mail_care_of_name_type_code_CountNonBlank                     := sum(group,if(p3.mail_care_of_name_type_code<>'',1,0));
    mailing_care_of_name_CountNonBlank                            := sum(group,if(p3.mailing_care_of_name<>'',1,0));
    mailing_full_street_address_CountNonBlank                     := sum(group,if(p3.mailing_full_street_address<>'',1,0));
    mailing_unit_number_CountNonBlank                             := sum(group,if(p3.mailing_unit_number<>'',1,0));
    mailing_city_state_zip_CountNonBlank                          := sum(group,if(p3.mailing_city_state_zip<>'',1,0));
    property_full_street_address_CountNonBlank                    := sum(group,if(p3.property_full_street_address<>'',1,0));
    property_unit_number_CountNonBlank                            := sum(group,if(p3.property_unit_number<>'',1,0));
    property_city_state_zip_CountNonBlank                         := sum(group,if(p3.property_city_state_zip<>'',1,0));
    property_country_code_CountNonBlank                           := sum(group,if(p3.property_country_code<>'',1,0));
    property_address_code_CountNonBlank                           := sum(group,if(p3.property_address_code<>'',1,0));
    legal_lot_code_CountNonBlank                                  := sum(group,if(p3.legal_lot_code<>'',1,0));
    legal_lot_number_CountNonBlank                                := sum(group,if(p3.legal_lot_number<>'',1,0));
    legal_land_lot_CountNonBlank                                  := sum(group,if(p3.legal_land_lot<>'',1,0));
    legal_block_CountNonBlank                                     := sum(group,if(p3.legal_block<>'',1,0));
    legal_section_CountNonBlank                                   := sum(group,if(p3.legal_section<>'',1,0));
    legal_district_CountNonBlank                                  := sum(group,if(p3.legal_district<>'',1,0));
    legal_unit_CountNonBlank                                      := sum(group,if(p3.legal_unit<>'',1,0));
    legal_city_municipality_township_CountNonBlank                := sum(group,if(p3.legal_city_municipality_township<>'',1,0));
    legal_subdivision_name_CountNonBlank                          := sum(group,if(p3.legal_subdivision_name<>'',1,0));
    legal_phase_number_CountNonBlank                              := sum(group,if(p3.legal_phase_number<>'',1,0));
    legal_tract_number_CountNonBlank                              := sum(group,if(p3.legal_tract_number<>'',1,0));
    legal_sec_twn_rng_mer_CountNonBlank                           := sum(group,if(p3.legal_sec_twn_rng_mer<>'',1,0));
    legal_brief_description_CountNonBlank                         := sum(group,if(p3.legal_brief_description<>'',1,0));
    legal_assessor_map_ref_CountNonBlank                          := sum(group,if(p3.legal_assessor_map_ref<>'',1,0));
    census_tract_CountNonBlank                                    := sum(group,if(p3.census_tract<>'',1,0));
    record_type_code_CountNonBlank                                := sum(group,if(p3.record_type_code<>'',1,0));
    ownership_type_code_CountNonBlank                             := sum(group,if(p3.ownership_type_code<>'',1,0));
    new_record_type_code_CountNonBlank                            := sum(group,if(p3.new_record_type_code<>'',1,0));
    county_land_use_code_CountNonBlank                            := sum(group,if(p3.county_land_use_code<>'',1,0));
    county_land_use_description_CountNonBlank                     := sum(group,if(p3.county_land_use_description<>'',1,0));
    standardized_land_use_code_CountNonBlank                      := sum(group,if(p3.standardized_land_use_code<>'',1,0));
    timeshare_code_CountNonBlank                                  := sum(group,if(p3.timeshare_code<>'',1,0));
    zoning_CountNonBlank                                          := sum(group,if(p3.zoning<>'',1,0));
    owner_occupied_CountNonBlank                                  := sum(group,if(p3.owner_occupied<>'',1,0));
    recorder_document_number_CountNonBlank                        := sum(group,if(p3.recorder_document_number<>'',1,0));
    recorder_book_number_CountNonBlank                            := sum(group,if(p3.recorder_book_number<>'',1,0));
    recorder_page_number_CountNonBlank                            := sum(group,if(p3.recorder_page_number<>'',1,0));
    transfer_date_CountNonBlank                                   := sum(group,if(p3.transfer_date<>'',1,0));
    recording_date_CountNonBlank                                  := sum(group,if(p3.recording_date<>'',1,0));
    sale_date_CountNonBlank                                       := sum(group,if(p3.sale_date<>'',1,0));
    document_type_CountNonBlank                                   := sum(group,if(p3.document_type<>'',1,0));
    sales_price_CountNonBlank                                     := sum(group,if(p3.sales_price<>'',1,0));
    sales_price_code_CountNonBlank                                := sum(group,if(p3.sales_price_code<>'',1,0));
    mortgage_loan_amount_CountNonBlank                            := sum(group,if(p3.mortgage_loan_amount<>'',1,0));
    mortgage_loan_type_code_CountNonBlank                         := sum(group,if(p3.mortgage_loan_type_code<>'',1,0));
    mortgage_lender_name_CountNonBlank                            := sum(group,if(p3.mortgage_lender_name<>'',1,0));
    mortgage_lender_type_code_CountNonBlank                       := sum(group,if(p3.mortgage_lender_type_code<>'',1,0));
    prior_transfer_date_CountNonBlank                             := sum(group,if(p3.prior_transfer_date<>'',1,0));
    prior_recording_date_CountNonBlank                            := sum(group,if(p3.prior_recording_date<>'',1,0));
    prior_sales_price_CountNonBlank                               := sum(group,if(p3.prior_sales_price<>'',1,0));
    prior_sales_price_code_CountNonBlank                          := sum(group,if(p3.prior_sales_price_code<>'',1,0));
    assessed_land_value_CountNonBlank                             := sum(group,if(p3.assessed_land_value<>'',1,0));
    assessed_improvement_value_CountNonBlank                      := sum(group,if(p3.assessed_improvement_value<>'',1,0));
    assessed_total_value_CountNonBlank                            := sum(group,if(p3.assessed_total_value<>'',1,0));
    assessed_value_year_CountNonBlank                             := sum(group,if(p3.assessed_value_year<>'',1,0));
    market_land_value_CountNonBlank                               := sum(group,if(p3.market_land_value<>'',1,0));
    market_improvement_value_CountNonBlank                        := sum(group,if(p3.market_improvement_value<>'',1,0));
    market_total_value_CountNonBlank                              := sum(group,if(p3.market_total_value<>'',1,0));
    market_value_year_CountNonBlank                               := sum(group,if(p3.market_value_year<>'',1,0));
    homestead_homeowner_exemption_CountNonBlank                   := sum(group,if(p3.homestead_homeowner_exemption<>'',1,0));
    tax_exemption1_code_CountNonBlank                             := sum(group,if(p3.tax_exemption1_code<>'',1,0));
    tax_exemption2_code_CountNonBlank                             := sum(group,if(p3.tax_exemption2_code<>'',1,0));
    tax_exemption3_code_CountNonBlank                             := sum(group,if(p3.tax_exemption3_code<>'',1,0));
    tax_exemption4_code_CountNonBlank                             := sum(group,if(p3.tax_exemption4_code<>'',1,0));
    tax_rate_code_area_CountNonBlank                              := sum(group,if(p3.tax_rate_code_area<>'',1,0));
    tax_amount_CountNonBlank                                      := sum(group,if(p3.tax_amount<>'',1,0));
    tax_year_CountNonBlank                                        := sum(group,if(p3.tax_year<>'',1,0));
    tax_delinquent_year_CountNonBlank                             := sum(group,if(p3.tax_delinquent_year<>'',1,0));
    school_tax_district1_CountNonBlank                            := sum(group,if(p3.school_tax_district1<>'',1,0));
    school_tax_district1_indicator_CountNonBlank                  := sum(group,if(p3.school_tax_district1_indicator<>'',1,0));
    school_tax_district2_CountNonBlank                            := sum(group,if(p3.school_tax_district2<>'',1,0));
    school_tax_district2_indicator_CountNonBlank                  := sum(group,if(p3.school_tax_district2_indicator<>'',1,0));
    school_tax_district3_CountNonBlank                            := sum(group,if(p3.school_tax_district3<>'',1,0));
    school_tax_district3_indicator_CountNonBlank                  := sum(group,if(p3.school_tax_district3_indicator<>'',1,0));
    land_acres_CountNonBlank                                      := sum(group,if(p3.land_acres<>'',1,0));
    land_square_footage_CountNonBlank                             := sum(group,if(p3.land_square_footage<>'',1,0));
    land_dimensions_CountNonBlank                                 := sum(group,if(p3.land_dimensions<>'',1,0));
    building_area_CountNonBlank                                   := sum(group,if(p3.building_area<>'',1,0));
    building_area_indicator_CountNonBlank                         := sum(group,if(p3.building_area_indicator<>'',1,0));
    building_area1_CountNonBlank                                  := sum(group,if(p3.building_area1<>'',1,0));
    building_area1_indicator_CountNonBlank                        := sum(group,if(p3.building_area1_indicator<>'',1,0));
    building_area2_CountNonBlank                                  := sum(group,if(p3.building_area2<>'',1,0));
    building_area2_indicator_CountNonBlank                        := sum(group,if(p3.building_area2_indicator<>'',1,0));
    building_area3_CountNonBlank                                  := sum(group,if(p3.building_area3<>'',1,0));
    building_area3_indicator_CountNonBlank                        := sum(group,if(p3.building_area3_indicator<>'',1,0));
    building_area4_CountNonBlank                                  := sum(group,if(p3.building_area4<>'',1,0));
    building_area4_indicator_CountNonBlank                        := sum(group,if(p3.building_area4_indicator<>'',1,0));
    building_area5_CountNonBlank                                  := sum(group,if(p3.building_area5<>'',1,0));
    building_area5_indicator_CountNonBlank                        := sum(group,if(p3.building_area5_indicator<>'',1,0));
    building_area6_CountNonBlank                                  := sum(group,if(p3.building_area6<>'',1,0));
    building_area6_indicator_CountNonBlank                        := sum(group,if(p3.building_area6_indicator<>'',1,0));
    building_area7_CountNonBlank                                  := sum(group,if(p3.building_area7<>'',1,0));
    building_area7_indicator_CountNonBlank                        := sum(group,if(p3.building_area7_indicator<>'',1,0));
    year_built_CountNonBlank                                      := sum(group,if(p3.year_built<>'',1,0));
    effective_year_built_CountNonBlank                            := sum(group,if(p3.effective_year_built<>'',1,0));
    no_of_buildings_CountNonBlank                                 := sum(group,if(p3.no_of_buildings<>'',1,0));
    no_of_stories_CountNonBlank                                   := sum(group,if(p3.no_of_stories<>'',1,0));
    no_of_units_CountNonBlank                                     := sum(group,if(p3.no_of_units<>'',1,0));
    no_of_rooms_CountNonBlank                                     := sum(group,if(p3.no_of_rooms<>'',1,0));
    no_of_bedrooms_CountNonBlank                                  := sum(group,if(p3.no_of_bedrooms<>'',1,0));
    no_of_baths_CountNonBlank                                     := sum(group,if(p3.no_of_baths<>'',1,0));
    no_of_partial_baths_CountNonBlank                             := sum(group,if(p3.no_of_partial_baths<>'',1,0));
    garage_type_code_CountNonBlank                                := sum(group,if(p3.garage_type_code<>'',1,0));
    parking_no_of_cars_CountNonBlank                              := sum(group,if(p3.parking_no_of_cars<>'',1,0));
    pool_code_CountNonBlank                                       := sum(group,if(p3.pool_code<>'',1,0));
    style_code_CountNonBlank                                      := sum(group,if(p3.style_code<>'',1,0));
    type_construction_code_CountNonBlank                          := sum(group,if(p3.type_construction_code<>'',1,0));
    exterior_walls_code_CountNonBlank                             := sum(group,if(p3.exterior_walls_code<>'',1,0));
    foundation_code_CountNonBlank                                 := sum(group,if(p3.foundation_code<>'',1,0));
    roof_cover_code_CountNonBlank                                 := sum(group,if(p3.roof_cover_code<>'',1,0));
    roof_type_code_CountNonBlank                                  := sum(group,if(p3.roof_type_code<>'',1,0));
    heating_code_CountNonBlank                                    := sum(group,if(p3.heating_code<>'',1,0));
    heating_fuel_type_code_CountNonBlank                          := sum(group,if(p3.heating_fuel_type_code<>'',1,0));
    air_conditioning_code_CountNonBlank                           := sum(group,if(p3.air_conditioning_code<>'',1,0));
    air_conditioning_type_code_CountNonBlank                      := sum(group,if(p3.air_conditioning_type_code<>'',1,0));
    elevator_CountNonBlank                                        := sum(group,if(p3.elevator<>'',1,0));
    fireplace_indicator_CountNonBlank                             := sum(group,if(p3.fireplace_indicator<>'',1,0));
    fireplace_number_CountNonBlank                                := sum(group,if(p3.fireplace_number<>'',1,0));
    basement_code_CountNonBlank                                   := sum(group,if(p3.basement_code<>'',1,0));
    building_class_code_CountNonBlank                             := sum(group,if(p3.building_class_code<>'',1,0));
    site_influence1_code_CountNonBlank                            := sum(group,if(p3.site_influence1_code<>'',1,0));
    site_influence2_code_CountNonBlank                            := sum(group,if(p3.site_influence2_code<>'',1,0));
    site_influence3_code_CountNonBlank                            := sum(group,if(p3.site_influence3_code<>'',1,0));
    site_influence4_code_CountNonBlank                            := sum(group,if(p3.site_influence4_code<>'',1,0));
    site_influence5_code_CountNonBlank                            := sum(group,if(p3.site_influence5_code<>'',1,0));
    amenities1_code_CountNonBlank                                 := sum(group,if(p3.amenities1_code<>'',1,0));
    amenities2_code_CountNonBlank                                 := sum(group,if(p3.amenities2_code<>'',1,0));
    amenities3_code_CountNonBlank                                 := sum(group,if(p3.amenities3_code<>'',1,0));
    amenities4_code_CountNonBlank                                 := sum(group,if(p3.amenities4_code<>'',1,0));
    amenities5_code_CountNonBlank                                 := sum(group,if(p3.amenities5_code<>'',1,0));
    other_buildings1_code_CountNonBlank                           := sum(group,if(p3.other_buildings1_code<>'',1,0));
    other_buildings2_code_CountNonBlank                           := sum(group,if(p3.other_buildings2_code<>'',1,0));
    other_buildings3_code_CountNonBlank                           := sum(group,if(p3.other_buildings3_code<>'',1,0));
    other_buildings4_code_CountNonBlank                           := sum(group,if(p3.other_buildings4_code<>'',1,0));
    other_buildings5_code_CountNonBlank                           := sum(group,if(p3.other_buildings5_code<>'',1,0));
    neighborhood_code_CountNonBlank                               := sum(group,if(p3.neighborhood_code<>'',1,0));
    condo_project_name_CountNonBlank                              := sum(group,if(p3.condo_project_name<>'',1,0));
    building_name_CountNonBlank                                   := sum(group,if(p3.building_name<>'',1,0));
    assessee_name_indicator_CountNonBlank                         := sum(group,if(p3.assessee_name_indicator<>'',1,0));
    second_assessee_name_indicator_CountNonBlank                  := sum(group,if(p3.second_assessee_name_indicator<>'',1,0));
    mail_care_of_name_indicator_CountNonBlank                     := sum(group,if(p3.mail_care_of_name_indicator<>'',1,0));
    comments_CountNonBlank                                        := sum(group,if(p3.comments<>'',1,0));
    tape_cut_date_CountNonBlank                                   := sum(group,if(p3.tape_cut_date<>'',1,0));
    certification_date_CountNonBlank                              := sum(group,if(p3.certification_date<>'',1,0));
    edition_number_CountNonBlank                                  := sum(group,if(p3.edition_number<>'',1,0));
    prop_addr_propagated_ind_CountNonBlank                        := sum(group,if(p3.prop_addr_propagated_ind<>'',1,0));
//
    fares_iris_apn_CountNonBlank                                      := sum(group,if(p3.fares_iris_apn<>'',1,0));
    fares_non_parsed_assessee_name_CountNonBlank                      := sum(group,if(p3.fares_non_parsed_assessee_name<>'',1,0));
    fares_non_parsed_second_assessee_name_CountNonBlank               := sum(group,if(p3.fares_non_parsed_second_assessee_name<>'',1,0));
    fares_land_use_CountNonBlank                                      := sum(group,if(p3.fares_land_use<>'',1,0));
    fares_seller_name_CountNonBlank                                   := sum(group,if(p3.fares_seller_name<>'',1,0));
    fares_calculated_land_value_CountNonBlank                         := sum(group,if(p3.fares_calculated_land_value<>'',1,0));
    fares_calculated_improvement_value_CountNonBlank                  := sum(group,if(p3.fares_calculated_improvement_value<>'',1,0));
    fares_calculated_total_value_CountNonBlank                        := sum(group,if(p3.fares_calculated_total_value<>'',1,0));
    fares_living_square_feet_CountNonBlank                            := sum(group,if(p3.fares_living_square_feet<>'',1,0));
    fares_adjusted_gross_square_feet_CountNonBlank                    := sum(group,if(p3.fares_adjusted_gross_square_feet<>'',1,0));
    fares_no_of_full_baths_CountNonBlank                              := sum(group,if(p3.fares_no_of_full_baths<>'',1,0));
    fares_no_of_half_baths_CountNonBlank                              := sum(group,if(p3.fares_no_of_half_baths<>'',1,0));
    fares_pool_indicator_CountNonBlank                                := sum(group,if(p3.fares_pool_indicator<>'',1,0));
    fares_frame_CountNonBlank                                         := sum(group,if(p3.fares_frame<>'',1,0));
    fares_electric_energy_CountNonBlank                               := sum(group,if(p3.fares_electric_energy<>'',1,0));
    fares_sewer_CountNonBlank                                         := sum(group,if(p3.fares_sewer<>'',1,0));
    fares_water_CountNonBlank                                         := sum(group,if(p3.fares_water<>'',1,0));
    fares_condition_CountNonBlank                                     := sum(group,if(p3.fares_condition<>'',1,0));    
end;

// deeds 
r_strata_deed := record
    CountGroup                                                                := count(group);
	p4.vendor2;
	p4.st2;
    //vendor_source_flag;
	//ln_fares_id_CountNonBlank                                                 := sum(group,if(p4.ln_fares_id<>'',1,0));
    process_date_CountNonBlank                                                := sum(group,if(p4.process_date<>'',1,0));
    //vendor_source_flag_CountNonBlank                                          := sum(group,if(p4.vendor_source_flag<>'',1,0));
    current_record_CountNonBlank                                              := sum(group,if(p4.current_record<>'',1,0));
    from_file_CountNonBlank                                                   := sum(group,if(p4.from_file<>'',1,0));
    fips_code_CountNonBlank                                                   := sum(group,if(p4.fips_code<>'',1,0));
    state_CountNonBlank                                                       := sum(group,if(p4.state<>'',1,0));
    county_name_CountNonBlank                                                 := sum(group,if(p4.county_name<>'',1,0));
    record_type_CountNonBlank                                                 := sum(group,if(p4.record_type<>'',1,0));
    apnt_or_pin_number_CountNonBlank                                          := sum(group,if(p4.apnt_or_pin_number<>'',1,0));
    fares_unformatted_apn_CountNonBlank                                       := sum(group,if(p4.fares_unformatted_apn<>'',1,0));
    multi_apn_flag_CountNonBlank                                              := sum(group,if(p4.multi_apn_flag<>'',1,0));
    tax_id_number_CountNonBlank                                               := sum(group,if(p4.tax_id_number<>'',1,0));
    excise_tax_number_CountNonBlank                                           := sum(group,if(p4.excise_tax_number<>'',1,0));
    buyer_or_borrower_ind_CountNonBlank                                       := sum(group,if(p4.buyer_or_borrower_ind<>'',1,0));
    name1_CountNonBlank                                                       := sum(group,if(p4.name1<>'',1,0));
    name1_id_code_CountNonBlank                                               := sum(group,if(p4.name1_id_code<>'',1,0));
    name2_CountNonBlank                                                       := sum(group,if(p4.name2<>'',1,0));
    name2_id_code_CountNonBlank                                               := sum(group,if(p4.name2_id_code<>'',1,0));
    vesting_code_CountNonBlank                                                := sum(group,if(p4.vesting_code<>'',1,0));
    addendum_flag_CountNonBlank                                               := sum(group,if(p4.addendum_flag<>'',1,0));
    phone_number_CountNonBlank                                                := sum(group,if(p4.phone_number<>'',1,0));
    mailing_care_of_CountNonBlank                                             := sum(group,if(p4.mailing_care_of<>'',1,0));
    mailing_street_CountNonBlank                                              := sum(group,if(p4.mailing_street<>'',1,0));
    mailing_unit_number_CountNonBlank                                         := sum(group,if(p4.mailing_unit_number<>'',1,0));
    mailing_csz_CountNonBlank                                                 := sum(group,if(p4.mailing_csz<>'',1,0));
    mailing_address_cd_CountNonBlank                                          := sum(group,if(p4.mailing_address_cd<>'',1,0));
    seller1_CountNonBlank                                                     := sum(group,if(p4.seller1<>'',1,0));
    seller1_id_code_CountNonBlank                                             := sum(group,if(p4.seller1_id_code<>'',1,0));
    seller2_CountNonBlank                                                     := sum(group,if(p4.seller2<>'',1,0));
    seller2_id_code_CountNonBlank                                             := sum(group,if(p4.seller2_id_code<>'',1,0));
    seller_addendum_flag_CountNonBlank                                        := sum(group,if(p4.seller_addendum_flag<>'',1,0));
    seller_mailing_full_street_address_CountNonBlank                          := sum(group,if(p4.seller_mailing_full_street_address<>'',1,0));
    seller_mailing_address_unit_number_CountNonBlank                          := sum(group,if(p4.seller_mailing_address_unit_number<>'',1,0));
    seller_mailing_address_citystatezip_CountNonBlank                         := sum(group,if(p4.seller_mailing_address_citystatezip<>'',1,0));
    property_full_street_address_CountNonBlank                                := sum(group,if(p4.property_full_street_address<>'',1,0));
    property_address_unit_number_CountNonBlank                                := sum(group,if(p4.property_address_unit_number<>'',1,0));
    property_address_citystatezip_CountNonBlank                               := sum(group,if(p4.property_address_citystatezip<>'',1,0));
    property_address_code_CountNonBlank                                       := sum(group,if(p4.property_address_code<>'',1,0));
    legal_lot_code_CountNonBlank                                              := sum(group,if(p4.legal_lot_code<>'',1,0));
    legal_lot_number_CountNonBlank                                            := sum(group,if(p4.legal_lot_number<>'',1,0));
    legal_block_CountNonBlank                                                 := sum(group,if(p4.legal_block<>'',1,0));
    legal_section_CountNonBlank                                               := sum(group,if(p4.legal_section<>'',1,0));
    legal_district_CountNonBlank                                              := sum(group,if(p4.legal_district<>'',1,0));
    legal_land_lot_CountNonBlank                                              := sum(group,if(p4.legal_land_lot<>'',1,0));
    legal_unit_CountNonBlank                                                  := sum(group,if(p4.legal_unit<>'',1,0));
    legal_city_municipality_township_CountNonBlank                            := sum(group,if(p4.legal_city_municipality_township<>'',1,0));
    legal_subdivision_name_CountNonBlank                                      := sum(group,if(p4.legal_subdivision_name<>'',1,0));
    legal_phase_number_CountNonBlank                                          := sum(group,if(p4.legal_phase_number<>'',1,0));
    legal_tract_number_CountNonBlank                                          := sum(group,if(p4.legal_tract_number<>'',1,0));
    legal_sec_twn_rng_mer_CountNonBlank                                       := sum(group,if(p4.legal_sec_twn_rng_mer<>'',1,0));
    legal_brief_description_CountNonBlank                                     := sum(group,if(p4.legal_brief_description<>'',1,0));
    recorder_map_reference_CountNonBlank                                      := sum(group,if(p4.recorder_map_reference<>'',1,0));
    complete_legal_description_code_CountNonBlank                             := sum(group,if(p4.complete_legal_description_code<>'',1,0));
    contract_date_CountNonBlank                                               := sum(group,if(p4.contract_date<>'',1,0));
    recording_date_CountNonBlank                                              := sum(group,if(p4.recording_date<>'',1,0));
	arm_reset_date_CountNonBlank                                              := sum(group,if(p4.arm_reset_date<>'',1,0));
    document_number_CountNonBlank                                             := sum(group,if(p4.document_number<>'',1,0));
    document_type_code_CountNonBlank                                          := sum(group,if(p4.document_type_code<>'',1,0));
    loan_number_CountNonBlank                                                 := sum(group,if(p4.loan_number<>'',1,0));
    recorder_book_number_CountNonBlank                                        := sum(group,if(p4.recorder_book_number<>'',1,0));
    recorder_page_number_CountNonBlank                                        := sum(group,if(p4.recorder_page_number<>'',1,0));
    concurrent_mortgage_book_page_document_number_CountNonBlank               := sum(group,if(p4.concurrent_mortgage_book_page_document_number<>'',1,0));
    sales_price_CountNonBlank                                                 := sum(group,if(p4.sales_price<>'',1,0));
    sales_price_code_CountNonBlank                                            := sum(group,if(p4.sales_price_code<>'',1,0));
    city_transfer_tax_CountNonBlank                                           := sum(group,if(p4.city_transfer_tax<>'',1,0));
    county_transfer_tax_CountNonBlank                                         := sum(group,if(p4.county_transfer_tax<>'',1,0));
    total_transfer_tax_CountNonBlank                                          := sum(group,if(p4.total_transfer_tax<>'',1,0));
    first_td_loan_amount_CountNonBlank                                        := sum(group,if(p4.first_td_loan_amount<>'',1,0));
    second_td_loan_amount_CountNonBlank                                       := sum(group,if(p4.second_td_loan_amount<>'',1,0));
    first_td_lender_type_code_CountNonBlank                                   := sum(group,if(p4.first_td_lender_type_code<>'',1,0));
    second_td_lender_type_code_CountNonBlank                                  := sum(group,if(p4.second_td_lender_type_code<>'',1,0));
    first_td_loan_type_code_CountNonBlank                                     := sum(group,if(p4.first_td_loan_type_code<>'',1,0));
    type_financing_CountNonBlank                                              := sum(group,if(p4.type_financing<>'',1,0));
    first_td_interest_rate_CountNonBlank                                      := sum(group,if(p4.first_td_interest_rate<>'',1,0));
    first_td_due_date_CountNonBlank                                           := sum(group,if(p4.first_td_due_date<>'',1,0));
    title_company_name_CountNonBlank                                          := sum(group,if(p4.title_company_name<>'',1,0));
    partial_interest_transferred_CountNonBlank                                := sum(group,if(p4.partial_interest_transferred<>'',1,0));
    loan_term_months_CountNonBlank                                            := sum(group,if(p4.loan_term_months<>'',1,0));
    loan_term_years_CountNonBlank                                             := sum(group,if(p4.loan_term_years<>'',1,0));
    lender_name_CountNonBlank                                                 := sum(group,if(p4.lender_name<>'',1,0));
    lender_name_id_CountNonBlank                                              := sum(group,if(p4.lender_name_id<>'',1,0));
    lender_dba_aka_name_CountNonBlank                                         := sum(group,if(p4.lender_dba_aka_name<>'',1,0));
    lender_full_street_address_CountNonBlank                                  := sum(group,if(p4.lender_full_street_address<>'',1,0));
    lender_address_unit_number_CountNonBlank                                  := sum(group,if(p4.lender_address_unit_number<>'',1,0));
    lender_address_citystatezip_CountNonBlank                                 := sum(group,if(p4.lender_address_citystatezip<>'',1,0));
    assessment_match_land_use_code_CountNonBlank                              := sum(group,if(p4.assessment_match_land_use_code<>'',1,0));
    property_use_code_CountNonBlank                                           := sum(group,if(p4.property_use_code<>'',1,0));
    condo_code_CountNonBlank                                                  := sum(group,if(p4.condo_code<>'',1,0));
    timeshare_flag_CountNonBlank                                              := sum(group,if(p4.timeshare_flag<>'',1,0));
    land_lot_size_CountNonBlank                                               := sum(group,if(p4.land_lot_size<>'',1,0));
    hawaii_tct_CountNonBlank                                                  := sum(group,if(p4.hawaii_tct<>'',1,0));
    hawaii_condo_cpr_code_CountNonBlank                                       := sum(group,if(p4.hawaii_condo_cpr_code<>'',1,0));
    hawaii_condo_name_CountNonBlank                                           := sum(group,if(p4.hawaii_condo_name<>'',1,0));
    filler_except_hawaii_CountNonBlank                                        := sum(group,if(p4.filler_except_hawaii<>'',1,0));
    rate_change_frequency_CountNonBlank                                       := sum(group,if(p4.rate_change_frequency<>'',1,0));
    change_index_CountNonBlank                                                := sum(group,if(p4.change_index<>'',1,0));
    adjustable_rate_index_CountNonBlank                                       := sum(group,if(p4.adjustable_rate_index<>'',1,0));
    adjustable_rate_rider_CountNonBlank                                       := sum(group,if(p4.adjustable_rate_rider<>'',1,0));
    graduated_payment_rider_CountNonBlank                                     := sum(group,if(p4.graduated_payment_rider<>'',1,0));
    balloon_rider_CountNonBlank                                               := sum(group,if(p4.balloon_rider<>'',1,0));
    fixed_step_rate_rider_CountNonBlank                                       := sum(group,if(p4.fixed_step_rate_rider<>'',1,0));
    condominium_rider_CountNonBlank                                           := sum(group,if(p4.condominium_rider<>'',1,0));
    planned_unit_development_rider_CountNonBlank                              := sum(group,if(p4.planned_unit_development_rider<>'',1,0));
    rate_improvement_rider_CountNonBlank                                      := sum(group,if(p4.rate_improvement_rider<>'',1,0));
    assumability_rider_CountNonBlank                                          := sum(group,if(p4.assumability_rider<>'',1,0));
    prepayment_rider_CountNonBlank                                            := sum(group,if(p4.prepayment_rider<>'',1,0));
    one_four_family_rider_CountNonBlank                                       := sum(group,if(p4.one_four_family_rider<>'',1,0));
    biweekly_payment_rider_CountNonBlank                                      := sum(group,if(p4.biweekly_payment_rider<>'',1,0));
    second_home_rider_CountNonBlank                                           := sum(group,if(p4.second_home_rider<>'',1,0));
    data_source_code_CountNonBlank                                            := sum(group,if(p4.data_source_code<>'',1,0));
    main_record_id_code_CountNonBlank                                         := sum(group,if(p4.main_record_id_code<>'',1,0));
    addl_name_flag_CountNonBlank                                              := sum(group,if(p4.addl_name_flag<>'',1,0));
    prop_addr_propagated_ind_CountNonBlank                                    := sum(group,if(p4.prop_addr_propagated_ind<>'',1,0));
//
    fares_corporate_indicator_CountNonBlank                := sum(group,if(p4.fares_corporate_indicator<>'',1,0));
    fares_transaction_type_CountNonBlank                   := sum(group,if(p4.fares_transaction_type<>'',1,0));
    fares_lender_address_CountNonBlank                     := sum(group,if(p4.fares_lender_address<>'',1,0));
    fares_mortgage_date_CountNonBlank                      := sum(group,if(p4.fares_mortgage_date<>'',1,0));
    fares_mortgage_deed_type_CountNonBlank                 := sum(group,if(p4.fares_mortgage_deed_type<>'',1,0));
    fares_mortgage_term_code_CountNonBlank                 := sum(group,if(p4.fares_mortgage_term_code<>'',1,0));
    fares_mortgage_term_CountNonBlank                      := sum(group,if(p4.fares_mortgage_term<>'',1,0));
    fares_building_square_feet_CountNonBlank               := sum(group,if(p4.fares_building_square_feet<>'',1,0));
    fares_foreclosure_CountNonBlank                        := sum(group,if(p4.fares_foreclosure<>'',1,0));
    fares_refi_flag_CountNonBlank                          := sum(group,if(p4.fares_refi_flag<>'',1,0));
    fares_equity_flag_CountNonBlank                        := sum(group,if(p4.fares_equity_flag<>'',1,0));
    fares_iris_apn_CountNonBlank                           := sum(group,if(p4.fares_iris_apn<>'',1,0));
  end;
  
ta1 := output(sort(table(p3,r_strata_assr,vendor2,st2,few),st2,vendor2),all);
ta2 := output(sort(table(p4,r_strata_deed,vendor2,st2,few),st2,vendor2),all);

export ln_property_field_populations := sequential(ta1,ta2);