import address, addrfraud, doxie, property, Risk_Indicators, ut;

//constants
myGetDate := ut.getDate;
historydate := 999999;

//Data files
Foreclosure_Address := property.file_Foreclosure;

//
//Layouts
Layout_Foreclosure_In_Slim :=  record
  string70 foreclosure_id;
  string2  state;
  string3  county;
  string18 batch_date_and_seq_nbr;
  string3  deed_category;
  string55 deed_desc;
  string3  document_type;
  string40 document_desc;
  string8  recording_date;
  string4  document_year;
  string12 document_nbr;
  string6  document_book;
  string6  document_pages;
  string5  title_company_code;
  string60 title_company_name;
  string60 attorney_name;
  string10 attorney_phone_nbr;
  string30 first_defendant_borrower_owner_first_name;
  string30 first_defendant_borrower_owner_last_name;
  string30 first_defendant_borrower_company_name;
  string30 second_defendant_borrower_owner_first_name;
  string30 second_defendant_borrower_owner_last_name;
  string30 second_defendant_borrower_company_name;
  string30 third_defendant_borrower_owner_first_name;
  string30 third_defendant_borrower_owner_last_name;
  string30 third_defendant_borrower_company_name;
  string30 fourth_defendant_borrower_owner_first_name;
  string30 fourth_defendant_borrower_owner_last_name;
  string30 fourth_defendant_borrower_company_name;
  string1  defendant_borrower_owner_et_al_indicator;
  string10 et_al_desc;
  string10 date_of_default;
  string11 amount_of_default;
  string10 filing_date;
  string20 court_case_nbr;
  string1  lis_pendens_type;
  string30 plaintiff_1;
  string30 plaintiff_2;
  string11 final_judgment_amount;
  string10 auction_date;
  string10 auction_time;
  string30 street_address_of_auction_call;
  string25 city_of_auction_call;
  string2  state_of_auction_call;
  string11 opening_bid;
  string4  tax_year;
  string11 sales_price;
  string1  situs_address_indicator_1;
  string5  situs_house_number_prefix_1;
  string10 situs_house_number_1;
  string10 situs_house_number_suffix_1;
  string30 situs_street_name_1;
  string5  situs_mode_1;
  string2  situs_direction_1;
  string2  situs_quadrant_1;
  string6  apartment_unit;
  string40 property_city_1;
  string2  property_state_1;
  string9  property_address_zip_code_1;
  string4  carrier_code;
  string60 full_site_address_unparsed_1;
  string30 lender_beneficiary_first_name;
  string30 lender_beneficiary_last_name;
  string30 lender_beneficiary_company_name;
  string60 lender_beneficiary_mailing_address;
  string40 lender_beneficiary_city;
  string2  lender_beneficiary_state;
  string9  lender_beneficiary_zip;
  string10 lender_phone;
  string30 trustee_name;
  string60 trustee_mailing_address;
  string40 trustee_city;
  string2  trustee_state;
  string9  trustee_zip;
  string10 trustee_phone;
  string20 trustee_sale_number;
  string8  original_loan_date;
  string8  original_loan_recording_date;
  string11 original_loan_amount;
  string12 original_document_number;
  string6  original_recording_book;
  string6  original_recording_page;
  string45 parcel_number_parcel_id;
  string45 parcel_number_unmatched_id;
  string8  last_full_sale_transfer_date;
  string11 transfer_value;
  string1  situs_address_indicator_2;
  string5  situs_house_number_prefix_2;
  string10 situs_house_number_2;
  string10 situs_house_number_suffix_2;
  string30 situs_street_name_2;
  string5  situs_mode_2;
  string2  situs_direction_2;
  string2  situs_quadrant_2;
  string6  apartment_unit_2;
  string40 property_city_2;
  string2  property_state_2;
  string9  property_address_zip_code_2;
  string4  carrier_code_2;
  string60 full_site_address_unparsed_2;
  string2  property_indicator;
  string55 property_desc;
  string3  use_code;
  string55 use_desc;
  string5  number_of_units;
  string9  living_area_square_feet;
  string5  number_of_bedrooms;
  string5  number_of_bathrooms;
  string3  number_of_garages;
  string10 zoning_code;
  string9  lot_size;
  string4  year_built;
  string11 current_land_value;
  string11 current_improvement_value;
  string3  section;
  string3  township;
  string3  foreclosure_range;
  string5  lot_orig;
  string5  block;
  string30 tract_subdivision_name;
  string6  map_book;
  string6  map_page;
  string5  unit_nbr;
  string250 expanded_legal;
  string250 legal_2;
  string250 legal_3;
  string50 legal_4;
  string5  name1_prefix;
  string20 name1_first;
  string20 name1_middle;
  string20 name1_last;
  string5  name1_suffix;
  string3  name1_score;
  string60 name1_company;
  string5  name2_prefix;
  string20 name2_first;
  string20 name2_middle;
  string20 name2_last;
  string5  name2_suffix;
  string3  name2_score;
  string60 name2_company;
  // string5  name3_prefix;
  // string20 name3_first;
  // string20 name3_middle;
  // string20 name3_last;
  // string5  name3_suffix;
  // string3  name3_score;
  // string60 name3_company;
  // string5  name4_prefix;
  // string20 name4_first;
  // string20 name4_middle;
  // string20 name4_last;
  // string5  name4_suffix;
  // string3  name4_score;
  // string60 name4_company;
  string10 situs1_prim_range;
  string2  situs1_predir;
  string28 situs1_prim_name;
  string4  situs1_addr_suffix;
  string2  situs1_postdir;
  string10 situs1_unit_desig;
  string8  situs1_sec_range;
  string25 situs1_p_city_name;
  string25 situs1_v_city_name;
  string2  situs1_st;
  string5  situs1_zip;
  string4  situs1_zip4;
  string4  situs1_cart;
  string1  situs1_cr_sort_sz;
  string4  situs1_lot;
  string1  situs1_lot_order;
  string2  situs1_dpbc;
  string1  situs1_chk_digit;
  string2  situs1_record_type;
  string2  situs1_ace_fips_st;
  string3  situs1_fipscounty;
  string10 situs1_geo_lat;
  string11 situs1_geo_long;
  string4  situs1_msa;
  string7  situs1_geo_blk;
  string1  situs1_geo_match;
  string4  situs1_err_stat;
  // string10 situs2_prim_range;
  // string2  situs2_predir;
  // string28 situs2_prim_name;
  // string4  situs2_addr_suffix;
  // string2  situs2_postdir;
  // string10 situs2_unit_desig;
  // string8  situs2_sec_range;
  // string25 situs2_p_city_name;
  // string25 situs2_v_city_name;
  // string2  situs2_st;
  // string5  situs2_zip;
  // string4  situs2_zip4;
  // string4  situs2_cart;
  // string1  situs2_cr_sort_sz;
  // string4  situs2_lot;
  // string1  situs2_lot_order;
  // string2  situs2_dpbc;
  // string1  situs2_chk_digit;
  // string2  situs2_record_type;
  // string2  situs2_ace_fips_st;
  // string3  situs2_fipscounty;
  // string10 situs2_geo_lat;
  // string11 situs2_geo_long;
  // string4  situs2_msa;
  // string7  situs2_geo_blk;
  // string1  situs2_geo_match;
  // string4  situs2_err_stat;
  string8 process_date;
  // string2 crlf;
end;
layout_geolink := record
	string12 geolink;
end;
layout_Foreclosures := record
	unsigned2 NOD;
	unsigned2 NOD_30;
	unsigned2 NOD_90;
	unsigned2 NOD_180;
	unsigned2 NOD_1;
	unsigned2 NOD_2;
	unsigned2 foreclosures;
	unsigned2 foreclosures_30;
	unsigned2 foreclosures_90;
	unsigned2 foreclosures_180;
	unsigned2 foreclosures_1;
	unsigned2 foreclosures_2;
	unsigned2 Deed_transfers;
	unsigned2 Deed_transfers_30;
	unsigned2 Deed_transfers_90;
	unsigned2 Deed_transfers_180;
	unsigned2 Deed_transfers_1;
	unsigned2 Deed_transfers_2;
	unsigned2 Release_Lis_Pendens;
	unsigned2 Release_Lis_Pendens_30;
	unsigned2 Release_Lis_Pendens_90;
	unsigned2 Release_Lis_Pendens_180;
	unsigned2 Release_Lis_Pendens_1;
	unsigned2 Release_Lis_Pendens_2;
end;
layout_Foreclosures_Slim := record
	unsigned2 NOD;
	unsigned2 foreclosures;
	unsigned2 Deed_transfers;
	unsigned2 Release_Lis_Pendens;
end;
layout_Foreclosures_Geolink := record
	address.Layout_Clean182;
	string12 geo_link;
	layout_geolink;
	layout_Foreclosures;
End;



// Append Address Foreclosure Data
layout_Foreclosures_Geolink addAddressForeclosures(Foreclosure_Address l) := TRANSFORM
	cat_address :=  l.situs1_prim_range + ' ' + l.situs1_predir + ' ' + l.situs1_prim_name + ' ' + l.situs1_addr_suffix + ' ' + l.situs1_postdir + ' ' + l.situs1_unit_desig + ' ' + l.situs1_sec_range;	
	clean_address := Risk_Indicators.MOD_AddressClean.clean_addr(cat_address, l.situs1_p_city_name, l.situs1_st, l.situs1_zip);
	self.prim_range := clean_address [1..10];
	self.predir := clean_address [11..12];
	self.prim_name := clean_address [13..40];
	self.addr_suffix := clean_address [41..44];
	self.postdir := clean_address [45..46];
	self.unit_desig := clean_address [47..56];
	self.sec_range := clean_address [57..65];
	self.p_city_name := clean_address [90..114];
	self.st := clean_address [115..116];
	self.zip := clean_address [117..121];
	self.zip4 := clean_address[122..125];
	self.county := clean_address[143..145];
	self.geo_lat := clean_address[146..155];
	self.geo_long := clean_address[156..166];
	self.msa := clean_address[167..170];
	self.geo_blk := clean_address[171..177];
	self.geo_match := clean_address[178];
	
	//build geolink for AddrRisk
	self.geo_link := clean_address[115..116]+clean_address[143..145]+clean_address[171..177];	
	
	// self.v_city_name := l.v_city_name;  
	// self.cr_sort_sz := l.cr_sort_sz;
	// self.cart := l.cart;
	// self.lot := l.lot;	
	// self.lot_order := l.lot_order;	
	// self.dbpc := l.dbpc;		
	// self.chk_digit := l.chk_digit;	
	// self.rec_type := l.rec_type;	
	// self.err_stat := l.err_stat;	
	
	self.NOD     := if(l.Deed_Category IN ['L','N'], 1, 0 );
	self.NOD_30  := if( (unsigned4)l.recording_date between 0 and 30 and l.Deed_Category IN ['L','N']  , 1, 0 );
	self.NOD_90  := if( (unsigned4)l.recording_date between 31 and 90 and l.Deed_Category IN ['L','N']  , 1, 0 );
	self.NOD_180 := if( (unsigned4)l.recording_date between 91 and 180 and l.Deed_Category IN ['L','N'] , 1, 0 );
	self.NOD_1 	 := if( (unsigned4)l.recording_date between AddrFraud.Constants.twoYrAgo   and AddrFraud.Constants.oneYrAgo and l.Deed_Category IN ['L','N'] , 1, 0 );
	self.NOD_2 	 := if( (unsigned4)l.recording_date between AddrFraud.Constants.threeYrAgo and AddrFraud.Constants.twoYrAgo and l.Deed_Category IN ['L','N'] , 1, 0 );
	self.foreclosures     := if(l.Deed_Category ='U', 1, 0 );
	self.foreclosures_30  := if( (unsigned4)l.recording_date between 0 and 30 and l.Deed_Category ='U'  , 1, 0 );
	self.foreclosures_90  := if( (unsigned4)l.recording_date between 31 and 90 and l.Deed_Category ='U'  , 1, 0 );
	self.foreclosures_180 := if( (unsigned4)l.recording_date between 91 and 180 and l.Deed_Category ='U', 1, 0 );
	self.foreclosures_1 	:= if( (unsigned4)l.recording_date between AddrFraud.Constants.twoYrAgo   and AddrFraud.Constants.oneYrAgo and l.Deed_Category ='U' , 1, 0 );
	self.foreclosures_2 	:= if( (unsigned4)l.recording_date between AddrFraud.Constants.threeYrAgo and AddrFraud.Constants.twoYrAgo and l.Deed_Category ='U' , 1, 0 );
	self.Deed_transfers 	  := if(l.Deed_Category IN ['S','G','T','R'], 1, 0 );
	self.Deed_transfers_30  := if( (unsigned4)l.recording_date between 0 and 30 and l.Deed_Category IN ['S','G','T','R']  , 1, 0 );
	self.Deed_transfers_90  := if( (unsigned4)l.recording_date between 31 and 90 and l.Deed_Category IN ['S','G','T','R']  , 1, 0 );
	self.Deed_transfers_180 := if( (unsigned4)l.recording_date between 91 and 180 and l.Deed_Category IN ['S','G','T','R'], 1, 0 );
	self.Deed_transfers_1 	:= if( (unsigned4)l.recording_date between AddrFraud.Constants.twoYrAgo   and AddrFraud.Constants.oneYrAgo and l.Deed_Category IN ['S','G','T','R'] , 1, 0 );
	self.Deed_transfers_2 	:= if( (unsigned4)l.recording_date between AddrFraud.Constants.threeYrAgo and AddrFraud.Constants.twoYrAgo and l.Deed_Category IN ['S','G','T','R'] , 1, 0 );
	self.Release_Lis_Pendens 			:= if(l.Deed_Category ='R', 1, 0 );
	self.Release_Lis_Pendens_30 	:= if( (unsigned4)l.recording_date between 0 and 30 and l.Deed_Category ='R'  , 1, 0 );
	self.Release_Lis_Pendens_90 	:= if( (unsigned4)l.recording_date between 31 and 90 and l.Deed_Category ='R'  , 1, 0 );
	self.Release_Lis_Pendens_180  := if( (unsigned4)l.recording_date between 91 and 180 and l.Deed_Category ='R', 1, 0 );
	self.Release_Lis_Pendens_1 		:= if( (unsigned4)l.recording_date between AddrFraud.Constants.twoYrAgo   and AddrFraud.Constants.oneYrAgo and l.Deed_Category ='R' , 1, 0 );
	self.Release_Lis_Pendens_2 		:= if( (unsigned4)l.recording_date between AddrFraud.Constants.threeYrAgo and AddrFraud.Constants.twoYrAgo and l.Deed_Category ='R' , 1, 0 );
	
	self := l;
	self := [];
END;
		
address_foreclosures_init := project(Foreclosure_Address, addAddressForeclosures(Left));
address_foreclosures_dist := distribute(address_foreclosures_init, hash32(geolink));
layout_Foreclosures_Geolink rollForeclosures( layout_Foreclosures_Geolink l, layout_Foreclosures_Geolink r ) := TRANSFORM
	self.NOD     := l.NOD     + r.NOD;
	self.NOD_30 := l.NOD_30 + r.NOD_30;
	self.NOD_90 := l.NOD_90 + r.NOD_90;
	self.NOD_180 := l.NOD_180 + r.NOD_180;
	self.NOD_1 := l.NOD_1 + r.NOD_1;
	self.NOD_2 := l.NOD_2 + r.NOD_2;
	self.foreclosures     := l.foreclosures     + r.foreclosures;
	self.foreclosures_30 := l.foreclosures_30 + r.foreclosures_30;
	self.foreclosures_90 := l.foreclosures_90 + r.foreclosures_90;
	self.foreclosures_180 := l.foreclosures_180 + r.foreclosures_180;
	self.foreclosures_1 := l.foreclosures_1 + r.foreclosures_1;
	self.foreclosures_2 := l.foreclosures_2 + r.foreclosures_2;
	self.Deed_transfers     := l.Deed_transfers     + r.Deed_transfers;
	self.Deed_transfers_30 := l.Deed_transfers_30 + r.Deed_transfers_30;
	self.Deed_transfers_90 := l.Deed_transfers_90 + r.Deed_transfers_90;
	self.Deed_transfers_180 := l.Deed_transfers_180 + r.Deed_transfers_180;
	self.Deed_transfers_1 := l.Deed_transfers_1 + r.Deed_transfers_1;
	self.Deed_transfers_2 := l.Deed_transfers_2 + r.Deed_transfers_2;
	self.Release_Lis_Pendens     := l.Release_Lis_Pendens     + r.Release_Lis_Pendens;
	self.Release_Lis_Pendens_30 := l.Release_Lis_Pendens_30 + r.Release_Lis_Pendens_30;
	self.Release_Lis_Pendens_90 := l.Release_Lis_Pendens_90 + r.Release_Lis_Pendens_90;
	self.Release_Lis_Pendens_180 := l.Release_Lis_Pendens_180 + r.Release_Lis_Pendens_180;
	self.Release_Lis_Pendens_1 := l.Release_Lis_Pendens_1 + r.Release_Lis_Pendens_1;
	self.Release_Lis_Pendens_2 := l.Release_Lis_Pendens_2 + r.Release_Lis_Pendens_2;
	self := l;
END;
address_foreclosures := rollup(sort(address_foreclosures_dist, geolink, local), rollForeclosures(left,right), geolink, local);

export file_foreclosure := address_foreclosures;