import _control, ut;
export Proc_PrePros_BusReg(string filedate) := function

//Spray New Accutrend File Created from Ab Initio Process.
do1:= FileServices.SprayFixed(_control.IPAddress.edata10
					,'/prod_data_build_10/production_data/business_headers/accutrend/out/accutrend.'+filedate+'.d00'
					,4342
					,'thor400_92'
					,'~thor_data400::in::fbn::'+filedate+'::accutrend_clean',-1,,,true,true,true);
   
//Place Sprayed file in the Superfile for Accutrend Clean File.
do2 := sequential(fileservices.addsuperfile('~thor_data400::in::fbn::sprayed::delete::accutrend_clean','~thor_data400::in::fbn::sprayed::grandfather::accutrend_clean',,true),
   					fileservices.clearsuperfile('~thor_data400::in::fbn::sprayed::grandfather::accutrend_clean'),
   					fileservices.addsuperfile('~thor_data400::in::fbn::sprayed::grandfather::accutrend_clean','~thor_data400::in::fbn::sprayed::father::accutrend_clean',,true),
   					fileservices.clearsuperfile('~thor_data400::in::fbn::sprayed::father::accutrend_clean'),
   					fileservices.addsuperfile('~thor_data400::in::fbn::sprayed::father::accutrend_clean','~thor_data400::in::fbn::sprayed::accutrend_clean',,true),
   					fileservices.clearsuperfile('~thor_data400::in::fbn::sprayed::accutrend_clean'),
   					fileservices.addsuperfile('~thor_data400::in::fbn::sprayed::accutrend_clean','~thor_data400::in::fbn::'+filedate+'::accutrend_clean'),
   					fileservices.clearsuperfile('~thor_data400::in::fbn::sprayed::delete::accutrend_clean',true));


spray_file := sequential(do1, do2);

//Merge 2 files.
completefile := fFixeddate;

//Distribute File for Sort
BusIn_dist := distribute(completefile, hash(COMPANY_NAME));

//Sort File
BusIn_srt  := sort(BusIn_dist, OFC1_NAME,
OFC1_TITLE,
FIRST_NAME,
MI,
LAST_NAME,
SUFFIX,
GENDER,
OWNR_CODE,
XCODE,
COMPANY_NAME,
MAIL_ADD,
MAIL_SUITE,
MAIL_CITY,
MAIL_STATE,
MAIL_ZIP_ORIG,
MAIL_ZIP4_ORIG,
MAIL_KEY,
COUNTY,
COUNTRY,
DISTRICT,
CITYLIMITS,
BIZ_AC,
BIZ_PHONE,
FAX_AC,
FAX_NUM,
SIC,
NAICS,
DESCRIPT,
EMP_SIZE,
OWN_SIZE,
CORPCODE,
SOS_CODE,
FILING_COD,
STATE_CODE,
STATUS,
STAT_DES,
LIC_STS,
LIC_TYPE,
FILING_NUM,
LICID,
ACCT_NUM,
CO_FEI,
CTRL_NUM,
START_DATE,
FILE_DATE,
CCYYMMDD,
FORM_DATE,
EXP_DATE,
DISOL_DATE,
RPT_DATE,
RENEW_DATE,
CHANG_DATE,
APPT_DATE,
FISC_DATE_,
DURATION,
LOC_ADD,
LOC_SUITE,
LOC_CITY,
LOC_STATE,
LOC_ZIP_ORIG,
LOC_ZIP4_ORIG,
LOC_IDX,
OFC1_ADD,
OFC1_SUITE,
OFC1_CITY,
OFC1_STATE,
OFC1_ZIP_ORIG,
OFC1_AC,
OFC1_PHONE,
OFC1_FEIN,
OFC1_SSN,
OFC1_TYPE,
OFC2_NAME,
OFC2_TITLE,
OFC2_ADD,
OFC2_CSZ,
OFC2_FEIN,
OFC2_SSN,
OFC3_NAME,
OFC3_TITLE,
OFC3_ADD,
OFC3_CSZ,
OFC3_FEIN,
OFC3_SSN,
OFC4_NAME,
OFC4_TITLE,
OFC4_ADD,
OFC4_CSZ,
OFC4_FEIN,
OFC4_SSN,
OFC5_NAME,
OFC5_TITLE,
OFC5_ADD,
OFC5_CSZ,
OFC5_FEIN,
OFC5_SSN,
OFC6_NAME,
OFC6_TITLE,
OFC6_ADD,
OFC6_CSZ,
OFC6_FEIN,
OFC6_SSN,
RA_DATE,
RA_FILE,
RA_NAME,
RA_ADD,
RA_SUITE,
RA_CITY,
RA_STATE,
RA_ZIP_ORIG,
RA_AC,
RA_PHONE,
CLASS,
STOCK_ISS,
STOCK_PAR,
STOCK_TYPE,
STOCK_CAP,
PAIDN_CAP,
FEE,
FEE_2,
FEE_3,
TAX_CL,
ACT,
CHAPTER,
PAGE,
VOLUME,
COMMENTS,
EMAIL_ADDR,
USER_NAME,
DSF,
HMBASE,
HO,
SOLICIT,
FIPS,
RECORD_NO,
MISC_CODE,
AGENT_KEY,
PROC_DATE,
local);
 
//RollUp Sprayed file from Ab Initio Process into Previous file on Thor.
Layout_BusReg_In  rollupXform(Layout_BusReg_In l, Layout_BusReg_In r) := transform
  		self.date_first_seen := if(l.date_first_seen > r.date_first_seen, r.date_first_seen, l.date_first_seen);
      	self.date_last_seen  := if(l.date_last_seen  < r.date_last_seen,  r.date_last_seen,  l.date_last_seen);
      	self := l;
		end;
		
mapping_BusRegIn := rollup(BusIn_srt,rollupXform(LEFT,RIGHT),OFC1_NAME,
OFC1_TITLE,
FIRST_NAME,
MI,
LAST_NAME,
SUFFIX,
GENDER,
OWNR_CODE,
XCODE,
COMPANY_NAME,
MAIL_ADD,
MAIL_SUITE,
MAIL_CITY,
MAIL_STATE,
MAIL_ZIP_ORIG,
MAIL_ZIP4_ORIG,
MAIL_KEY,
COUNTY,
COUNTRY,
DISTRICT,
CITYLIMITS,
BIZ_AC,
BIZ_PHONE,
FAX_AC,
FAX_NUM,
SIC,
NAICS,
DESCRIPT,
EMP_SIZE,
OWN_SIZE,
CORPCODE,
SOS_CODE,
FILING_COD,
STATE_CODE,
STATUS,
STAT_DES,
LIC_STS,
LIC_TYPE,
FILING_NUM,
LICID,
ACCT_NUM,
CO_FEI,
CTRL_NUM,
START_DATE,
FILE_DATE,
CCYYMMDD,
FORM_DATE,
EXP_DATE,
DISOL_DATE,
RPT_DATE,
RENEW_DATE,
CHANG_DATE,
APPT_DATE,
FISC_DATE_,
DURATION,
LOC_ADD,
LOC_SUITE,
LOC_CITY,
LOC_STATE,
LOC_ZIP_ORIG,
LOC_ZIP4_ORIG,
LOC_IDX,
OFC1_ADD,
OFC1_SUITE,
OFC1_CITY,
OFC1_STATE,
OFC1_ZIP_ORIG,
OFC1_AC,
OFC1_PHONE,
OFC1_FEIN,
OFC1_SSN,
OFC1_TYPE,
OFC2_NAME,
OFC2_TITLE,
OFC2_ADD,
OFC2_CSZ,
OFC2_FEIN,
OFC2_SSN,
OFC3_NAME,
OFC3_TITLE,
OFC3_ADD,
OFC3_CSZ,
OFC3_FEIN,
OFC3_SSN,
OFC4_NAME,
OFC4_TITLE,
OFC4_ADD,
OFC4_CSZ,
OFC4_FEIN,
OFC4_SSN,
OFC5_NAME,
OFC5_TITLE,
OFC5_ADD,
OFC5_CSZ,
OFC5_FEIN,
OFC5_SSN,
OFC6_NAME,
OFC6_TITLE,
OFC6_ADD,
OFC6_CSZ,
OFC6_FEIN,
OFC6_SSN,
RA_DATE,
RA_FILE,
RA_NAME,
RA_ADD,
RA_SUITE,
RA_CITY,
RA_STATE,
RA_ZIP_ORIG,
RA_AC,
RA_PHONE,
CLASS,
STOCK_ISS,
STOCK_PAR,
STOCK_TYPE,
STOCK_CAP,
PAIDN_CAP,
FEE,
FEE_2,
FEE_3,
TAX_CL,
ACT,
CHAPTER,
PAGE,
VOLUME,
COMMENTS,
EMAIL_ADDR,
USER_NAME,
DSF,
HMBASE,
HO,
SOLICIT,
FIPS,
RECORD_NO,
MISC_CODE,
AGENT_KEY,
PROC_DATE,
local);

//Create Update File
create_updatefile := output(mapping_BusRegIn,,'~thor_data400::in::accutrend_fbn_'+filedate,overwrite,__compressed__);

//Add Newly Created Update File to In SuperFile
add_updatefile := sequential(fileservices.addsuperfile('~thor_data400::in::delete::accutrend_fbn','~thor_data400::in::grandfather::accutrend_fbn',,true),
										fileservices.clearsuperfile('~thor_data400::in::grandfather::accutrend_fbn'),
										fileservices.addsuperfile('~thor_data400::in::grandfather::accutrend_fbn','~thor_data400::in::father::accutrend_fbn',,true),
										fileservices.clearsuperfile('~thor_data400::in::father::accutrend_fbn'),
										fileservices.addsuperfile('~thor_data400::in::father::accutrend_fbn','~thor_data400::in::accutrend_fbn',,true),
										fileservices.clearsuperfile('~thor_data400::in::accutrend_fbn'),
										fileservices.addsuperfile('~thor_data400::in::accutrend_fbn','~thor_data400::in::accutrend_fbn_'+filedate),
										fileservices.clearsuperfile('~thor_data400::in::delete::accutrend_fbn',true));
/*								
add_updatefile := sequential(fileservices.clearsuperfile('~thor_data400::in::accutrend_fbn',true)
										,fileservices.addsuperfile('~thor_data400::in::accutrend_fbn','~thor_data400::in::accutrend_fbn_'+filedate,,true));
*/
retval := sequential(spray_file
							,create_updatefile
							,add_updatefile);
return retval  ;
end;