import ATF,MDR;

export ATF_AsMasters := module(Interface_AsMasters.Unlinked.Default)

	shared base := ATF.file_firearms_explosives_base;
	
	export dataset(Layout_Linking.Unlinked) As_Linking_Master := function
		
		extract_1 := normalize(base(license1_cname != ''),if(left.mail_v_city_name != left.mail_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.license1_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.mail_prim_range,
				self.predir := left.mail_predir,
				self.prim_name := left.mail_prim_name,
				self.addr_suffix := left.mail_suffix,
				self.postdir := left.mail_postdir,
				self.unit_desig := left.mail_unit_desig,
				self.sec_range := left.mail_sec_range,
				self.city_name := choose(counter,
					left.mail_p_city_name,
					left.mail_v_city_name),
				self.state := left.mail_st,
				self.zip := left.mail_zip,
				self.county_fips := left.mail_fips_county,
				self.msa := left.mail_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		extract_2 := normalize(base(license1_cname != ''),if(left.premise_v_city_name != left.premise_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.license1_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.premise_prim_range,
				self.predir := left.premise_predir,
				self.prim_name := left.premise_prim_name,
				self.addr_suffix := left.premise_suffix,
				self.postdir := left.premise_postdir,
				self.unit_desig := left.premise_unit_desig,
				self.sec_range := left.premise_sec_range,
				self.city_name := choose(counter,
					left.premise_p_city_name,
					left.premise_v_city_name),
				self.state := left.premise_st,
				self.zip := left.premise_zip,
				self.county_fips := left.premise_fips_county,
				self.msa := left.premise_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		extract_3 := normalize(base(license2_cname != ''),if(left.mail_v_city_name != left.mail_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.license2_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.mail_prim_range,
				self.predir := left.mail_predir,
				self.prim_name := left.mail_prim_name,
				self.addr_suffix := left.mail_suffix,
				self.postdir := left.mail_postdir,
				self.unit_desig := left.mail_unit_desig,
				self.sec_range := left.mail_sec_range,
				self.city_name := choose(counter,
					left.mail_p_city_name,
					left.mail_v_city_name),
				self.state := left.mail_st,
				self.zip := left.mail_zip,
				self.county_fips := left.mail_fips_county,
				self.msa := left.mail_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		extract_4 := normalize(base(license2_cname != ''),if(left.premise_v_city_name != left.premise_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.license2_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.premise_prim_range,
				self.predir := left.premise_predir,
				self.prim_name := left.premise_prim_name,
				self.addr_suffix := left.premise_suffix,
				self.postdir := left.premise_postdir,
				self.unit_desig := left.premise_unit_desig,
				self.sec_range := left.premise_sec_range,
				self.city_name := choose(counter,
					left.premise_p_city_name,
					left.premise_v_city_name),
				self.state := left.premise_st,
				self.zip := left.premise_zip,
				self.county_fips := left.premise_fips_county,
				self.msa := left.premise_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		extract_5 := normalize(base(business_cname != ''),if(left.mail_v_city_name != left.mail_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.business_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.mail_prim_range,
				self.predir := left.mail_predir,
				self.prim_name := left.mail_prim_name,
				self.addr_suffix := left.mail_suffix,
				self.postdir := left.mail_postdir,
				self.unit_desig := left.mail_unit_desig,
				self.sec_range := left.mail_sec_range,
				self.city_name := choose(counter,
					left.mail_p_city_name,
					left.mail_v_city_name),
				self.state := left.mail_st,
				self.zip := left.mail_zip,
				self.county_fips := left.mail_fips_county,
				self.msa := left.mail_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		extract_6 := normalize(base(business_cname != ''),if(left.premise_v_city_name != left.premise_p_city_name,2,1),
			transform(Layout_Linking.Unlinked,
				self.source := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid := left.license_number,
				self.source_party := '',
				self.date_first_seen := (unsigned4)left.date_first_seen,
				self.date_last_seen := (unsigned4)left.date_last_seen,
				self.company_name := left.business_cname,
				self.company_name_type := Constants.Company_Name_Types.UNKNOWN,
				self.address_type := Constants.Address_Types.UNKNOWN,
				self.phone_type := Constants.Phone_Types.UNKNOWN,
				self.aid := 0,
				self.prim_range := left.premise_prim_range,
				self.predir := left.premise_predir,
				self.prim_name := left.premise_prim_name,
				self.addr_suffix := left.premise_suffix,
				self.postdir := left.premise_postdir,
				self.unit_desig := left.premise_unit_desig,
				self.sec_range := left.premise_sec_range,
				self.city_name := choose(counter,
					left.premise_p_city_name,
					left.premise_v_city_name),
				self.state := left.premise_st,
				self.zip := left.premise_zip,
				self.county_fips := left.premise_fips_county,
				self.msa := left.premise_msa,
				self.phone := left.voice_phone,
				self.fein := '',
				self.url := '',
				self.duns := '',
				self.experian := '',
				self.zoom := '',
				self.incorp_state := '',
				self.incorp_number := ''));		
		
		return extract_1 + extract_2 + extract_3 + extract_4 + extract_5 + extract_6;	
		
	end;
	
	export dataset(Layout_License.Unlinked) As_License_Master := function
		
		extract := project(base,
			transform(Layout_License.Unlinked,
				self.source            := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid      := left.license_number,
				self.source_party      := '',
				self.license_state     := '',
				self.license_board     := 'US ATF',
				self.license_number    := left.license_number;
				self.license_type      := if(left.record_type = 'F','Federal Firearms','Federal Explosives'),
				self.license_status    := '',
				self.issue_date        := '';
				self.last_renewal_date := '';
				self.expiration_date   := '';
				self.company_name      := left.license1_cname;
				));		
		return extract;
	end;	

	export dataset(Layout_Contacts.Unlinked) As_Contact_Master := function
	
		extract_1 := project(base,
			transform(Layout_Contacts.Unlinked,
				self.source            := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid      := left.license_number,
				self.source_party      := '',
				self.date_first_seen   := (unsigned4)left.date_first_seen,
				self.date_last_seen    := (unsigned4)left.date_last_seen,
				self.name_prefix       := left.license1_title,
				self.name_first        := left.license1_fname,
				self.name_middle       := left.license1_mname,
				self.name_last         := left.license1_lname,
				self.name_suffix       := left.license1_name_suffix,
				self.position_title    := 'ATF License Contact',
				self := []));
		
		extract_2 := project(base,
			transform(Layout_Contacts.Unlinked,
				self.source            := if(left.record_type = 'F',MDR.sourceTools.src_Federal_Firearms,MDR.sourceTools.src_Federal_Explosives),
				self.source_docid      := left.license_number,
				self.source_party      := '',
				self.date_first_seen   := (unsigned4)left.date_first_seen,
				self.date_last_seen    := (unsigned4)left.date_last_seen,
				self.name_prefix       := left.license2_title,
				self.name_first        := left.license2_fname,
				self.name_middle       := left.license2_mname,
				self.name_last         := left.license2_lname,
				self.name_suffix       := left.license2_name_suffix,
				self.position_title    := 'ATF License Contact',
				self := []));
		
		combined_extracts := extract_1 + extract_2;
		
		return combined_extracts(name_last != '');
	
	end;
	
end;
