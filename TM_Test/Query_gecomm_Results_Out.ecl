//f := TM_Test.gecomm_prep;
f := dataset('TMTEST::gecomm_prep', TM_Test.layout_gecomm_base, flat);

// Extract list of BDIDs and account numbers
layout_bdid_list := record
f.bdid;
f.account;
end;

bdid_list := dedup(table(f(bdid <> 0), layout_bdid_list),all);

// combined record 
layout_gecomm_combined := record
string9 ACCOUNT;
unsigned1 PRScore := 0;
  unsigned integer6 bdid;
  unsigned integer3 zip;
  qstring28 prim_name;
  qstring10 prim_range;
  unsigned integer4 bdid_per_addr;
  unsigned integer4 apts;
  unsigned integer4 ppl;
  unsigned integer4 r_phone_per_addr;
  unsigned integer4 b_phone_per_addr;
  unsigned integer4 dnb_emps;
  unsigned integer4 irs5500_emps;
  unsigned integer4 domainss;
  unsigned integer1 sources;
  unsigned integer1 company_name_score;
  unsigned integer1 combined_score;
  unsigned integer4 gong_yp_cnt;
  unsigned integer4 current_corp_cnt;
  unsigned integer4 dt_first_seen_min;
  unsigned integer4 dt_last_seen_max;
  unsigned integer4 dt_vendor_first_reported_min;
  unsigned integer4 dt_first_seen_y;
  unsigned4 dt_last_seen_Y;
  unsigned4 dt_first_seen_G;
  unsigned4 dt_last_seen_G;
  unsigned4 dt_first_seen_C;
  unsigned4 dt_last_seen_C;
  unsigned4 dt_first_seen_BR;
  unsigned4 dt_last_seen_BR;
  unsigned4 dt_first_seen_UCC;
  unsigned4 dt_last_seen_UCC;
  unsigned4 dt_first_seen_D;
  unsigned4 dt_last_seen_D;
  unsigned4 dt_first_seen_I;
  unsigned4 dt_last_seen_I;
  unsigned4 dt_first_seen_ST;
  unsigned4 dt_last_seen_ST;
  unsigned4 dt_last_seen_B;
  unsigned4 dt_last_seen_LJ;
  unsigned4 dt_first_seen_BM;
  unsigned4 dt_last_seen_BM;
  unsigned4 dt_first_seen_BN;
  unsigned4 dt_last_seen_BN;
  unsigned4 dt_first_seen_IA;
  unsigned4 dt_last_seen_IA;
  unsigned4 dt_first_seen_DC;
  unsigned4 dt_last_seen_DC;
  unsigned4 dt_first_seen_EB;
  unsigned4 dt_last_seen_EB;
  string1 gong_current_record_flag;  
  unsigned4 gong_deletion_date;
  unsigned2 gong_disc_cnt6;
  unsigned2 gong_disc_cnt12;
  unsigned2 gong_disc_cnt18;
  unsigned integer3 cnt_base;
  unsigned2 cnt_AE;
  unsigned2 cnt_AF;
  unsigned2 cnt_AT;
  unsigned2 cnt_AW;
  unsigned2 cnt_B;
  unsigned2 cnt_BM;
  unsigned2 cnt_BN;
  unsigned2 cnt_BR;
  unsigned2 cnt_C;
  unsigned2 cnt_CU;
  unsigned2 cnt_D;
  unsigned2 cnt_DC;
  unsigned2 cnt_DE;
  unsigned2 cnt_E;
  unsigned2 cnt_EB;
  unsigned2 cnt_ED;
  unsigned2 cnt_F;
  unsigned2 cnt_FA;
  unsigned2 cnt_FC;
  unsigned2 cnt_FD;
  unsigned2 cnt_FF;
  unsigned2 cnt_FN;
  unsigned2 cnt_GB;
  unsigned2 cnt_GG;
  unsigned2 cnt_I;
  unsigned2 cnt_IA;
  unsigned2 cnt_ID;
  unsigned2 cnt_IF;
  unsigned2 cnt_II;
  unsigned2 cnt_IN;
  unsigned2 cnt_LJ;
  unsigned2 cnt_LB;
  unsigned2 cnt_LP;
  unsigned2 cnt_MD;
  unsigned2 cnt_MV;
  unsigned2 cnt_PL;
  unsigned2 cnt_PR;
  unsigned2 cnt_SB;
  unsigned2 cnt_SK;
  unsigned2 cnt_ST;
  unsigned3 cnt_U;
  unsigned2 cnt_V;
  unsigned2 cnt_W;
  unsigned2 cnt_WC;
  unsigned2 cnt_WT;
  unsigned2 cnt_Y;
  unsigned4 PRScore_date := 0;
  unsigned1 busreg_flag := 0;
  unsigned1 corp_flag := 0;
  unsigned1 dnb_flag := 0;
  unsigned1 irs5500_flag := 0;
  unsigned1 st_flag := 0;
  unsigned1 ucc_flag := 0;
  unsigned1 yp_flag := 0;
  unsigned1 tier1srcs := 0;
  unsigned1 t1scr5 := 0;
  unsigned1 currphn := 0;
  unsigned1 currcorp := 0;
  unsigned1 currbr := 0;
  unsigned1 currdnb := 0;
  unsigned1 currucc := 0;
  unsigned1 curry := 0;
  unsigned1 currt1cnt := 0;
  unsigned1 currt1src4 := 0;
  unsigned2 year_lj := 0;
  unsigned1 lj := 0;
  unsigned1 ustic := 0;
  unsigned1 t1x := 0;
  unsigned2 OFAC_cnt := 0;
end;

// Join to BDID Table to get stats
gecomm_stats := join(Business_Risk.BDID_Table,
                     bdid_list,
				 left.bdid = right.bdid,
				 transform(layout_gecomm_combined, self.ACCOUNT := right.ACCOUNT, self := left),
				 hash);

brt := Business_Risk.BDID_Risk_Table;
			
layout_gecomm_combined AppendRiskData(layout_gecomm_combined l, brt r) := transform
self := r;
self := l;
end;

			
// Append risk data and score
gecomm_score := join(gecomm_stats,
                     brt,
				 left.bdid = right.bdid,
				 AppendRiskData(left, right),
				 hash);
				
				
// Project to fixed width
layout_gecomm_out := record
string14 ACCOUNT;
string3  PRScore := '';
string12 bdid;
string5  zip;
string28 prim_name;
string10 prim_range;
string4 bdid_per_addr;
string4 apts;
string4 ppl;
string4 r_phone_per_addr;
string4 b_phone_per_addr;
string4 dnb_emps;
string4 irs5500_emps;
string4 domainss;
string4 sources;
string3 company_name_score;
string3 combined_score;
string4 gong_yp_cnt;
string4 current_corp_cnt;
string8 dt_first_seen_min;
string8 dt_last_seen_max;
string8 dt_vendor_first_reported_min;
string8 dt_first_seen_y;
string8 dt_last_seen_Y;
string8 dt_first_seen_G;
string8 dt_last_seen_G;
string8 dt_first_seen_C;
string8 dt_last_seen_C;
string8 dt_first_seen_BR;
string8 dt_last_seen_BR;
string8 dt_first_seen_UCC;
string8 dt_last_seen_UCC;
string8 dt_first_seen_D;
string8 dt_last_seen_D;
string8 dt_first_seen_I;
string8 dt_last_seen_I;
string8 dt_first_seen_ST;
string8 dt_last_seen_ST;
string8 dt_last_seen_B;
string8 dt_last_seen_LJ;
string8 dt_first_seen_BM;
string8 dt_last_seen_BM;
string8 dt_first_seen_BN;
string8 dt_last_seen_BN;
string8 dt_first_seen_IA;
string8 dt_last_seen_IA;
string8 dt_first_seen_DC;
string8 dt_last_seen_DC;
string8 dt_first_seen_EB;
string8 dt_last_seen_EB;
string1 gong_current_record_flag;  
string8 gong_deletion_date;
string4 gong_disc_cnt6;
string4 gong_disc_cnt12;
string4 gong_disc_cnt18;
string8  cnt_base;
string4 cnt_AE;
string4 cnt_AF;
string4 cnt_AT;
string4 cnt_AW;
string4 cnt_B;
string4 cnt_BM;
string4 cnt_BN;
string4 cnt_BR;
string4 cnt_C;
string4 cnt_CU;
string4 cnt_D;
string4 cnt_DC;
string4 cnt_DE;
string4 cnt_E;
string4 cnt_EB;
string4 cnt_ED;
string4 cnt_F;
string4 cnt_FA;
string4 cnt_FC;
string4 cnt_FD;
string4 cnt_FF;
string4 cnt_FN;
string4 cnt_GB;
string4 cnt_GG;
string4 cnt_I;
string4 cnt_IA;
string4 cnt_ID;
string4 cnt_IF;
string4 cnt_II;
string4 cnt_IN;
string4 cnt_LJ;
string4 cnt_LB;
string4 cnt_LP;
string4 cnt_MD;
string4 cnt_MV;
string4 cnt_PL;
string4 cnt_PR;
string4 cnt_SB;
string4 cnt_SK;
string4 cnt_ST;
string8 cnt_U;
string4 cnt_V;
string4 cnt_W;
string4 cnt_WC;
string4 cnt_WT;
string4 cnt_Y;
string8 PRScore_date;
string1 busreg_flag;
string1 corp_flag;
string1 dnb_flag;
string1 irs5500_flag;
string1 st_flag;
string1 ucc_flag;
string1 yp_flag;
string1 tier1srcs;
string1 t1scr5;
string1 currphn;
string1 currcorp;
string1 currbr;
string1 currdnb;
string1 currucc;
string1 curry;
string1 currt1cnt;
string1 currt1src4;
string4 year_lj;
string1 lj;
string1 ustic;
string1 t1x;
string4 OFAC_cnt;
end;

layout_gecomm_out FormatOutput(layout_gecomm_combined l) := transform
self.ACCOUNT := l.ACCOUNT;
self.PRScore := intformat(l.PRScore, 3, 1);
self.bdid := intformat(l.bdid, 12, 1);
self.zip := intformat(l.zip, 5, 1);
self.prim_name := l.prim_name;
self.prim_range := l.prim_range;
self.bdid_per_addr := intformat(l.bdid_per_addr, 4, 1);
self.apts := intformat(l.apts, 4, 1);
self.ppl := intformat(l.ppl, 4, 1);
self.r_phone_per_addr := intformat(l.r_phone_per_addr, 4, 1);
self.b_phone_per_addr := intformat(l.b_phone_per_addr, 4, 1);
self.dnb_emps := intformat(l.dnb_emps, 4, 1);
self.irs5500_emps := intformat(l.irs5500_emps, 4, 1);
self.domainss := intformat(l.domainss, 4, 1);
self.sources := intformat(l.sources, 4, 1);
self.company_name_score := intformat(l.company_name_score, 3, 1);
self.combined_score := intformat(l.combined_score, 3, 1);
self.gong_yp_cnt := intformat(l.gong_yp_cnt, 4, 1);
self.current_corp_cnt := intformat(l.current_corp_cnt, 4, 1);
self.dt_first_seen_min := intformat(l.dt_first_seen_min, 8, 1);
self.dt_last_seen_max := intformat(l.dt_last_seen_max, 8, 1);
self.dt_vendor_first_reported_min := intformat(l.dt_vendor_first_reported_min, 8, 1);
self.dt_first_seen_y := intformat(l.dt_first_seen_y, 8, 1);
self.dt_last_seen_Y := intformat(l.dt_last_seen_Y, 8, 1);
self.dt_first_seen_G := intformat(l.dt_first_seen_G, 8, 1);
self.dt_last_seen_G := intformat(l.dt_last_seen_G, 8, 1);
self.dt_first_seen_C := intformat(l.dt_first_seen_C, 8, 1);
self.dt_last_seen_C := intformat(l.dt_last_seen_C, 8, 1);
self.dt_first_seen_BR := intformat(l.dt_first_seen_BR, 8, 1);
self.dt_last_seen_BR := intformat(l.dt_last_seen_BR, 8, 1);
self.dt_first_seen_UCC := intformat(l.dt_first_seen_UCC, 8, 1);
self.dt_last_seen_UCC := intformat(l.dt_last_seen_UCC, 8, 1);
self.dt_first_seen_D := intformat(l.dt_first_seen_D, 8, 1);
self.dt_last_seen_D := intformat(l.dt_last_seen_D, 8, 1);
self.dt_first_seen_I := intformat(l.dt_first_seen_I, 8, 1);
self.dt_last_seen_I := intformat(l.dt_last_seen_I, 8, 1);
self.dt_first_seen_ST := intformat(l.dt_first_seen_ST, 8, 1);
self.dt_last_seen_ST := intformat(l.dt_last_seen_ST, 8, 1);
self.dt_last_seen_B := intformat(l.dt_last_seen_B, 8, 1);
self.dt_last_seen_LJ := intformat(l.dt_last_seen_LJ, 8, 1);
self.dt_first_seen_BM := intformat(l.dt_first_seen_BM, 8, 1);
self.dt_last_seen_BM := intformat(l.dt_last_seen_BM, 8, 1);
self.dt_first_seen_BN := intformat(l.dt_first_seen_BN, 8, 1);
self.dt_last_seen_BN := intformat(l.dt_last_seen_BN, 8, 1);
self.dt_first_seen_IA := intformat(l.dt_first_seen_IA, 8, 1);
self.dt_last_seen_IA := intformat(l.dt_last_seen_IA, 8, 1);
self.dt_first_seen_DC := intformat(l.dt_first_seen_DC, 8, 1);
self.dt_last_seen_DC := intformat(l.dt_last_seen_DC, 8, 1);
self.dt_first_seen_EB := intformat(l.dt_first_seen_EB, 8, 1);
self.dt_last_seen_EB := intformat(l.dt_last_seen_EB, 8, 1);
self.gong_current_record_flag := l.gong_current_record_flag;  
self.gong_deletion_date := intformat(l.gong_deletion_date, 8, 1);
self.gong_disc_cnt6 := intformat(l.gong_disc_cnt6, 4, 1);
self.gong_disc_cnt12 := intformat(l.gong_disc_cnt12, 4, 1);
self.gong_disc_cnt18 := intformat(l.gong_disc_cnt18, 4, 1);
self.cnt_base := intformat(l.cnt_base, 8, 1);
self.cnt_AE := intformat(l.cnt_AE, 4, 1);
self.cnt_AF := intformat(l.cnt_AF, 4, 1);
self.cnt_AT := intformat(l.cnt_AT, 4, 1);
self.cnt_AW := intformat(l.cnt_AW, 4, 1);
self.cnt_B := intformat(l.cnt_B, 4, 1);
self.cnt_BM := intformat(l.cnt_BM, 4, 1);
self.cnt_BN := intformat(l.cnt_BN, 4, 1);
self.cnt_BR := intformat(l.cnt_BR, 4, 1);
self.cnt_C := intformat(l.cnt_C, 4, 1);
self.cnt_CU := intformat(l.cnt_CU, 4, 1);
self.cnt_D := intformat(l.cnt_D, 4, 1);
self.cnt_DC := intformat(l.cnt_DC, 4, 1);
self.cnt_DE := intformat(l.cnt_DE, 4, 1);
self.cnt_E := intformat(l.cnt_E, 4, 1);
self.cnt_EB := intformat(l.cnt_EB, 4, 1);
self.cnt_ED := intformat(l.cnt_ED, 4, 1);
self.cnt_F := intformat(l.cnt_F, 4, 1);
self.cnt_FA := intformat(l.cnt_FA, 4, 1);
self.cnt_FC := intformat(l.cnt_FC, 4, 1);
self.cnt_FD := intformat(l.cnt_FD, 4, 1);
self.cnt_FF := intformat(l.cnt_FF, 4, 1);
self.cnt_FN := intformat(l.cnt_FN, 4, 1);
self.cnt_GB := intformat(l.cnt_GB, 4, 1);
self.cnt_GG := intformat(l.cnt_GG, 4, 1);
self.cnt_I := intformat(l.cnt_I, 4, 1);
self.cnt_IA := intformat(l.cnt_IA, 4, 1);
self.cnt_ID := intformat(l.cnt_ID, 4, 1);
self.cnt_IF := intformat(l.cnt_IF, 4, 1);
self.cnt_II := intformat(l.cnt_II, 4, 1);
self.cnt_IN := intformat(l.cnt_IN, 4, 1);
self.cnt_LJ := intformat(l.cnt_LJ, 4, 1);
self.cnt_LB := intformat(l.cnt_LB, 4, 1);
self.cnt_LP := intformat(l.cnt_LP, 4, 1);
self.cnt_MD := intformat(l.cnt_MD, 4, 1);
self.cnt_MV := intformat(l.cnt_MV, 4, 1);
self.cnt_PL := intformat(l.cnt_PL, 4, 1);
self.cnt_PR := intformat(l.cnt_PR, 4, 1);
self.cnt_SB := intformat(l.cnt_SB, 4, 1);
self.cnt_SK := intformat(l.cnt_SK, 4, 1);
self.cnt_ST := intformat(l.cnt_ST, 4, 1);
self.cnt_U := intformat(l.cnt_U, 8, 1);
self.cnt_V := intformat(l.cnt_V, 4, 1);
self.cnt_W := intformat(l.cnt_W, 4, 1);
self.cnt_WC := intformat(l.cnt_WC, 4, 1);
self.cnt_WT := intformat(l.cnt_WT, 4, 1);
self.cnt_Y := intformat(l.cnt_Y, 4, 1);
self.PRScore_date := intformat(l.PRScore_date, 8, 1);
self.busreg_flag := intformat(l.busreg_flag, 1, 1);
self.corp_flag := intformat(l.corp_flag, 1, 1);
self.dnb_flag := intformat(l.dnb_flag, 1, 1);
self.irs5500_flag := intformat(l.irs5500_flag, 1, 1);
self.st_flag := intformat(l.st_flag, 1, 1);
self.ucc_flag := intformat(l.ucc_flag, 1, 1);
self.yp_flag := intformat(l.yp_flag, 1, 1);
self.tier1srcs := intformat(l.tier1srcs, 1, 1);
self.t1scr5 := intformat(l.t1scr5, 1, 1);
self.currphn := intformat(l.currphn, 1, 1);
self.currcorp := intformat(l.currcorp, 1, 1);
self.currbr := intformat(l.currbr, 1, 1);
self.currdnb := intformat(l.currdnb, 1, 1);
self.currucc := intformat(l.currucc, 1, 1);
self.curry := intformat(l.curry, 1, 1);
self.currt1cnt := intformat(l.currt1cnt, 1, 1);
self.currt1src4 := intformat(l.currt1src4, 1, 1);
self.year_lj := intformat(l.year_lj, 4, 1);
self.lj := intformat(l.lj, 1, 1);
self.ustic := intformat(l.ustic, 1, 1);
self.t1x := intformat(l.t1x, 1, 1);
self.OFAC_cnt := intformat(l.OFAC_cnt, 4, 1);
end;

gecomm_out := project(gecomm_score, FormatOutput(left));

output(sort(gecomm_out, ACCOUNT),,'OUT::gecomm_results',overwrite);
