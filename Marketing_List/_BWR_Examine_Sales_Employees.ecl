/*
  2. annual revenue and number of employees keep as integer.  

  Do query to find out how many times they send zero instead of just blank for those two fields.  

*/

pdca_base              := Marketing_List.Source_Files().dca       ;              
peq_biz_base           := Marketing_List.Source_Files().eq_biz    ;          
poshair_base           := Marketing_List.Source_Files().oshair    ;          
pcortera_base          := Marketing_List.Source_Files().cortera   ;           
pinfutor_base          := Marketing_List.Source_Files().infutor   ;           
paccutrend_base        := Marketing_List.Source_Files().accutrend ;          

// ds_dca_base_filt       := ds_dca_base                (seleid != 0  ,trim(rawfields.emp_num           ) != '' or  (trim(rawfields.Sales ) != '' and regexfind('(revenue|sales)',rawfields.Sales_Desc,nocase)));
// ds_eq_biz_base_filt    := ds_eq_biz_base             (seleid != 0  ,trim(efx_corpempcnt              ) != '' or  (trim(efx_corpamount  ) != '' and regexfind('(revenue|sales)',efx_corpamounttp     ,nocase)));
// ds_oshair_base_filt    := ds_oshair_base             (seleid != 0  ,(integer)Number_In_Establishment             > 0 );
// ds_cortera_base_filt   := ds_cortera_base_normexec   (seleid != 0  ,(integer)trim(TOTAL_EMPLOYEES             )  > 0 or   trim(TOTAL_SALES     ) != '');
// ds_infutor_base_filt   := ds_infutor_base            (seleid != 0  ,         trim(employee_code               ) != '');
// ds_accutrend_base_filt := ds_accutrend_base          (seleid != 0  ,(integer)trim(rawfields.EMP_SIZE          )  > 0 );
ds_dca_base_prep       := table(pdca_base                                                              ,{typeof(rawfields.emp_num      )   emp_num := rawfields.emp_num      ,typeof(rawfields.Sales        )   sales   := rawfields.Sales   ,rawfields.Sales_Desc } );
ds_eq_biz_base_prep    := table(peq_biz_base                                                           ,{typeof(efx_corpempcnt         )   emp_num := efx_corpempcnt         ,typeof(efx_corpamount         )   sales   := efx_corpamount    ,efx_corpamounttp     } );
ds_oshair_base_prep    := table(poshair_base                                                           ,{typeof(Number_In_Establishment)   emp_num := Number_In_Establishment                                                                 } );
ds_cortera_base_prep   := table(pcortera_base                                                          ,{typeof(TOTAL_EMPLOYEES        )   emp_num := TOTAL_EMPLOYEES        ,typeof(TOTAL_SALES            )   sales   := TOTAL_SALES        } );
ds_infutor_base_prep   := table(pinfutor_base                                                          ,{typeof(employee_code          )   emp_num := employee_code                                                                           } );
ds_accutrend_base_prep := table(paccutrend_base                                                        ,{typeof(rawfields.EMP_SIZE     )   emp_num := rawfields.EMP_SIZE                                                                      } );


ds_dca_base_table_emp       := table(ds_dca_base_prep       ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);
ds_dca_base_table_sales     := table(ds_dca_base_prep       (regexfind('(revenue|sales)',Sales_Desc,nocase)),{sales      ,unsigned cnt := count(group)} ,Sales    ,merge);
ds_eq_biz_base_table_emp    := table(ds_eq_biz_base_prep    ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);
ds_eq_biz_base_table_sales  := table(ds_eq_biz_base_prep    (regexfind('(revenue|sales)',efx_corpamounttp,nocase)),{sales      ,unsigned cnt := count(group)} ,Sales    ,merge);
ds_oshair_base_table_emp    := table(ds_oshair_base_prep    ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);
ds_cortera_base_table_emp   := table(ds_cortera_base_prep   ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);
ds_cortera_base_table_sales := table(ds_cortera_base_prep   ,{sales      ,unsigned cnt := count(group)} ,Sales    ,merge);
ds_infutor_base_table_emp   := table(ds_infutor_base_prep   ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);
ds_accutrend_base_table_emp := table(ds_accutrend_base_prep ,{emp_num    ,unsigned cnt := count(group)} ,emp_num  ,merge);

output(topn(ds_dca_base_table_emp        ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_dca_base_table_emp'        )  ,all);
output(topn(ds_dca_base_table_sales      ,300  ,if((integer)sales   = 0  ,0,1 ),-cnt) ,named('ds_dca_base_table_sales'      )  ,all);
output(topn(ds_eq_biz_base_table_emp     ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_eq_biz_base_table_emp'     )  ,all);
output(topn(ds_eq_biz_base_table_sales   ,300  ,if((integer)sales   = 0  ,0,1 ),-cnt) ,named('ds_eq_biz_base_table_sales'   )  ,all);
output(topn(ds_oshair_base_table_emp     ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_oshair_base_table_emp'     )  ,all);
output(topn(ds_cortera_base_table_emp    ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_cortera_base_table_emp'    )  ,all);
output(topn(ds_cortera_base_table_sales  ,300  ,if((integer)sales   = 0  ,0,1 ),-cnt) ,named('ds_cortera_base_table_sales'  )  ,all);
output(topn(ds_infutor_base_table_emp    ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_infutor_base_table_emp'    )  ,all);
output(topn(ds_accutrend_base_table_emp  ,300  ,if((integer)emp_num = 0  ,0,1 ),-cnt) ,named('ds_accutrend_base_table_emp'  )  ,all);

ds_stats := dataset([
  {'DCA'                    ,'Number of Employees'  ,ut.IntWithCommas(count(ds_dca_base_prep       )) ,' '  + ut.IntWithCommas(count(ds_dca_base_prep       (trim(emp_num ) != ''))) + '(' + realformat(count(ds_dca_base_prep       (trim(emp_num ) != '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_dca_base_prep      (trim(emp_num ) = ''))) + '(' + realformat(count(ds_dca_base_prep      (trim(emp_num ) = '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)' ,'    '       + ut.IntWithCommas(count(ds_dca_base_prep      ((integer)trim(emp_num) = 0  ,trim(emp_num ) != ''))) + '(' + realformat(count(ds_dca_base_prep      ((integer)trim(emp_num) = 0  ,trim(emp_num ) != '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)'}
 ,{'DCA'                    ,'Sales'                ,ut.IntWithCommas(count(ds_dca_base_prep       )) ,' '  + ut.IntWithCommas(count(ds_dca_base_prep       (trim(sales   ) != ''))) + '(' + realformat(count(ds_dca_base_prep       (trim(sales   ) != '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_dca_base_prep      (trim(sales   ) = ''))) + '(' + realformat(count(ds_dca_base_prep      (trim(sales   ) = '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)' ,'         '  + ut.IntWithCommas(count(ds_dca_base_prep      ((integer)trim(sales  ) = 0  ,trim(sales   ) != ''))) + '(' + realformat(count(ds_dca_base_prep      ((integer)trim(sales  ) = 0  ,trim(sales   ) != '')) / count(ds_dca_base_prep       ) * 100.0  ,8,4) + '%)'}
 ,{'Equifax Business Data'  ,'Number of Employees'  ,ut.IntWithCommas(count(ds_eq_biz_base_prep    )) ,       ut.IntWithCommas(count(ds_eq_biz_base_prep    (trim(emp_num ) != ''))) + '(' + realformat(count(ds_eq_biz_base_prep    (trim(emp_num ) != '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)'  ,'         ' + ut.IntWithCommas(count(ds_eq_biz_base_prep   (trim(emp_num ) = ''))) + '(' + realformat(count(ds_eq_biz_base_prep   (trim(emp_num ) = '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)' ,               ut.IntWithCommas(count(ds_eq_biz_base_prep   ((integer)trim(emp_num) = 0  ,trim(emp_num ) != ''))) + '(' + realformat(count(ds_eq_biz_base_prep   ((integer)trim(emp_num) = 0  ,trim(emp_num ) != '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)'}
 ,{'Equifax Business Data'  ,'Sales'                ,ut.IntWithCommas(count(ds_eq_biz_base_prep    )) ,       ut.IntWithCommas(count(ds_eq_biz_base_prep    (trim(sales   ) != ''))) + '(' + realformat(count(ds_eq_biz_base_prep    (trim(sales   ) != '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)'  ,' '         + ut.IntWithCommas(count(ds_eq_biz_base_prep   (trim(sales   ) = ''))) + '(' + realformat(count(ds_eq_biz_base_prep   (trim(sales   ) = '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)' ,               ut.IntWithCommas(count(ds_eq_biz_base_prep   ((integer)trim(sales  ) = 0  ,trim(sales   ) != ''))) + '(' + realformat(count(ds_eq_biz_base_prep   ((integer)trim(sales  ) = 0  ,trim(sales   ) != '')) / count(ds_eq_biz_base_prep    ) * 100.0  ,8,4) + '%)'}
 ,{'Oshair'                 ,'Number of Employees'  ,ut.IntWithCommas(count(ds_oshair_base_prep    )) ,' '  + ut.IntWithCommas(count(ds_oshair_base_prep    (     emp_num   >=  0))) + '(' + realformat(count(ds_oshair_base_prep    (     emp_num   >=  0)) / count(ds_oshair_base_prep    ) * 100.0  ,8,4) + '%)'  ,'         ' + ut.IntWithCommas(0                                                 ) + '(' + realformat(0                                                  / count(ds_oshair_base_prep    ) * 100.0  ,8,4) + '%)' ,' '          + ut.IntWithCommas(count(ds_oshair_base_prep   (              emp_num  = 0                       ))) + '(' + realformat(count(ds_oshair_base_prep   (              emp_num  = 0                       )) / count(ds_oshair_base_prep    ) * 100.0  ,8,4) + '%)'}
 ,{'Cortera'                ,'Number of Employees'  ,ut.IntWithCommas(count(ds_cortera_base_prep   )) ,       ut.IntWithCommas(count(ds_cortera_base_prep   (trim(emp_num ) != ''))) + '(' + realformat(count(ds_cortera_base_prep   (trim(emp_num ) != '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_cortera_base_prep  (trim(emp_num ) = ''))) + '(' + realformat(count(ds_cortera_base_prep  (trim(emp_num ) = '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)' ,'        '   + ut.IntWithCommas(count(ds_cortera_base_prep  ((integer)trim(emp_num) = 0  ,trim(emp_num ) != ''))) + '(' + realformat(count(ds_cortera_base_prep  ((integer)trim(emp_num) = 0  ,trim(emp_num ) != '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)'}
 ,{'Cortera'                ,'Sales'                ,ut.IntWithCommas(count(ds_cortera_base_prep   )) ,       ut.IntWithCommas(count(ds_cortera_base_prep   (trim(sales   ) != ''))) + '(' + realformat(count(ds_cortera_base_prep   (trim(sales   ) != '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_cortera_base_prep  (trim(sales   ) = ''))) + '(' + realformat(count(ds_cortera_base_prep  (trim(sales   ) = '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)' ,'     '      + ut.IntWithCommas(count(ds_cortera_base_prep  ((integer)trim(sales  ) = 0  ,trim(sales   ) != ''))) + '(' + realformat(count(ds_cortera_base_prep  ((integer)trim(sales  ) = 0  ,trim(sales   ) != '')) / count(ds_cortera_base_prep   ) * 100.0  ,8,4) + '%)'}
 ,{'Infutor'                ,'Number of Employees'  ,ut.IntWithCommas(count(ds_infutor_base_prep   )) ,' '  + ut.IntWithCommas(count(ds_infutor_base_prep   (trim(emp_num ) != ''))) + '(' + realformat(count(ds_infutor_base_prep   (trim(emp_num ) != '')) / count(ds_infutor_base_prep   ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_infutor_base_prep  (trim(emp_num ) = ''))) + '(' + realformat(count(ds_infutor_base_prep  (trim(emp_num ) = '')) / count(ds_infutor_base_prep   ) * 100.0  ,8,4) + '%)' ,'         '  + ut.IntWithCommas(0                                                                               ) + '(' + realformat(0                                                                                / count(ds_infutor_base_prep   ) * 100.0  ,8,4) + '%)'}
 ,{'Accutrend'              ,'Number of Employees'  ,ut.IntWithCommas(count(ds_accutrend_base_prep )) ,'  ' + ut.IntWithCommas(count(ds_accutrend_base_prep (trim(emp_num ) != ''))) + '(' + realformat(count(ds_accutrend_base_prep (trim(emp_num ) != '')) / count(ds_accutrend_base_prep ) * 100.0  ,8,4) + '%)'  ,              ut.IntWithCommas(count(ds_accutrend_base_prep(trim(emp_num ) = ''))) + '(' + realformat(count(ds_accutrend_base_prep(trim(emp_num ) = '')) / count(ds_accutrend_base_prep ) * 100.0  ,8,4) + '%)' ,'   '        + ut.IntWithCommas(count(ds_accutrend_base_prep((integer)trim(emp_num) = 0  ,trim(emp_num ) != ''))) + '(' + realformat(count(ds_accutrend_base_prep((integer)trim(emp_num) = 0  ,trim(emp_num ) != '')) / count(ds_accutrend_base_prep ) * 100.0  ,8,4) + '%)'}

]  ,{string Source  ,string field   ,string total_record_count  ,string total_populated ,string total_blanks  ,string total_zeros});

output(ds_stats ,named('ds_stats'));