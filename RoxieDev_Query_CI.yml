RoxieDev_Query_CI:
  image: gitlab.ins.risk.regn.net:4567/collda01/publicrecords/roxie-ci-clienttools
  stage: build
  only:
    # only run the job at scheduled times
    refs:
      - schedules
    variables:
      - $JobType == "RoxieDev_Query_CI"
  before_script:
  script:
    - RES_FILE="query_check_results.txt"
    - WARN_FILE="query_check_warnings.txt"
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git checkout $CI_COMMIT_BRANCH
    - echo "Begin Query Syntax Check:"
    - cd .ci_root
    - echo "Pulling Node Packages"
    - npm install
    - echo "Check Compiler Version"
    - eclcc --version || true
    - echo "Run Script"
    - |
      if node full_syntax_check.js | tee $RES_FILE
      then checkres=0
      else checkres=1
      fi
    - cat eclcc.log _syn_check_warnings.log > $WARN_FILE
    # commit and push results to repo
    - echo "Pulling Latest Changes"
    - git pull https://${CIUser_Arqs}:${CIToken_Arqs}@${CI_REPOSITORY_URL#*@} $CI_COMMIT_BRANCH
    - echo "Pushing Query Check Results"
    - git add $RES_FILE
    - git add $WARN_FILE
    - git commit -m "Daily Query Syntax Check Results"
    - |
      if git push https://${CIUser_Arqs}:${CIToken_Arqs}@${CI_REPOSITORY_URL#*@}
      then echo "Git Push Succeeded"
      elif sleep 5m && git push https://${CIUser_Arqs}:${CIToken_Arqs}@${CI_REPOSITORY_URL#*@}
      then echo "Git Push Succeeded (2nd Attempt)"
      elif sleep 5m && git push https://${CIUser_Arqs}:${CIToken_Arqs}@${CI_REPOSITORY_URL#*@}
      then echo "Git Push Succeeded (3rd Attempt)"
      else checkres=1
      fi
    - exit $checkres