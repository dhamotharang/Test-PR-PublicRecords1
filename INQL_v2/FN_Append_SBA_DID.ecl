IMPORT INQL_v2,bipV2;

EXPORT FN_Append_SBA_DID(dataset(INQL_v2.Layouts.Common_ThorAdditions_non_fcra) pInFile) := function

pInFile_dist     := distribute(project(pInFile(source = 'ACCURINT')
                     ,transform(INQL_v2.Layouts.Common_ThorAdditions_SBA, self := left, self := [])), hash(search_info.transaction_id));
pInFile_not_dist := project(pInFile(source <> 'ACCURINT'), transform(INQL_v2.Layouts.Common_ThorAdditions_SBA, self := left, self := []));

SBA_data_dist  := distribute(inql_v2.files(false, true).SBA_base.built, hash(transaction_id));
SBA_data_dedup := dedup(sort(SBA_data_dist,record, local), record,local);

pInFile_dist tjoin(pInFile_dist le, SBA_data_dedup ri) := transform

      self.bus_q.fax_phone         		:= ri.cmp_fax_number;         		
			self.bus_q.sic_code            	:= ri.cmp_sic_code;            		
			self.bus_q.naic_code           	:= ri.cmp_naic_code;            		
			self.bus_q.business_structure  	:= ri.cmp_business_structure;   		
			self.bus_q.years_in_business 		:= ri.cmp_years_in_business; 		
			self.bus_q.bus_start_date      	:= ri.cmp_bus_start_date;       		
			self.bus_q.yearly_revenue 	    := ri.cmp_yearly_revenue;

      self.bususer_q2.Title := ri.pii2_business_title;
			self.bususer_q2.First_Name := ri.pii2_first_name;
			self.bususer_q2.Middle_Name := ri.pii2_middle_name;
			self.bususer_q2.Last_Name := ri.pii2_last_name;
			self.bususer_q2.Address := ri.pii2_address;
			self.bususer_q2.City :=  ri.pii2_city;
			self.bususer_q2.State :=  ri.pii2_state;
			self.bususer_q2.Zip :=  ri.pii2_zip;
			self.bususer_q2.Personal_Phone :=  ri.pii2_phone;
			self.bususer_q2.DOB := ri.pii2_dob;
			self.bususer_q2.DL := ri.pii2_dl;
			self.bususer_q2.DL_St := ri.pii2_dl_state; 
			self.bususer_q2.FName := ri.pii2_clean_first_name;
			self.bususer_q2.MName := ri.pii2_clean_middle_name;
			self.bususer_q2.LName := ri.pii2_clean_last_name;
			self.bususer_q2.Name_Suffix := ri.pii2_clean_suffix_name;
			self.bususer_q2.prim_range  :=  ri.pii2_clean_prim_range;
			self.bususer_q2.predir  :=  ri.pii2_clean_predir ;
			self.bususer_q2.prim_name  :=  ri.pii2_clean_prim_name ;
			self.bususer_q2.addr_suffix  :=  ri.pii2_clean_addr_suffix ;
			self.bususer_q2.postdir  :=  ri.pii2_clean_postdir;
			self.bususer_q2.unit_desig  :=  ri.pii2_clean_unit_desig;
			self.bususer_q2.sec_range  :=  ri.pii2_clean_sec_range;
			self.bususer_q2.v_city_name  :=  ri.pii2_clean_v_city_name;
			self.bususer_q2.st  :=  ri.pii2_clean_st;
			self.bususer_q2.zip5  :=  ri.pii2_clean_zip5;
			self.bususer_q2.zip4  :=  ri.pii2_clean_zip4;
			self.bususer_q2.addr_rec_type  :=  ri.pii2_clean_addr_rec_type ;
			self.bususer_q2.fips_state :=  ri.pii2_clean_fips_state;
			self.bususer_q2.fips_county :=  ri.pii2_clean_fips_county;
			self.bususer_q2.geo_lat  :=  ri.pii2_clean_geo_lat;
			self.bususer_q2.geo_long  :=  ri.pii2_clean_geo_long;
			self.bususer_q2.cbsa  :=  ri.pii2_clean_cbsa;
			self.bususer_q2.geo_blk  :=  ri.pii2_clean_geo_blk;
			self.bususer_q2.geo_match  :=  ri.pii2_clean_geo_match;
			self.bususer_q2.err_stat :=  ri.pii2_clean_err_stat;
			self.bususer_q2.Appended_SSN := ri.pii2_ssn;
			self.bususer_q2.Appended_ADL := ri.pii2_response_lexid;
 
      self.bususer_q3.Title := ri.pii3_business_title;
			self.bususer_q3.First_Name := ri.pii3_first_name;
			self.bususer_q3.Middle_Name := ri.pii3_middle_name;
			self.bususer_q3.Last_Name := ri.pii3_last_name;
			self.bususer_q3.Address := ri.pii3_address;
			self.bususer_q3.City :=  ri.pii3_city;
			self.bususer_q3.State :=  ri.pii3_state;
			self.bususer_q3.Zip :=  ri.pii3_zip;
			self.bususer_q3.Personal_Phone :=  ri.pii3_phone;
			self.bususer_q3.DOB := ri.pii3_dob;
			self.bususer_q3.DL := ri.pii3_dl;
			self.bususer_q3.DL_St := ri.pii3_dl_state; 
			self.bususer_q3.FName := ri.pii3_clean_first_name;
			self.bususer_q3.MName := ri.pii3_clean_middle_name;
			self.bususer_q3.LName := ri.pii3_clean_last_name;
			self.bususer_q3.Name_Suffix := ri.pii3_clean_suffix_name;
			self.bususer_q3.prim_range  :=  ri.pii3_clean_prim_range;
			self.bususer_q3.predir  :=  ri.pii3_clean_predir ;
			self.bususer_q3.prim_name  :=  ri.pii3_clean_prim_name ;
			self.bususer_q3.addr_suffix  :=  ri.pii3_clean_addr_suffix ;
			self.bususer_q3.postdir  :=  ri.pii3_clean_postdir;
			self.bususer_q3.unit_desig  :=  ri.pii3_clean_unit_desig;
			self.bususer_q3.sec_range  :=  ri.pii3_clean_sec_range;
			self.bususer_q3.v_city_name  :=  ri.pii3_clean_v_city_name;
			self.bususer_q3.st  :=  ri.pii3_clean_st;
			self.bususer_q3.zip5  :=  ri.pii3_clean_zip5;
			self.bususer_q3.zip4  :=  ri.pii3_clean_zip4;
			self.bususer_q3.addr_rec_type  :=  ri.pii3_clean_addr_rec_type ;
			self.bususer_q3.fips_state :=  ri.pii3_clean_fips_state;
			self.bususer_q3.fips_county :=  ri.pii3_clean_fips_county;
			self.bususer_q3.geo_lat  :=  ri.pii3_clean_geo_lat;
			self.bususer_q3.geo_long  :=  ri.pii3_clean_geo_long;
			self.bususer_q3.cbsa  :=  ri.pii3_clean_cbsa;
			self.bususer_q3.geo_blk  :=  ri.pii3_clean_geo_blk;
			self.bususer_q3.geo_match  :=  ri.pii3_clean_geo_match;
			self.bususer_q3.err_stat :=  ri.pii3_clean_err_stat;
			self.bususer_q3.Appended_SSN := ri.pii3_ssn;
			self.bususer_q3.Appended_ADL := ri.pii3_response_lexid;
			
			self.bususer_q4.Title := ri.pii4_business_title;
			self.bususer_q4.First_Name := ri.pii4_first_name;
			self.bususer_q4.Middle_Name := ri.pii4_middle_name;
			self.bususer_q4.Last_Name := ri.pii4_last_name;
			self.bususer_q4.Address := ri.pii4_address;
			self.bususer_q4.City :=  ri.pii4_city;
			self.bususer_q4.State :=  ri.pii4_state;
			self.bususer_q4.Zip :=  ri.pii4_zip;
			self.bususer_q4.Personal_Phone :=  ri.pii4_phone;
			self.bususer_q4.DOB := ri.pii4_dob;
			self.bususer_q4.DL := ri.pii4_dl;
			self.bususer_q4.DL_St := ri.pii4_dl_state; 
			self.bususer_q4.FName := ri.pii4_clean_first_name;
			self.bususer_q4.MName := ri.pii4_clean_middle_name;
			self.bususer_q4.LName := ri.pii4_clean_last_name;
			self.bususer_q4.Name_Suffix := ri.pii4_clean_suffix_name;
			self.bususer_q4.prim_range  :=  ri.pii4_clean_prim_range;
			self.bususer_q4.predir  :=  ri.pii4_clean_predir ;
			self.bususer_q4.prim_name  :=  ri.pii4_clean_prim_name ;
			self.bususer_q4.addr_suffix  :=  ri.pii4_clean_addr_suffix ;
			self.bususer_q4.postdir  :=  ri.pii4_clean_postdir;
			self.bususer_q4.unit_desig  :=  ri.pii4_clean_unit_desig;
			self.bususer_q4.sec_range  :=  ri.pii4_clean_sec_range;
			self.bususer_q4.v_city_name  :=  ri.pii4_clean_v_city_name;
			self.bususer_q4.st  :=  ri.pii4_clean_st;
			self.bususer_q4.zip5  :=  ri.pii4_clean_zip5;
			self.bususer_q4.zip4  :=  ri.pii4_clean_zip4;
			self.bususer_q4.addr_rec_type  :=  ri.pii4_clean_addr_rec_type ;
			self.bususer_q4.fips_state :=  ri.pii4_clean_fips_state;
			self.bususer_q4.fips_county :=  ri.pii4_clean_fips_county;
			self.bususer_q4.geo_lat  :=  ri.pii4_clean_geo_lat;
			self.bususer_q4.geo_long  :=  ri.pii4_clean_geo_long;
			self.bususer_q4.cbsa  :=  ri.pii4_clean_cbsa;
			self.bususer_q4.geo_blk  :=  ri.pii4_clean_geo_blk;
			self.bususer_q4.geo_match  :=  ri.pii4_clean_geo_match;
			self.bususer_q4.err_stat :=  ri.pii4_clean_err_stat;
			self.bususer_q4.Appended_SSN := ri.pii4_ssn;
			self.bususer_q4.Appended_ADL := ri.pii4_response_lexid;
			
			self.bususer_q5.Title := ri.pii5_business_title;
			self.bususer_q5.First_Name := ri.pii5_first_name;
			self.bususer_q5.Middle_Name := ri.pii5_middle_name;
			self.bususer_q5.Last_Name := ri.pii5_last_name;
			self.bususer_q5.Address := ri.pii5_address;
			self.bususer_q5.City :=  ri.pii5_city;
			self.bususer_q5.State :=  ri.pii5_state;
			self.bususer_q5.Zip :=  ri.pii5_zip;
			self.bususer_q5.Personal_Phone :=  ri.pii5_phone;
			self.bususer_q5.DOB := ri.pii5_dob;
			self.bususer_q5.DL := ri.pii5_dl;
			self.bususer_q5.DL_St := ri.pii5_dl_state; 
			self.bususer_q5.FName := ri.pii5_clean_first_name;
			self.bususer_q5.MName := ri.pii5_clean_middle_name;
			self.bususer_q5.LName := ri.pii5_clean_last_name;
			self.bususer_q5.Name_Suffix := ri.pii5_clean_suffix_name;
			self.bususer_q5.prim_range  :=  ri.pii5_clean_prim_range;
			self.bususer_q5.predir  :=  ri.pii5_clean_predir ;
			self.bususer_q5.prim_name  :=  ri.pii5_clean_prim_name ;
			self.bususer_q5.addr_suffix  :=  ri.pii5_clean_addr_suffix ;
			self.bususer_q5.postdir  :=  ri.pii5_clean_postdir;
			self.bususer_q5.unit_desig  :=  ri.pii5_clean_unit_desig;
			self.bususer_q5.sec_range  :=  ri.pii5_clean_sec_range;
			self.bususer_q5.v_city_name  :=  ri.pii5_clean_v_city_name;
			self.bususer_q5.st  :=  ri.pii5_clean_st;
			self.bususer_q5.zip5  :=  ri.pii5_clean_zip5;
			self.bususer_q5.zip4  :=  ri.pii5_clean_zip4;
			self.bususer_q5.addr_rec_type  :=  ri.pii5_clean_addr_rec_type ;
			self.bususer_q5.fips_state :=  ri.pii5_clean_fips_state;
			self.bususer_q5.fips_county :=  ri.pii5_clean_fips_county;
			self.bususer_q5.geo_lat  :=  ri.pii5_clean_geo_lat;
			self.bususer_q5.geo_long  :=  ri.pii5_clean_geo_long;
			self.bususer_q5.cbsa  :=  ri.pii5_clean_cbsa;
			self.bususer_q5.geo_blk  :=  ri.pii5_clean_geo_blk;
			self.bususer_q5.geo_match  :=  ri.pii5_clean_geo_match;
			self.bususer_q5.err_stat :=  ri.pii5_clean_err_stat;
			self.bususer_q5.Appended_SSN := ri.pii5_ssn;
			self.bususer_q5.Appended_ADL := ri.pii5_response_lexid;

			self.bususer_q6.Title := ri.pii6_business_title;
			self.bususer_q6.First_Name := ri.pii6_first_name;
			self.bususer_q6.Middle_Name := ri.pii6_middle_name;
			self.bususer_q6.Last_Name := ri.pii6_last_name;
			self.bususer_q6.Address := ri.pii6_address;
			self.bususer_q6.City :=  ri.pii6_city;
			self.bususer_q6.State :=  ri.pii6_state;
			self.bususer_q6.Zip :=  ri.pii6_zip;
			self.bususer_q6.Personal_Phone :=  ri.pii6_phone;
			self.bususer_q6.DOB := ri.pii6_dob;
			self.bususer_q6.DL := ri.pii6_dl;
			self.bususer_q6.DL_St := ri.pii6_dl_state; 
			self.bususer_q6.FName := ri.pii6_clean_first_name;
			self.bususer_q6.MName := ri.pii6_clean_middle_name;
			self.bususer_q6.LName := ri.pii6_clean_last_name;
			self.bususer_q6.Name_Suffix := ri.pii6_clean_suffix_name;
			self.bususer_q6.prim_range  :=  ri.pii6_clean_prim_range;
			self.bususer_q6.predir  :=  ri.pii6_clean_predir ;
			self.bususer_q6.prim_name  :=  ri.pii6_clean_prim_name ;
			self.bususer_q6.addr_suffix  :=  ri.pii6_clean_addr_suffix ;
			self.bususer_q6.postdir  :=  ri.pii6_clean_postdir;
			self.bususer_q6.unit_desig  :=  ri.pii6_clean_unit_desig;
			self.bususer_q6.sec_range  :=  ri.pii6_clean_sec_range;
			self.bususer_q6.v_city_name  :=  ri.pii6_clean_v_city_name;
			self.bususer_q6.st  :=  ri.pii6_clean_st;
			self.bususer_q6.zip5  :=  ri.pii6_clean_zip5;
			self.bususer_q6.zip4  :=  ri.pii6_clean_zip4;
			self.bususer_q6.addr_rec_type  :=  ri.pii6_clean_addr_rec_type ;
			self.bususer_q6.fips_state :=  ri.pii6_clean_fips_state;
			self.bususer_q6.fips_county :=  ri.pii6_clean_fips_county;
			self.bususer_q6.geo_lat  :=  ri.pii6_clean_geo_lat;
			self.bususer_q6.geo_long  :=  ri.pii6_clean_geo_long;
			self.bususer_q6.cbsa  :=  ri.pii6_clean_cbsa;
			self.bususer_q6.geo_blk  :=  ri.pii6_clean_geo_blk;
			self.bususer_q6.geo_match  :=  ri.pii6_clean_geo_match;
			self.bususer_q6.err_stat :=  ri.pii6_clean_err_stat;
			self.bususer_q6.Appended_SSN := ri.pii6_ssn;
			self.bususer_q6.Appended_ADL := ri.pii6_response_lexid;

			self.bususer_q7.Title := ri.pii7_business_title;
			self.bususer_q7.First_Name := ri.pii7_first_name;
			self.bususer_q7.Middle_Name := ri.pii7_middle_name;
			self.bususer_q7.Last_Name := ri.pii7_last_name;
			self.bususer_q7.Address := ri.pii7_address;
			self.bususer_q7.City :=  ri.pii7_city;
			self.bususer_q7.State :=  ri.pii7_state;
			self.bususer_q7.Zip :=  ri.pii7_zip;
			self.bususer_q7.Personal_Phone :=  ri.pii7_phone;
			self.bususer_q7.DOB := ri.pii7_dob;
			self.bususer_q7.DL := ri.pii7_dl;
			self.bususer_q7.DL_St := ri.pii7_dl_state; 
			self.bususer_q7.FName := ri.pii7_clean_first_name;
			self.bususer_q7.MName := ri.pii7_clean_middle_name;
			self.bususer_q7.LName := ri.pii7_clean_last_name;
			self.bususer_q7.Name_Suffix := ri.pii7_clean_suffix_name;
			self.bususer_q7.prim_range  :=  ri.pii7_clean_prim_range;
			self.bususer_q7.predir  :=  ri.pii7_clean_predir ;
			self.bususer_q7.prim_name  :=  ri.pii7_clean_prim_name ;
			self.bususer_q7.addr_suffix  :=  ri.pii7_clean_addr_suffix ;
			self.bususer_q7.postdir  :=  ri.pii7_clean_postdir;
			self.bususer_q7.unit_desig  :=  ri.pii7_clean_unit_desig;
			self.bususer_q7.sec_range  :=  ri.pii7_clean_sec_range;
			self.bususer_q7.v_city_name  :=  ri.pii7_clean_v_city_name;
			self.bususer_q7.st  :=  ri.pii7_clean_st;
			self.bususer_q7.zip5  :=  ri.pii7_clean_zip5;
			self.bususer_q7.zip4  :=  ri.pii7_clean_zip4;
			self.bususer_q7.addr_rec_type  :=  ri.pii7_clean_addr_rec_type ;
			self.bususer_q7.fips_state :=  ri.pii7_clean_fips_state;
			self.bususer_q7.fips_county :=  ri.pii7_clean_fips_county;
			self.bususer_q7.geo_lat  :=  ri.pii7_clean_geo_lat;
			self.bususer_q7.geo_long  :=  ri.pii7_clean_geo_long;
			self.bususer_q7.cbsa  :=  ri.pii7_clean_cbsa;
			self.bususer_q7.geo_blk  :=  ri.pii7_clean_geo_blk;
			self.bususer_q7.geo_match  :=  ri.pii7_clean_geo_match;
			self.bususer_q7.err_stat :=  ri.pii7_clean_err_stat;
			self.bususer_q7.Appended_SSN := ri.pii7_ssn;
			self.bususer_q7.Appended_ADL := ri.pii7_response_lexid;

			self.bususer_q8.Title := ri.pii8_business_title;
			self.bususer_q8.First_Name := ri.pii8_first_name;
			self.bususer_q8.Middle_Name := ri.pii8_middle_name;
			self.bususer_q8.Last_Name := ri.pii8_last_name;
			self.bususer_q8.Address := ri.pii8_address;
			self.bususer_q8.City :=  ri.pii8_city;
			self.bususer_q8.State :=  ri.pii8_state;
			self.bususer_q8.Zip :=  ri.pii8_zip;
			self.bususer_q8.Personal_Phone :=  ri.pii8_phone;
			self.bususer_q8.DOB := ri.pii8_dob;
			self.bususer_q8.DL := ri.pii8_dl;
			self.bususer_q8.DL_St := ri.pii8_dl_state; 
			self.bususer_q8.FName := ri.pii8_clean_first_name;
			self.bususer_q8.MName := ri.pii8_clean_middle_name;
			self.bususer_q8.LName := ri.pii8_clean_last_name;
			self.bususer_q8.Name_Suffix := ri.pii8_clean_suffix_name;
			self.bususer_q8.prim_range  :=  ri.pii8_clean_prim_range;
			self.bususer_q8.predir  :=  ri.pii8_clean_predir ;
			self.bususer_q8.prim_name  :=  ri.pii8_clean_prim_name ;
			self.bususer_q8.addr_suffix  :=  ri.pii8_clean_addr_suffix ;
			self.bususer_q8.postdir  :=  ri.pii8_clean_postdir;
			self.bususer_q8.unit_desig  :=  ri.pii8_clean_unit_desig;
			self.bususer_q8.sec_range  :=  ri.pii8_clean_sec_range;
			self.bususer_q8.v_city_name  :=  ri.pii8_clean_v_city_name;
			self.bususer_q8.st  :=  ri.pii8_clean_st;
			self.bususer_q8.zip5  :=  ri.pii8_clean_zip5;
			self.bususer_q8.zip4  :=  ri.pii8_clean_zip4;
			self.bususer_q8.addr_rec_type  :=  ri.pii8_clean_addr_rec_type ;
			self.bususer_q8.fips_state :=  ri.pii8_clean_fips_state;
			self.bususer_q8.fips_county :=  ri.pii8_clean_fips_county;
			self.bususer_q8.geo_lat  :=  ri.pii8_clean_geo_lat;
			self.bususer_q8.geo_long  :=  ri.pii8_clean_geo_long;
			self.bususer_q8.cbsa  :=  ri.pii8_clean_cbsa;
			self.bususer_q8.geo_blk  :=  ri.pii8_clean_geo_blk;
			self.bususer_q8.geo_match  :=  ri.pii8_clean_geo_match;
			self.bususer_q8.err_stat :=  ri.pii8_clean_err_stat;
			self.bususer_q8.Appended_SSN := ri.pii8_ssn;
			self.bususer_q8.Appended_ADL := ri.pii8_response_lexid;
			self := le;

end;

pInFile_append_SBA := join(pInFile_dist, SBA_data_dedup, 
left.search_info.transaction_id = right.transaction_id and left.source = 'ACCURINT', tjoin(left,right), left outer, local);

update_append_SBA := project((pInFile_append_SBA + pInFile_not_dist), INQL_v2.Layouts.Common_indexes_DID_SBA);

return update_append_SBA;

end;
