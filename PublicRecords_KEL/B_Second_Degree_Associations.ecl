//HPCC Systems KEL Compiler Version 1.3.0
IMPORT KEL13 AS KEL;
IMPORT CFG_Compile,E_First_Degree_Associations,E_Person,E_Second_Degree_Associations FROM PublicRecords_KEL;
IMPORT * FROM KEL13.Null;
EXPORT B_Second_Degree_Associations(CFG_Compile.FDCDataset __in = CFG_Compile.FDCDefault, CFG_Compile __cfg = CFG_Compile) := MODULE
  SHARED VIRTUAL TYPEOF(E_First_Degree_Associations(__in,__cfg).__Result) __E_First_Degree_Associations := E_First_Degree_Associations(__in,__cfg).__Result;
  SHARED __EE3425225 := __E_First_Degree_Associations;
  SHARED __EE6198794 := __EE3425225(__NN(__EE3425225.First_Degree_Association_));
  SHARED __EE6199060 := __EE3425225;
  SHARED __EE6199072 := __EE6199060(__NN(__EE6199060.Subject_));
  SHARED __ST3425701_Layout := RECORD
    KEL.typ.ntyp(E_Person().Typ) Subject_;
    KEL.typ.ntyp(E_Person().Typ) First_Degree_Association_;
    KEL.typ.nint Title_;
    KEL.typ.nstr Relationship_Type_;
    KEL.typ.nstr Relationship_Confidence_;
    KEL.typ.nint Relationship_Score_;
    KEL.typ.nstr Generation_;
    KEL.typ.nstr Relationship_Date_First_Seen_;
    KEL.typ.nstr Relationship_Date_Last_Seen_;
    KEL.typ.nstr Source_;
    KEL.typ.ntyp(E_Person().Typ) Subject__1_;
    KEL.typ.ntyp(E_Person().Typ) First_Degree_Association__1_;
    KEL.typ.nint Title__1_;
    KEL.typ.nstr Relationship_Type__1_;
    KEL.typ.nstr Relationship_Confidence__1_;
    KEL.typ.nint Relationship_Score__1_;
    KEL.typ.nstr Generation__1_;
    KEL.typ.nstr Relationship_Date_First_Seen__1_;
    KEL.typ.nstr Relationship_Date_Last_Seen__1_;
    KEL.typ.nstr Source__1_;
    KEL.typ.epoch Archive___Date_ := 0;
    KEL.typ.epoch Date_First_Seen_ := 0;
    KEL.typ.epoch Date_Last_Seen_ := 0;
    KEL.typ.epoch Date_Vendor_First_Reported_ := 0;
    KEL.typ.epoch Date_Vendor_Last_Reported_ := 0;
    KEL.typ.epoch Hybrid_Archive_Date_ := 0;
    KEL.typ.epoch Vault_Date_First_Seen_ := 0;
    KEL.typ.epoch Vault_Date_Last_Seen_ := 0;
    KEL.typ.int __RecordCount := 0;
  END;
  __JC6199082(E_First_Degree_Associations(__in,__cfg).Layout __EE6198794, E_First_Degree_Associations(__in,__cfg).Layout __EE6199072) := __NNEQ(__EE6198794.First_Degree_Association_,__EE6199072.Subject_) AND __T(__AND(__OP2(__EE6198794.First_Degree_Association_,=,__EE6199072.Subject_),__OP2(__EE6198794.Subject_,<>,__EE6199072.First_Degree_Association_)));
  __ST3425701_Layout __JT6199082(E_First_Degree_Associations(__in,__cfg).Layout __l, E_First_Degree_Associations(__in,__cfg).Layout __r) := TRANSFORM
    SELF.Subject__1_ := __r.Subject_;
    SELF.First_Degree_Association__1_ := __r.First_Degree_Association_;
    SELF.Title__1_ := __r.Title_;
    SELF.Relationship_Type__1_ := __r.Relationship_Type_;
    SELF.Relationship_Confidence__1_ := __r.Relationship_Confidence_;
    SELF.Relationship_Score__1_ := __r.Relationship_Score_;
    SELF.Generation__1_ := __r.Generation_;
    SELF.Relationship_Date_First_Seen__1_ := __r.Relationship_Date_First_Seen_;
    SELF.Relationship_Date_Last_Seen__1_ := __r.Relationship_Date_Last_Seen_;
    SELF.Source__1_ := __r.Source_;
    SELF.Archive___Date_ := __r.Archive___Date_;
    SELF.Date_First_Seen_ := __r.Date_First_Seen_;
    SELF.Date_Last_Seen_ := __r.Date_Last_Seen_;
    SELF.Date_Vendor_First_Reported_ := __r.Date_Vendor_First_Reported_;
    SELF.Date_Vendor_Last_Reported_ := __r.Date_Vendor_Last_Reported_;
    SELF.Hybrid_Archive_Date_ := __r.Hybrid_Archive_Date_;
    SELF.Vault_Date_First_Seen_ := __r.Vault_Date_First_Seen_;
    SELF.Vault_Date_Last_Seen_ := __r.Vault_Date_Last_Seen_;
    SELF := __l;
    SELF := __r;
  END;
  SHARED __EE6199083 := JOIN(__EE6198794,__EE6199072,__JC6199082(LEFT,RIGHT),__JT6199082(LEFT,RIGHT),INNER,HASH);
  SHARED __ST3425870_Layout := RECORD
    KEL.typ.ntyp(E_Person().Typ) Subject_;
    KEL.typ.ntyp(E_Person().Typ) First_Degree_Association_;
    KEL.typ.nint Title_;
    KEL.typ.nstr Relationship_Type_;
    KEL.typ.nstr Relationship_Confidence_;
    KEL.typ.nint Relationship_Score_;
    KEL.typ.nstr Generation_;
    KEL.typ.nstr Relationship_Date_First_Seen_;
    KEL.typ.nstr Relationship_Date_Last_Seen_;
    KEL.typ.nstr Source_;
    KEL.typ.ntyp(E_Person().Typ) Subject__1_;
    KEL.typ.ntyp(E_Person().Typ) First_Degree_Association__1_;
    KEL.typ.nint Title__1_;
    KEL.typ.nstr Relationship_Type__1_;
    KEL.typ.nstr Relationship_Confidence__1_;
    KEL.typ.nint Relationship_Score__1_;
    KEL.typ.nstr Generation__1_;
    KEL.typ.nstr Relationship_Date_First_Seen__1_;
    KEL.typ.nstr Relationship_Date_Last_Seen__1_;
    KEL.typ.nstr Source__1_;
    KEL.typ.bool First_Degree_Associations_ := FALSE;
    KEL.typ.epoch Archive___Date_ := 0;
    KEL.typ.epoch Date_First_Seen_ := 0;
    KEL.typ.epoch Date_Last_Seen_ := 0;
    KEL.typ.epoch Date_Vendor_First_Reported_ := 0;
    KEL.typ.epoch Date_Vendor_Last_Reported_ := 0;
    KEL.typ.epoch Hybrid_Archive_Date_ := 0;
    KEL.typ.epoch Vault_Date_First_Seen_ := 0;
    KEL.typ.epoch Vault_Date_Last_Seen_ := 0;
    KEL.typ.int __RecordCount := 0;
  END;
  SHARED __EE6199063 := __EE3425225;
  SHARED __EE6199136 := __EE6199063(__NN(__EE6199063.First_Degree_Association_) AND __NN(__EE6199063.Subject_));
  __JC6199150(__ST3425701_Layout __EE6199083, E_First_Degree_Associations(__in,__cfg).Layout __EE6199136) := __NNEQ(__EE6199083.Subject_,__EE6199136.Subject_) AND __NNEQ(__EE6199083.First_Degree_Association__1_,__EE6199136.First_Degree_Association_) AND __T(__AND(__OP2(__EE6199083.Subject_,=,__EE6199136.Subject_),__OP2(__EE6199083.First_Degree_Association__1_,=,__EE6199136.First_Degree_Association_)));
  __JF6199150(E_First_Degree_Associations(__in,__cfg).Layout __EE6199136) := __NN(__EE6199136.Subject_) OR __NN(__EE6199136.First_Degree_Association_);
  SHARED __EE6199151 := JOIN(__EE6199083,__EE6199136,__JC6199150(LEFT,RIGHT),TRANSFORM(__ST3425870_Layout,SELF:=LEFT,SELF.First_Degree_Associations_:=__JF6199150(RIGHT)),HASH,LEFT OUTER,KEEP(1));
  SHARED __EE6199180 := __EE6199151(NOT (__EE6199151.First_Degree_Associations_));
  SHARED __EE6199314 := PROJECT(__EE6199180,__ST3425701_Layout);
  SHARED E_Second_Degree_Associations(__in,__cfg).Layout __ND6199340__Project(__ST3425701_Layout __PP6199315) := TRANSFORM
    SELF.First_Degree_Association_ := __PP6199315.Subject_;
    SELF.Second_Degree_Association_ := __PP6199315.First_Degree_Association__1_;
    SELF.Title_ := __PP6199315.Title__1_;
    SELF.Relationship_Type_ := __PP6199315.Relationship_Type__1_;
    SELF.Relationship_Confidence_ := __PP6199315.Relationship_Confidence__1_;
    SELF.Relationship_Score_ := __PP6199315.Relationship_Score__1_;
    SELF.Generation_ := __PP6199315.Generation__1_;
    SELF.Relationship_Date_First_Seen_ := __PP6199315.Relationship_Date_First_Seen__1_;
    SELF.Relationship_Date_Last_Seen_ := __PP6199315.Relationship_Date_Last_Seen__1_;
    SELF.Source_ := __PP6199315.Source__1_;
    SELF := __PP6199315;
  END;
  EXPORT __ENH_Second_Degree_Associations := PROJECT(TABLE(PROJECT(__EE6199314,__ND6199340__Project(LEFT)),{KEL.typ.int __RecordCount := SUM(GROUP,__RecordCount),KEL.typ.epoch Archive___Date_ := KEL.era.SimpleRoll(GROUP,Archive___Date_,MIN,FALSE),KEL.typ.epoch Date_First_Seen_ := KEL.era.SimpleRoll(GROUP,Date_First_Seen_,MIN,FALSE),KEL.typ.epoch Date_Last_Seen_ := KEL.era.SimpleRoll(GROUP,Date_Last_Seen_,MAX,FALSE),KEL.typ.epoch Date_Vendor_First_Reported_ := KEL.era.SimpleRoll(GROUP,Date_Vendor_First_Reported_,MIN,FALSE),KEL.typ.epoch Date_Vendor_Last_Reported_ := KEL.era.SimpleRoll(GROUP,Date_Vendor_Last_Reported_,MAX,FALSE),KEL.typ.epoch Hybrid_Archive_Date_ := KEL.era.SimpleRoll(GROUP,Hybrid_Archive_Date_,MIN,FALSE),KEL.typ.epoch Vault_Date_First_Seen_ := KEL.era.SimpleRoll(GROUP,Vault_Date_First_Seen_,MIN,FALSE),KEL.typ.epoch Vault_Date_Last_Seen_ := KEL.era.SimpleRoll(GROUP,Vault_Date_Last_Seen_,MAX,FALSE),First_Degree_Association_,Second_Degree_Association_,Title_,Relationship_Type_,Relationship_Confidence_,Relationship_Score_,Generation_,Relationship_Date_First_Seen_,Relationship_Date_Last_Seen_,Source_},First_Degree_Association_,Second_Degree_Association_,Title_,Relationship_Type_,Relationship_Confidence_,Relationship_Score_,Generation_,Relationship_Date_First_Seen_,Relationship_Date_Last_Seen_,Source_,MERGE),E_Second_Degree_Associations(__in,__cfg).Layout);
END;
