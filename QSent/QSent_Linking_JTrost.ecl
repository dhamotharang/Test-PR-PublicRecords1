import gong_v2;

adds    := Gong_v2.file_DailyAdditions(~(lststy in ['8','9'] or (lststy='2' and telno='0000000')));						
deletes := Gong_v2.getDeletesOrigAddRec(telno<>'0000000');

max_filedate := max(adds,filedate);

todays_add_data := adds   (filedate='20090312_01');
todays_del_data := deletes(del_dt  ='20090312_01');
//output(todays_data);

/*
r_phone := record
 string10 phoneno;
 integer phoneno_ct;
end;

r_phone t_phone(todays_add_data le) := transform
 self            := le;
 self.phoneno_ct := 1;
end;

p_phone      := project(todays_add_data,t_phone(left));
p_phone_sort := sort(p_phone,phoneno,local);

r_phone t_phone2(p_phone_sort le, p_phone_sort ri) := transform
 self.phoneno_ct := le.phoneno_ct+1;
 self            := le;
end;

p_phone_ct   := rollup(p_phone_sort,left.phoneno=right.phoneno,t_phone2(left,right),local);
p_phone_ct_1 := p_phone_ct(phoneno_ct=1);
*/

r_a := record
  string a_recordid;
  string a_xcode;
  string a_lsttyp;
  string a_npa;
  string a_telno;
  string a_lststy;
  string a_indent;
  string a_split;
  string a_fsn;
  string a_ftd;
  string a_lstnm;
  string a_lstgn;
  string a_hseno;
  string a_hsesx;
  string a_strt;
  string a_locnm;
  string a_state;
  string a_dirtx;
  string a_zip;
  string a_spltx;
  string a_nstel;
  string a_cnty;
  string a_dwelling;
  string a_geoacc;
  string a_geolat;
  string a_geolong;
  string a_mailable;
  string a_orig_loc;
  string a_orig_state;
  string a_orig_hseno;
  string a_orig_hsesx;
  string a_orig_strt;
  string a_orig_npa;
  string a_orig_telno;
  string a_orig_zip;
  string a_postal_type;
  string a_privacy;
  string a_vendor;
  string a_last_udt_date;
  string a_ven_reg;
  string18 a_seisintid;
  string3 a_bell_id;
  string11 a_filedate;
  string1 a_dual_name_flag;
  unsigned integer8 a_sequence_number;
  string1 a_listing_type_bus;
  string1 a_listing_type_res;
  string1 a_listing_type_gov;
  string1 a_publish_code;
  string1 a_style_code;
  string1 a_indent_code;
  string3 a_prior_area_code;
  string10 a_phone10;
  string60 a_special_listing_txt;
  string10 a_prim_range;
  string2 a_predir;
  string28 a_prim_name;
  string4 a_suffix;
  string2 a_postdir;
  string10 a_unit_desig;
  string8 a_sec_range;
  string25 a_p_city_name;
  string25 a_v_city_name;
  string2 a_st;
  string5 a_z5;
  string4 a_z4;
  string10 a_appnd_prim_range;
  string2 a_appnd_predir;
  string28 a_appnd_prim_name;
  string4 a_appnd_suffix;
  string2 a_appnd_postdir;
  string10 a_appnd_unit_desig;
  string8 a_appnd_sec_range;
  string25 a_appnd_p_city_name;
  string2 a_appnd_st;
  string5 a_appnd_z5;
  string4 a_appnd_z4;
  string4 a_cart;
  string1 a_cr_sort_sz;
  string4 a_lot;
  string1 a_lot_order;
  string2 a_dpbc;
  string1 a_chk_digit;
  string2 a_rec_type;
  string5 a_county_code;
  string10 a_geo_lat;
  string11 a_geo_long;
  string4 a_msa;
  string7 a_geo_blk;
  string1 a_geo_match;
  string4 a_err_stat;
  string32 a_designation;
  string5 a_name_prefix;
  string20 a_name_first;
  string20 a_name_middle;
  string20 a_name_last;
  string5 a_name_suffix;
  string120 a_company_name;
  string254 a_caption_text;
  string18 a_group_id;
  string10 a_group_seq;
  string1 a_omit_address;
  string1 a_omit_phone;
  string1 a_omit_locality;
  string1 a_privacy_flag;
  unsigned integer6 a_did;
  unsigned integer6 a_hhid;
  unsigned integer6 a_bdid;
  string8 a_dt_first_seen;
  string8 a_dt_last_seen;
  string1 a_current_record_flag;
  string8 a_deletion_date;
  unsigned integer2 a_disc_cnt6;
  unsigned integer2 a_disc_cnt12;
  unsigned integer2 a_disc_cnt18;
end;
 
//deletes
/*
r_d := record
  string d_temp_hseno;
  string d_temp_hsesx;
  string d_temp_strt;
  string d_temp_address1;
  string d_temp_address2;
  string d_temp_cap1;
  string d_temp_cap2;
  string d_temp_cap3;
  string d_temp_cap4;
  string d_temp_cap5;
  string d_temp_cap6;
  string d_temp_cap7;
  string5 d_name2_prefix;
  string20 d_name2_first;
  string20 d_name2_middle;
  string20 d_name2_last;
  string5 d_name2_suffix;
  string d_precleanname1;
  string d_precleanname2;
  string d_cleanname;
  string d_cleanname2;
  string d_recordid;
  string d_xcode;
  string d_lsttyp;
  string d_npa;
  string d_telno;
  string d_lststy;
  string d_indent;
  string d_split;
  string d_fsn;
  string d_ftd;
  string d_lstnm;
  string d_lstgn;
  string d_hseno;
  string d_hsesx;
  string d_strt;
  string d_locnm;
  string d_state;
  string d_dirtx;
  string d_zip;
  string d_spltx;
  string d_nstel;
  string d_cnty;
  string d_dwelling;
  string d_geoacc;
  string d_geolat;
  string d_geolong;
  string d_mailable;
  string d_orig_loc;
  string d_orig_state;
  string d_orig_hseno;
  string d_orig_hsesx;
  string d_orig_strt;
  string d_orig_npa;
  string d_orig_telno;
  string d_orig_zip;
  string d_postal_type;
  string d_privacy;
  string d_vendor;
  string d_last_udt_date;
  string d_ven_reg;
  string18 d_seisintid;
  string3 d_bell_id;
  string11 d_filedate;
  string1 d_dual_name_flag;
  unsigned integer8 d_sequence_number;
  string1 d_listing_type_bus;
  string1 d_listing_type_res;
  string1 d_listing_type_gov;
  string1 d_publish_code;
  string1 d_style_code;
  string1 d_indent_code;
  string3 d_prior_area_code;
  string10 d_phone10;
  string60 d_special_listing_txt;
  string10 d_prim_range;
  string2 d_predir;
  string28 d_prim_name;
  string4 d_suffix;
  string2 d_postdir;
  string10 d_unit_desig;
  string8 d_sec_range;
  string25 d_p_city_name;
  string25 d_v_city_name;
  string2 d_st;
  string5 d_z5;
  string4 d_z4;
  string10 d_appnd_prim_range;
  string2 d_appnd_predir;
  string28 d_appnd_prim_name;
  string4 d_appnd_suffix;
  string2 d_appnd_postdir;
  string10 d_appnd_unit_desig;
  string8 d_appnd_sec_range;
  string25 d_appnd_p_city_name;
  string2 d_appnd_st;
  string5 d_appnd_z5;
  string4 d_appnd_z4;
  string4 d_cart;
  string1 d_cr_sort_sz;
  string4 d_lot;
  string1 d_lot_order;
  string2 d_dpbc;
  string1 d_chk_digit;
  string2 d_rec_type;
  string5 d_county_code;
  string10 d_geo_lat;
  string11 d_geo_long;
  string4 d_msa;
  string7 d_geo_blk;
  string1 d_geo_match;
  string4 d_err_stat;
  string32 d_designation;
  string5 d_name_prefix;
  string20 d_name_first;
  string20 d_name_middle;
  string20 d_name_last;
  string5 d_name_suffix;
  string120 d_company_name;
  string254 d_caption_text;
  string18 d_group_id;
  string10 d_group_seq;
  string1 d_omit_address;
  string1 d_omit_phone;
  string1 d_omit_locality;
  string1 d_privacy_flag;
  unsigned integer6 d_did;
  unsigned integer6 d_hhid;
  unsigned integer6 d_bdid;
  string8 d_dt_first_seen;
  string8 d_dt_last_seen;
  string1 d_current_record_flag;
  string8 d_deletion_date;
  unsigned integer2 d_disc_cnt6;
  unsigned integer2 d_disc_cnt12;
  unsigned integer2 d_disc_cnt18;
end;
*/

r_d := record
  string d_del_dt;
  string d_original_add_dt;
  string d_recordid;
  string d_xcode;
  string d_lsttyp;
  string d_npa;
  string d_telno;
  string d_lststy;
  string d_indent;
  string d_split;
  string d_fsn;
  string d_ftd;
  string d_lstnm;
  string d_lstgn;
  string d_hseno;
  string d_hsesx;
  string d_strt;
  string d_locnm;
  string d_state;
  string d_dirtx;
  string d_zip;
  string d_spltx;
  string d_nstel;
  string d_cnty;
  string d_dwelling;
  string d_geoacc;
  string d_geolat;
  string d_geolong;
  string d_mailable;
  string d_orig_loc;
  string d_orig_state;
  string d_orig_hseno;
  string d_orig_hsesx;
  string d_orig_strt;
  string d_orig_npa;
  string d_orig_telno;
  string d_orig_zip;
  string d_postal_type;
  string d_privacy;
  string d_vendor;
  string d_last_udt_date;
  string d_ven_reg;
  string18 d_seisintid;
  string3 d_bell_id;
  string11 d_filedate;
  string1 d_dual_name_flag;
  unsigned integer8 d_sequence_number;
  string1 d_listing_type_bus;
  string1 d_listing_type_res;
  string1 d_listing_type_gov;
  string1 d_publish_code;
  string1 d_style_code;
  string1 d_indent_code;
  string3 d_prior_area_code;
  string10 d_phone10;
  string60 d_special_listing_txt;
  string10 d_prim_range;
  string2 d_predir;
  string28 d_prim_name;
  string4 d_suffix;
  string2 d_postdir;
  string10 d_unit_desig;
  string8 d_sec_range;
  string25 d_p_city_name;
  string25 d_v_city_name;
  string2 d_st;
  string5 d_z5;
  string4 d_z4;
  string10 d_appnd_prim_range;
  string2 d_appnd_predir;
  string28 d_appnd_prim_name;
  string4 d_appnd_suffix;
  string2 d_appnd_postdir;
  string10 d_appnd_unit_desig;
  string8 d_appnd_sec_range;
  string25 d_appnd_p_city_name;
  string2 d_appnd_st;
  string5 d_appnd_z5;
  string4 d_appnd_z4;
  string4 d_cart;
  string1 d_cr_sort_sz;
  string4 d_lot;
  string1 d_lot_order;
  string2 d_dpbc;
  string1 d_chk_digit;
  string2 d_rec_type;
  string5 d_county_code;
  string10 d_geo_lat;
  string11 d_geo_long;
  string4 d_msa;
  string7 d_geo_blk;
  string1 d_geo_match;
  string4 d_err_stat;
  string32 d_designation;
  string5 d_name_prefix;
  string20 d_name_first;
  string20 d_name_middle;
  string20 d_name_last;
  string5 d_name_suffix;
  string120 d_company_name;
  string254 d_caption_text;
  string18 d_group_id;
  string10 d_group_seq;
  string1 d_omit_address;
  string1 d_omit_phone;
  string1 d_omit_locality;
  string1 d_privacy_flag;
  unsigned integer6 d_did;
  unsigned integer6 d_hhid;
  unsigned integer6 d_bdid;
  string8 d_dt_first_seen;
  string8 d_dt_last_seen;
  string1 d_current_record_flag;
  string8 d_deletion_date;
  unsigned integer2 d_disc_cnt6;
  unsigned integer2 d_disc_cnt12;
  unsigned integer2 d_disc_cnt18;
end;

r_a t_a(todays_add_data le) := transform
  self.a_recordid	:= le.recordid;
  self.a_xcode	:= le.xcode;
  self.a_lsttyp	:= le.lsttyp;
  self.a_npa	:= le.npa;
  self.a_telno	:= le.telno;
  self.a_lststy	:= le.lststy;
  self.a_indent	:= le.indent;
  self.a_split	:= le.split;
  self.a_fsn	:= le.fsn;
  self.a_ftd	:= le.ftd;
  self.a_lstnm	:= le.lstnm;
  self.a_lstgn	:= le.lstgn;
  self.a_hseno	:= le.hseno;
  self.a_hsesx	:= le.hsesx;
  self.a_strt	:= le.strt;
  self.a_locnm	:= le.locnm;
  self.a_state	:= le.state;
  self.a_dirtx	:= le.dirtx;
  self.a_zip	:= le.zip;
  self.a_spltx	:= le.spltx;
  self.a_nstel	:= le.nstel;
  self.a_cnty	:= le.cnty;
  self.a_dwelling	:= le.dwelling;
  self.a_geoacc	:= le.geoacc;
  self.a_geolat	:= le.geolat;
  self.a_geolong	:= le.geolong;
  self.a_mailable	:= le.mailable;
  self.a_orig_loc	:= le.orig_loc;
  self.a_orig_state	:= le.orig_state;
  self.a_orig_hseno	:= le.orig_hseno;
  self.a_orig_hsesx	:= le.orig_hsesx;
  self.a_orig_strt	:= le.orig_strt;
  self.a_orig_npa	:= le.orig_npa;
  self.a_orig_telno	:= le.orig_telno;
  self.a_orig_zip	:= le.orig_zip;
  self.a_postal_type	:= le.postal_type;
  self.a_privacy	:= le.privacy;
  self.a_vendor	:= le.vendor;
  self.a_last_udt_date	:= le.last_udt_date;
  self.a_ven_reg	:= le.ven_reg;
  self.a_seisintid	:= le.seisintid;
  self.a_bell_id	:= le.bell_id;
  self.a_filedate	:= le.filedate;
  self.a_dual_name_flag	:= le.dual_name_flag;
  self.a_sequence_number	:= le.sequence_number;
  self.a_listing_type_bus	:= le.listing_type_bus;
  self.a_listing_type_res	:= le.listing_type_res;
  self.a_listing_type_gov	:= le.listing_type_gov;
  self.a_publish_code	:= le.publish_code;
  self.a_style_code	:= le.style_code;
  self.a_indent_code	:= le.indent_code;
  self.a_prior_area_code	:= le.prior_area_code;
  self.a_phone10	:= le.phone10;
  self.a_special_listing_txt	:= le.special_listing_txt;
  self.a_prim_range	:= le.prim_range;
  self.a_predir	:= le.predir;
  self.a_prim_name	:= le.prim_name;
  self.a_suffix	:= le.suffix;
  self.a_postdir	:= le.postdir;
  self.a_unit_desig	:= le.unit_desig;
  self.a_sec_range	:= le.sec_range;
  self.a_p_city_name	:= le.p_city_name;
  self.a_v_city_name	:= le.v_city_name;
  self.a_st	:= le.st;
  self.a_z5	:= le.z5;
  self.a_z4	:= le.z4;
  self.a_appnd_prim_range	:= le.appnd_prim_range;
  self.a_appnd_predir	:= le.appnd_predir;
  self.a_appnd_prim_name	:= le.appnd_prim_name;
  self.a_appnd_suffix	:= le.appnd_suffix;
  self.a_appnd_postdir	:= le.appnd_postdir;
  self.a_appnd_unit_desig	:= le.appnd_unit_desig;
  self.a_appnd_sec_range	:= le.appnd_sec_range;
  self.a_appnd_p_city_name	:= le.appnd_p_city_name;
  self.a_appnd_st	:= le.appnd_st;
  self.a_appnd_z5	:= le.appnd_z5;
  self.a_appnd_z4	:= le.appnd_z4;
  self.a_cart	:= le.cart;
  self.a_cr_sort_sz	:= le.cr_sort_sz;
  self.a_lot	:= le.lot;
  self.a_lot_order	:= le.lot_order;
  self.a_dpbc	:= le.dpbc;
  self.a_chk_digit	:= le.chk_digit;
  self.a_rec_type	:= le.rec_type;
  self.a_county_code	:= le.county_code;
  self.a_geo_lat	:= le.geo_lat;
  self.a_geo_long	:= le.geo_long;
  self.a_msa	:= le.msa;
  self.a_geo_blk	:= le.geo_blk;
  self.a_geo_match	:= le.geo_match;
  self.a_err_stat	:= le.err_stat;
  self.a_designation	:= le.designation;
  self.a_name_prefix	:= le.name_prefix;
  self.a_name_first	:= le.name_first;
  self.a_name_middle	:= le.name_middle;
  self.a_name_last	:= le.name_last;
  self.a_name_suffix	:= le.name_suffix;
  self.a_company_name	:= le.company_name;
  self.a_caption_text	:= le.caption_text;
  self.a_group_id	:= le.group_id;
  self.a_group_seq	:= le.group_seq;
  self.a_omit_address	:= le.omit_address;
  self.a_omit_phone	:= le.omit_phone;
  self.a_omit_locality	:= le.omit_locality;
  self.a_privacy_flag	:= le.privacy_flag;
  self.a_did	:= le.did;
  self.a_hhid	:= le.hhid;
  self.a_bdid	:= le.bdid;
  self.a_dt_first_seen	:= le.dt_first_seen;
  self.a_dt_last_seen	:= le.dt_last_seen;
  self.a_current_record_flag	:= le.current_record_flag;
  self.a_deletion_date	:= le.deletion_date;
  self.a_disc_cnt6	:= le.disc_cnt6;
  self.a_disc_cnt12	:= le.disc_cnt12;
  self.a_disc_cnt18	:= le.disc_cnt18;
end;

/*
r_d t_d(todays_del_data le) := transform
  self.d_temp_hseno	:= le.temp_hseno;
  self.d_temp_hsesx	:= le.temp_hsesx;
  self.d_temp_strt	:= le.temp_strt;
  self.d_temp_address1	:= le.temp_address1;
  self.d_temp_address2	:= le.temp_address2;
  self.d_temp_cap1	:= le.temp_cap1;
  self.d_temp_cap2	:= le.temp_cap2;
  self.d_temp_cap3	:= le.temp_cap3;
  self.d_temp_cap4	:= le.temp_cap4;
  self.d_temp_cap5	:= le.temp_cap5;
  self.d_temp_cap6	:= le.temp_cap6;
  self.d_temp_cap7	:= le.temp_cap7;
  self.d_name2_prefix	:= le.name2_prefix;
  self.d_name2_first	:= le.name2_first;
  self.d_name2_middle	:= le.name2_middle;
  self.d_name2_last	:= le.name2_last;
  self.d_name2_suffix	:= le.name2_suffix;
  self.d_precleanname1	:= le.precleanname1;
  self.d_precleanname2	:= le.precleanname2;
  self.d_cleanname	:= le.cleanname;
  self.d_cleanname2	:= le.cleanname2;
  self.d_recordid	:= le.recordid;
  self.d_xcode	:= le.xcode;
  self.d_lsttyp	:= le.lsttyp;
  self.d_npa	:= le.npa;
  self.d_telno	:= le.telno;
  self.d_lststy	:= le.lststy;
  self.d_indent	:= le.indent;
  self.d_split	:= le.split;
  self.d_fsn	:= le.fsn;
  self.d_ftd	:= le.ftd;
  self.d_lstnm	:= le.lstnm;
  self.d_lstgn	:= le.lstgn;
  self.d_hseno	:= le.hseno;
  self.d_hsesx	:= le.hsesx;
  self.d_strt	:= le.strt;
  self.d_locnm	:= le.locnm;
  self.d_state	:= le.state;
  self.d_dirtx	:= le.dirtx;
  self.d_zip	:= le.zip;
  self.d_spltx	:= le.spltx;
  self.d_nstel	:= le.nstel;
  self.d_cnty	:= le.cnty;
  self.d_dwelling	:= le.dwelling;
  self.d_geoacc	:= le.geoacc;
  self.d_geolat	:= le.geolat;
  self.d_geolong	:= le.geolong;
  self.d_mailable	:= le.mailable;
  self.d_orig_loc	:= le.orig_loc;
  self.d_orig_state	:= le.orig_state;
  self.d_orig_hseno	:= le.orig_hseno;
  self.d_orig_hsesx	:= le.orig_hsesx;
  self.d_orig_strt	:= le.orig_strt;
  self.d_orig_npa	:= le.orig_npa;
  self.d_orig_telno	:= le.orig_telno;
  self.d_orig_zip	:= le.orig_zip;
  self.d_postal_type	:= le.postal_type;
  self.d_privacy	:= le.privacy;
  self.d_vendor	:= le.vendor;
  self.d_last_udt_date	:= le.last_udt_date;
  self.d_ven_reg	:= le.ven_reg;
  self.d_seisintid	:= le.seisintid;
  self.d_bell_id	:= le.bell_id;
  self.d_filedate	:= le.filedate;
  self.d_dual_name_flag	:= le.dual_name_flag;
  self.d_sequence_number	:= le.sequence_number;
  self.d_listing_type_bus	:= le.listing_type_bus;
  self.d_listing_type_res	:= le.listing_type_res;
  self.d_listing_type_gov	:= le.listing_type_gov;
  self.d_publish_code	:= le.publish_code;
  self.d_style_code	:= le.style_code;
  self.d_indent_code	:= le.indent_code;
  self.d_prior_area_code	:= le.prior_area_code;
  self.d_phone10	:= le.phone10;
  self.d_special_listing_txt	:= le.special_listing_txt;
  self.d_prim_range	:= le.prim_range;
  self.d_predir	:= le.predir;
  self.d_prim_name	:= le.prim_name;
  self.d_suffix	:= le.suffix;
  self.d_postdir	:= le.postdir;
  self.d_unit_desig	:= le.unit_desig;
  self.d_sec_range	:= le.sec_range;
  self.d_p_city_name	:= le.p_city_name;
  self.d_v_city_name	:= le.v_city_name;
  self.d_st	:= le.st;
  self.d_z5	:= le.z5;
  self.d_z4	:= le.z4;
  self.d_appnd_prim_range	:= le.appnd_prim_range;
  self.d_appnd_predir	:= le.appnd_predir;
  self.d_appnd_prim_name	:= le.appnd_prim_name;
  self.d_appnd_suffix	:= le.appnd_suffix;
  self.d_appnd_postdir	:= le.appnd_postdir;
  self.d_appnd_unit_desig	:= le.appnd_unit_desig;
  self.d_appnd_sec_range	:= le.appnd_sec_range;
  self.d_appnd_p_city_name	:= le.appnd_p_city_name;
  self.d_appnd_st	:= le.appnd_st;
  self.d_appnd_z5	:= le.appnd_z5;
  self.d_appnd_z4	:= le.appnd_z4;
  self.d_cart	:= le.cart;
  self.d_cr_sort_sz	:= le.cr_sort_sz;
  self.d_lot	:= le.lot;
  self.d_lot_order	:= le.lot_order;
  self.d_dpbc	:= le.dpbc;
  self.d_chk_digit	:= le.chk_digit;
  self.d_rec_type	:= le.rec_type;
  self.d_county_code	:= le.county_code;
  self.d_geo_lat	:= le.geo_lat;
  self.d_geo_long	:= le.geo_long;
  self.d_msa	:= le.msa;
  self.d_geo_blk	:= le.geo_blk;
  self.d_geo_match	:= le.geo_match;
  self.d_err_stat	:= le.err_stat;
  self.d_designation	:= le.designation;
  self.d_name_prefix	:= le.name_prefix;
  self.d_name_first	:= le.name_first;
  self.d_name_middle	:= le.name_middle;
  self.d_name_last	:= le.name_last;
  self.d_name_suffix	:= le.name_suffix;
  self.d_company_name	:= le.company_name;
  self.d_caption_text	:= le.caption_text;
  self.d_group_id	:= le.group_id;
  self.d_group_seq	:= le.group_seq;
  self.d_omit_address	:= le.omit_address;
  self.d_omit_phone	:= le.omit_phone;
  self.d_omit_locality	:= le.omit_locality;
  self.d_privacy_flag	:= le.privacy_flag;
  self.d_did	:= le.did;
  self.d_hhid	:= le.hhid;
  self.d_bdid	:= le.bdid;
  self.d_dt_first_seen	:= le.dt_first_seen;
  self.d_dt_last_seen	:= le.dt_last_seen;
  self.d_current_record_flag	:= le.current_record_flag;
  self.d_deletion_date	:= le.deletion_date;
  self.d_disc_cnt6	:= le.disc_cnt6;
  self.d_disc_cnt12	:= le.disc_cnt12;
  self.d_disc_cnt18	:= le.disc_cnt18;
end;
*/

r_d t_d(todays_del_data le) := transform
  self.d_del_dt := le.del_dt;
  self.d_original_add_dt := le.original_add_dt;
  self.d_recordid	:= le.recordid;
  self.d_xcode	:= le.xcode;
  self.d_lsttyp	:= le.lsttyp;
  self.d_npa	:= le.npa;
  self.d_telno	:= le.telno;
  self.d_lststy	:= le.lststy;
  self.d_indent	:= le.indent;
  self.d_split	:= le.split;
  self.d_fsn	:= le.fsn;
  self.d_ftd	:= le.ftd;
  self.d_lstnm	:= le.lstnm;
  self.d_lstgn	:= le.lstgn;
  self.d_hseno	:= le.hseno;
  self.d_hsesx	:= le.hsesx;
  self.d_strt	:= le.strt;
  self.d_locnm	:= le.locnm;
  self.d_state	:= le.state;
  self.d_dirtx	:= le.dirtx;
  self.d_zip	:= le.zip;
  self.d_spltx	:= le.spltx;
  self.d_nstel	:= le.nstel;
  self.d_cnty	:= le.cnty;
  self.d_dwelling	:= le.dwelling;
  self.d_geoacc	:= le.geoacc;
  self.d_geolat	:= le.geolat;
  self.d_geolong	:= le.geolong;
  self.d_mailable	:= le.mailable;
  self.d_orig_loc	:= le.orig_loc;
  self.d_orig_state	:= le.orig_state;
  self.d_orig_hseno	:= le.orig_hseno;
  self.d_orig_hsesx	:= le.orig_hsesx;
  self.d_orig_strt	:= le.orig_strt;
  self.d_orig_npa	:= le.orig_npa;
  self.d_orig_telno	:= le.orig_telno;
  self.d_orig_zip	:= le.orig_zip;
  self.d_postal_type	:= le.postal_type;
  self.d_privacy	:= le.privacy;
  self.d_vendor	:= le.vendor;
  self.d_last_udt_date	:= le.last_udt_date;
  self.d_ven_reg	:= le.ven_reg;
  self.d_seisintid	:= le.seisintid;
  self.d_bell_id	:= le.bell_id;
  self.d_filedate	:= le.filedate;
  self.d_dual_name_flag	:= le.dual_name_flag;
  self.d_sequence_number	:= le.sequence_number;
  self.d_listing_type_bus	:= le.listing_type_bus;
  self.d_listing_type_res	:= le.listing_type_res;
  self.d_listing_type_gov	:= le.listing_type_gov;
  self.d_publish_code	:= le.publish_code;
  self.d_style_code	:= le.style_code;
  self.d_indent_code	:= le.indent_code;
  self.d_prior_area_code	:= le.prior_area_code;
  self.d_phone10	:= le.phone10;
  self.d_special_listing_txt	:= le.special_listing_txt;
  self.d_prim_range	:= le.prim_range;
  self.d_predir	:= le.predir;
  self.d_prim_name	:= le.prim_name;
  self.d_suffix	:= le.suffix;
  self.d_postdir	:= le.postdir;
  self.d_unit_desig	:= le.unit_desig;
  self.d_sec_range	:= le.sec_range;
  self.d_p_city_name	:= le.p_city_name;
  self.d_v_city_name	:= le.v_city_name;
  self.d_st	:= le.st;
  self.d_z5	:= le.z5;
  self.d_z4	:= le.z4;
  self.d_appnd_prim_range	:= le.appnd_prim_range;
  self.d_appnd_predir	:= le.appnd_predir;
  self.d_appnd_prim_name	:= le.appnd_prim_name;
  self.d_appnd_suffix	:= le.appnd_suffix;
  self.d_appnd_postdir	:= le.appnd_postdir;
  self.d_appnd_unit_desig	:= le.appnd_unit_desig;
  self.d_appnd_sec_range	:= le.appnd_sec_range;
  self.d_appnd_p_city_name	:= le.appnd_p_city_name;
  self.d_appnd_st	:= le.appnd_st;
  self.d_appnd_z5	:= le.appnd_z5;
  self.d_appnd_z4	:= le.appnd_z4;
  self.d_cart	:= le.cart;
  self.d_cr_sort_sz	:= le.cr_sort_sz;
  self.d_lot	:= le.lot;
  self.d_lot_order	:= le.lot_order;
  self.d_dpbc	:= le.dpbc;
  self.d_chk_digit	:= le.chk_digit;
  self.d_rec_type	:= le.rec_type;
  self.d_county_code	:= le.county_code;
  self.d_geo_lat	:= le.geo_lat;
  self.d_geo_long	:= le.geo_long;
  self.d_msa	:= le.msa;
  self.d_geo_blk	:= le.geo_blk;
  self.d_geo_match	:= le.geo_match;
  self.d_err_stat	:= le.err_stat;
  self.d_designation	:= le.designation;
  self.d_name_prefix	:= le.name_prefix;
  self.d_name_first	:= le.name_first;
  self.d_name_middle	:= le.name_middle;
  self.d_name_last	:= le.name_last;
  self.d_name_suffix	:= le.name_suffix;
  self.d_company_name	:= le.company_name;
  self.d_caption_text	:= le.caption_text;
  self.d_group_id	:= le.group_id;
  self.d_group_seq	:= le.group_seq;
  self.d_omit_address	:= le.omit_address;
  self.d_omit_phone	:= le.omit_phone;
  self.d_omit_locality	:= le.omit_locality;
  self.d_privacy_flag	:= le.privacy_flag;
  self.d_did	:= le.did;
  self.d_hhid	:= le.hhid;
  self.d_bdid	:= le.bdid;
  self.d_dt_first_seen	:= le.dt_first_seen;
  self.d_dt_last_seen	:= le.dt_last_seen;
  self.d_current_record_flag	:= le.current_record_flag;
  self.d_deletion_date	:= le.deletion_date;
  self.d_disc_cnt6	:= le.disc_cnt6;
  self.d_disc_cnt12	:= le.disc_cnt12;
  self.d_disc_cnt18	:= le.disc_cnt18;
end;
p_a := project(todays_add_data,t_a(left));
p_d := project(todays_del_data,t_d(left));

r_a_d := record
  string11 a_filedate;
  string11 d_del_dt;
  string11 d_original_add_dt;
  string11 d_filedate;
  
  string a_recordid;
  string d_recordid;
  string a_xcode;
  string d_xcode;
  string a_lsttyp;
  string d_lsttyp;
  string a_npa;
  string d_npa;
  string a_telno;
  string d_telno;
  string a_lststy;
  string d_lststy;
  string a_indent;
  string d_indent;
  string a_split;
  string d_split;
  string a_fsn;
  string d_fsn;
  string a_ftd;
  string d_ftd;
  string a_lstnm;
  string d_lstnm;
  string a_lstgn;
  string d_lstgn;
  string a_hseno;
  string d_hseno;
  string a_hsesx;
  string d_hsesx;
  string a_strt;
  string d_strt;
  string a_locnm;
  string d_locnm;
  string a_state;
  string d_state;
  string a_dirtx;
  string d_dirtx;
  string a_zip;
  string d_zip;
  string a_spltx;
  string d_spltx;
  string a_nstel;
  string d_nstel;
  string a_cnty;
  string d_cnty;
  string a_dwelling;
  string d_dwelling;
  string a_geoacc;
  string d_geoacc;
  string a_geolat;
  string d_geolat;
  string a_geolong;
  string d_geolong;
  string a_mailable;
  string d_mailable;
  string a_orig_loc;
  string d_orig_loc;
  string a_orig_state;
  string d_orig_state;
  string a_orig_hseno;
  string d_orig_hseno;
  string a_orig_hsesx;
  string d_orig_hsesx;
  string a_orig_strt;
  string d_orig_strt;
  string a_orig_npa;
  string d_orig_npa;
  string a_orig_telno;
  string d_orig_telno;
  string a_orig_zip;
  string d_orig_zip;
  string a_postal_type;
  string d_postal_type;
  string a_privacy;
  string d_privacy;
  string a_vendor;
  string d_vendor;
  string a_last_udt_date;
  string d_last_udt_date;
  string a_ven_reg;
  string d_ven_reg;
  string18 a_seisintid;
  string18 d_seisintid;
  string3 a_bell_id;
  string3 d_bell_id;

  string1 a_dual_name_flag;
  string1 d_dual_name_flag;
  unsigned integer8 a_sequence_number;
  unsigned integer8 d_sequence_number;
  string1 a_listing_type_bus;
  string1 d_listing_type_bus;
  string1 a_listing_type_res;
  string1 d_listing_type_res;
  string1 a_listing_type_gov;
  string1 d_listing_type_gov;
  string1 a_publish_code;
  string1 d_publish_code;
  string1 a_style_code;
  string1 d_style_code;
  string1 a_indent_code;
  string1 d_indent_code;
  string3 a_prior_area_code;
  string3 d_prior_area_code;
  string10 a_phone10;
  string10 d_phone10;
  string60 a_special_listing_txt;
  string60 d_special_listing_txt;
  string10 a_prim_range;
  string10 d_prim_range;
  string2 a_predir;
  string2 d_predir;
  string28 a_prim_name;
  string28 d_prim_name;
  string4 a_suffix;
  string4 d_suffix;
  string2 a_postdir;
  string2 d_postdir;
  string10 a_unit_desig;
  string10 d_unit_desig;
  string8 a_sec_range;
  string8 d_sec_range;
  string25 a_p_city_name;
  string25 d_p_city_name;
  string25 a_v_city_name;
  string25 d_v_city_name;
  string2 a_st;
  string2 d_st;
  string5 a_z5;
  string5 d_z5;
  string4 a_z4;
  string4 d_z4;
  string10 a_appnd_prim_range;
  string10 d_appnd_prim_range;
  string2 a_appnd_predir;
  string2 d_appnd_predir;
  string28 a_appnd_prim_name;
  string28 d_appnd_prim_name;
  string4 a_appnd_suffix;
  string4 d_appnd_suffix;
  string2 a_appnd_postdir;
  string2 d_appnd_postdir;
  string10 a_appnd_unit_desig;
  string10 d_appnd_unit_desig;
  string8 a_appnd_sec_range;
  string8 d_appnd_sec_range;
  string25 a_appnd_p_city_name;
  string25 d_appnd_p_city_name;
  string2 a_appnd_st;
  string2 d_appnd_st;
  string5 a_appnd_z5;
  string5 d_appnd_z5;
  string4 a_appnd_z4;
  string4 d_appnd_z4;
  string4 a_cart;
  string4 d_cart;
  string1 a_cr_sort_sz;
  string1 d_cr_sort_sz;
  string4 a_lot;
  string4 d_lot;
  string1 a_lot_order;
  string1 d_lot_order;
  string2 a_dpbc;
  string2 d_dpbc;
  string1 a_chk_digit;
  string1 d_chk_digit;
  string2 a_rec_type;
  string2 d_rec_type;
  string5 a_county_code;
  string5 d_county_code;
  string10 a_geo_lat;
  string10 d_geo_lat;
  string11 a_geo_long;
  string11 d_geo_long;
  string4 a_msa;
  string4 d_msa;
  string7 a_geo_blk;
  string7 d_geo_blk;
  string1 a_geo_match;
  string1 d_geo_match;
  string4 a_err_stat;
  string4 d_err_stat;
  string32 a_designation;
  string32 d_designation;
  string5 a_name_prefix;
  string5 d_name_prefix;
  string20 a_name_first;
  string20 d_name_first;
  string20 a_name_middle;
  string20 d_name_middle;
  string20 a_name_last;
  string20 d_name_last;
  string5 a_name_suffix;
  string5 d_name_suffix;
  string120 a_company_name;
  string120 d_company_name;
  string254 a_caption_text;
  string254 d_caption_text;
  string18 a_group_id;
  string18 d_group_id;
  string10 a_group_seq;
  string10 d_group_seq;
  string1 a_omit_address;
  string1 d_omit_address;
  string1 a_omit_phone;
  string1 d_omit_phone;
  string1 a_omit_locality;
  string1 d_omit_locality;
  string1 a_privacy_flag;
  string1 d_privacy_flag;
  unsigned integer6 a_did;
  unsigned integer6 d_did;
  unsigned integer6 a_hhid;
  unsigned integer6 d_hhid;
  unsigned integer6 a_bdid;
  unsigned integer6 d_bdid;
  string8 a_dt_first_seen;
  string8 d_dt_first_seen;
  string8 a_dt_last_seen;
  string8 d_dt_last_seen;
  string1 a_current_record_flag;
  string1 d_current_record_flag;
  string8 a_deletion_date;
  string8 d_deletion_date;
  unsigned integer2 a_disc_cnt6;
  unsigned integer2 d_disc_cnt6;
  unsigned integer2 a_disc_cnt12;
  unsigned integer2 d_disc_cnt12;
  unsigned integer2 a_disc_cnt18;
  unsigned integer2 d_disc_cnt18;
end;

r_out := record

 boolean   phone_match;
 boolean   name_match;
 string1   name_match_type;
 
 boolean   addr_match;
 string1   addr_match_type;
 
 
 r_a_d;
 //string    a_recordid;
 //string    d_recordid;
 
 //string    a_filedate;
 //string    d_filedate;
 
 //string    a_npa;
 //string    a_telno;
 //string    d_npa;
 //string    d_telno;
 //string    a_phone10;
 //string    d_phone10;
 
 //string    a_fsn;
 //string    d_fsn;
  
 //string    a_hseno;
 //string    a_strt;
 //string    a_locnm;
 //string    a_state;
 //string    a_zip;

 //string    d_hseno;
 //string    d_strt;
 //string    d_locnm;
 //string    d_state;
 //string    d_zip;
end;

a_phone_dist := distribute(p_a(a_phone10<>''),hash(a_phone10));
d_phone_dist := distribute(p_d(d_phone10<>''),hash(d_phone10));

/////////////////////////////////////// MATCHING BY PHONE

r_out t_phone_join(a_phone_dist le, d_phone_dist ri) := transform

 boolean v_raw_name_match   := le.a_fsn=ri.d_fsn;;
 boolean v_clean_name_match := le.a_name_first=ri.d_name_first and le.a_name_middle=ri.d_name_middle and le.a_name_last=ri.d_name_last and le.a_name_suffix=ri.d_name_suffix;
 
 boolean v_raw_addr_match   := le.a_hseno=ri.d_hseno and le.a_strt=ri.d_strt and le.a_locnm=ri.d_locnm and le.a_state=ri.d_state and le.a_zip=ri.d_zip;
 boolean v_clean_addr_match := le.a_prim_range=ri.d_prim_range and le.a_prim_name=ri.d_prim_name and le.a_sec_range=ri.d_sec_range and le.a_z5=ri.d_z5;
 
 self.phone_match := le.a_phone10=ri.d_phone10;
 self.name_match := v_raw_name_match=true or v_clean_name_match=true;
 self.name_match_type := if(v_raw_name_match=true,'R',if(v_clean_name_match=true,'C',''));
 self.addr_match := v_raw_addr_match=true or v_clean_addr_match=true;
 self.addr_match_type := if(v_raw_addr_match=true,'R',if(v_clean_addr_match=true,'C',''));
 
 self             := le;
 self             := ri;
end;

j_phone_join := join(a_phone_dist,d_phone_dist,left.a_phone10=right.d_phone10,t_phone_join(left,right),left outer,local);

/////////////////////////////////////// MATCHING BY ADDRESS

r_out t_addr_join(p_a le, p_d ri) := transform

 boolean v_raw_name_match   := le.a_fsn=ri.d_fsn;;
 boolean v_clean_name_match := le.a_name_first=ri.d_name_first and le.a_name_middle=ri.d_name_middle and le.a_name_last=ri.d_name_last and le.a_name_suffix=ri.d_name_suffix;
 
 boolean v_raw_addr_match   := le.a_hseno=ri.d_hseno and le.a_strt=ri.d_strt and le.a_locnm=ri.d_locnm and le.a_state=ri.d_state and le.a_zip=ri.d_zip;
 boolean v_clean_addr_match := le.a_prim_range=ri.d_prim_range and le.a_prim_name=ri.d_prim_name and le.a_sec_range=ri.d_sec_range and le.a_z5=ri.d_z5;
 
 //self.phone_match := le.a_npa=ri.d_npa and le.a_telno=ri.d_telno;
 self.phone_match := le.a_phone10=ri.d_phone10;
 //self.name_match  := le.a_fsn=ri.d_fsn;
 self.name_match := v_raw_name_match=true or v_clean_name_match=true;
 self.name_match_type := if(v_raw_name_match=true,'R',if(v_clean_name_match=true,'C',''));
 //self.addr_match  := le.a_hseno=ri.d_hseno and le.a_strt=ri.d_strt and le.a_locnm=ri.d_locnm and le.a_state=ri.d_state and le.a_zip=ri.d_zip;
 self.addr_match := v_raw_addr_match=true or v_clean_addr_match=true;
 self.addr_match_type := if(v_raw_addr_match=true,'R',if(v_clean_addr_match=true,'C',''));
 
 self             := le;
 self             := ri;
end;

//join was too complex to do it in one join
j_addr_join1 := join(p_a(((a_hseno<>'' or a_strt<>'') and a_zip<>'')),
                     p_d(((d_hseno<>'' or d_strt<>'') and d_zip<>'')),
                      (left.a_hseno=right.d_hseno and left.a_strt=right.d_strt and left.a_locnm=right.d_locnm and left.a_state=right.d_state and left.a_zip=right.d_zip)
					  ,t_addr_join(left,right),left outer,local);

j_addr_join2 := join(p_a(((a_prim_range<>'' or a_prim_name<>'') and a_z5<>'')),
                     p_d(((d_prim_range<>'' or d_prim_name<>'') and d_z5<>'')),
					  (left.a_prim_range=right.d_prim_range and left.a_prim_name=right.d_prim_name and left.a_sec_range=right.d_sec_range and left.a_z5=right.d_z5)
					  ,t_addr_join(left,right),left outer,local);
					  
//////////////////////////////////////////////////////

export QSent_Linking_JTrost := parallel(

//output(j_phone_join);
output(j_phone_join(phone_match=true));

//output(j_addr_join1);
output(j_addr_join1(addr_match=true));

//output(j_addr_join2);
output(j_addr_join2(addr_match=true)));