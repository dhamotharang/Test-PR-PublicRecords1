EXPORT ScoredCentroids(dsGraph) := FUNCTIONMACRO
// Eventually we need to support passing in sets of scores to produce these.
  GraphData := DEDUP(SORT(dsGraph, cluster_id), cluster_id);
  TopCentroids := 
	 TABLE(TOPN(GraphData(al_cohesivity<1.6 and al_totalcnt<20), 100, -al_fact1_cnt_1, -al_fact1_cnt_0),{ cluster_id, name, IsInputRecord, al_fact1_cnt,al_fact1_cnt_0,al_fact1_cnt_1,al_fact1_cnt_2,al_fact2_cnt,al_fact2_cnt_0,al_fact2_cnt_1,al_fact2_cnt_2,al_fact3_cnt,al_fact3_cnt_0,al_fact3_cnt_1,al_fact3_cnt_2,al_fact4_cnt,al_fact4_cnt_0,al_fact4_cnt_1,al_fact4_cnt_2,al_fact5_cnt,al_fact5_cnt_0,al_fact5_cnt_1,al_fact5_cnt_2,al_sum1,al_totalcnt,al_firstdegrees,al_seconddegrees,al_cohesivity,facttype:=1, score := al_fact1_cnt}) +
   TABLE(TOPN(GraphData(al_cohesivity<1.6 and al_totalcnt<20), 100, -al_fact2_cnt_1, -al_fact2_cnt_0),{ cluster_id, name, IsInputRecord, al_fact1_cnt,al_fact1_cnt_0,al_fact1_cnt_1,al_fact1_cnt_2,al_fact2_cnt,al_fact2_cnt_0,al_fact2_cnt_1,al_fact2_cnt_2,al_fact3_cnt,al_fact3_cnt_0,al_fact3_cnt_1,al_fact3_cnt_2,al_fact4_cnt,al_fact4_cnt_0,al_fact4_cnt_1,al_fact4_cnt_2,al_fact5_cnt,al_fact5_cnt_0,al_fact5_cnt_1,al_fact5_cnt_2,al_sum1,al_totalcnt,al_firstdegrees,al_seconddegrees,al_cohesivity,facttype:=2, score := al_fact2_cnt}) +
   TABLE(TOPN(GraphData(al_cohesivity<1.6 and al_totalcnt<20), 100, -al_fact3_cnt_1, -al_fact3_cnt_0),{ cluster_id, name, IsInputRecord, al_fact1_cnt,al_fact1_cnt_0,al_fact1_cnt_1,al_fact1_cnt_2,al_fact2_cnt,al_fact2_cnt_0,al_fact2_cnt_1,al_fact2_cnt_2,al_fact3_cnt,al_fact3_cnt_0,al_fact3_cnt_1,al_fact3_cnt_2,al_fact4_cnt,al_fact4_cnt_0,al_fact4_cnt_1,al_fact4_cnt_2,al_fact5_cnt,al_fact5_cnt_0,al_fact5_cnt_1,al_fact5_cnt_2,al_sum1,al_totalcnt,al_firstdegrees,al_seconddegrees,al_cohesivity,facttype:=3, score := al_fact3_cnt}) +
   TABLE(TOPN(GraphData(al_cohesivity<1.6 and al_totalcnt<20), 100, -al_fact4_cnt_1, -al_fact4_cnt_0),{ cluster_id, name, IsInputRecord, al_fact1_cnt,al_fact1_cnt_0,al_fact1_cnt_1,al_fact1_cnt_2,al_fact2_cnt,al_fact2_cnt_0,al_fact2_cnt_1,al_fact2_cnt_2,al_fact3_cnt,al_fact3_cnt_0,al_fact3_cnt_1,al_fact3_cnt_2,al_fact4_cnt,al_fact4_cnt_0,al_fact4_cnt_1,al_fact4_cnt_2,al_fact5_cnt,al_fact5_cnt_0,al_fact5_cnt_1,al_fact5_cnt_2,al_sum1,al_totalcnt,al_firstdegrees,al_seconddegrees,al_cohesivity,facttype:=4, score := al_fact4_cnt}) +
   TABLE(TOPN(GraphData(al_cohesivity<1.6 and al_totalcnt<20), 100, -al_fact5_cnt_1, -al_fact5_cnt_0),{ cluster_id, name, IsInputRecord, al_fact1_cnt,al_fact1_cnt_0,al_fact1_cnt_1,al_fact1_cnt_2,al_fact2_cnt,al_fact2_cnt_0,al_fact2_cnt_1,al_fact2_cnt_2,al_fact3_cnt,al_fact3_cnt_0,al_fact3_cnt_1,al_fact3_cnt_2,al_fact4_cnt,al_fact4_cnt_0,al_fact4_cnt_1,al_fact4_cnt_2,al_fact5_cnt,al_fact5_cnt_0,al_fact5_cnt_1,al_fact5_cnt_2,al_sum1,al_totalcnt,al_firstdegrees,al_seconddegrees,al_cohesivity,facttype:=5, score := al_fact5_cnt});
  RETURN TopCentroids;
ENDMACRO;