IMPORT SALT311,STD;
EXPORT Moxie_Court_Offenses_Dev_Delta(DATASET(Moxie_Court_Offenses_Dev_Layout_crim)old_s, DATASET(Moxie_Court_Offenses_Dev_Layout_crim) new_s) := MODULE//Routines to compute the differences between two instances of a file
  SHARED inFieldList := ['process_date','offender_key','vendor','state_origin','source_file','data_type','off_comp','off_delete_flag','off_date','arr_date','num_of_counts','le_agency_cd','le_agency_desc','le_agency_case_number','traffic_ticket_number','traffic_dl_no','traffic_dl_st','arr_off_code','arr_off_desc_1','arr_off_desc_2','arr_off_type_cd','arr_off_type_desc','arr_off_lev','arr_statute','arr_statute_desc','arr_disp_date','arr_disp_code','arr_disp_desc_1','arr_disp_desc_2','pros_refer_cd','pros_refer','pros_assgn_cd','pros_assgn','pros_chg_rej','pros_off_code','pros_off_desc_1','pros_off_desc_2','pros_off_type_cd','pros_off_type_desc','pros_off_lev','pros_act_filed','court_case_number','court_cd','court_desc','court_appeal_flag','court_final_plea','court_off_code','court_off_desc_1','court_off_desc_2','court_off_type_cd','court_off_type_desc','court_off_lev','court_statute','court_additional_statutes','court_statute_desc','court_disp_date','court_disp_code','court_disp_desc_1','court_disp_desc_2','sent_date','sent_jail','sent_susp_time','sent_court_cost','sent_court_fine','sent_susp_court_fine','sent_probation','sent_addl_prov_code','sent_addl_prov_desc_1','sent_addl_prov_desc_2','sent_consec','sent_agency_rec_cust_ori','sent_agency_rec_cust','appeal_date','appeal_off_disp','appeal_final_decision','convict_dt','offense_town','cty_conv','restitution','community_service','parole','addl_sent_dates','probation_desc2','court_dt','court_county','arr_off_lev_mapped','court_off_lev_mapped','fcra_offense_key','fcra_conviction_flag','fcra_traffic_flag','fcra_date','fcra_date_type','conviction_override_date','conviction_override_date_type','offense_score','offense_persistent_id','offense_category'];
  EXPORT Differences := SALT311.mod_Delta.mac_DifferencesByFieldList(old_s, new_s, inFieldList);
  EXPORT DifferenceSummary(BOOLEAN Glob = TRUE) := Moxie_Court_Offenses_Dev_hygiene(old_s).Summary('Old',Glob) + Moxie_Court_Offenses_Dev_hygiene(new_s).Summary('New',Glob) + Moxie_Court_Offenses_Dev_hygiene(PROJECT(Differences(deleted), TRANSFORM(Moxie_Court_Offenses_Dev_Layout_crim, SELF := LEFT.old_rec))).Summary('Deletions',Glob) + Moxie_Court_Offenses_Dev_hygiene(PROJECT(Differences(added), TRANSFORM(Moxie_Court_Offenses_Dev_Layout_crim, SELF := LEFT.new_rec))).Summary('Additions',Glob);
  EXPORT StandardStats(BOOLEAN doHygieneSummaryGlobal = TRUE, BOOLEAN doHygieneSummaryPerSrc = TRUE) := FUNCTION
    myTimeStamp := (UNSIGNED6)SALT311.Fn_Now('YYYYMMDDHHMMSS') : INDEPENDENT;
    hygieneDiffOverall := DifferenceSummary(TRUE);
    hygieneDiffPerSrc := DifferenceSummary(FALSE);
    SALT311.mod_StandardStatsTransforms.mac_hygieneSummaryTransform(Scrubs_Crim, Moxie_Court_Offenses_Dev_Fields, 'RECORDOF(hygieneDiffOverall)', TRUE);
    hygieneDiffOverall_Standard := IF(doHygieneSummaryGlobal, NORMALIZE(hygieneDiffOverall, COUNT(inFieldList) * 6, xSummary(LEFT, COUNTER, myTimeStamp, LEFT.txt + '_all', LEFT.txt + '_all')));
    hygieneDiffPerSrc_Standard := IF(doHygieneSummaryPerSrc, NORMALIZE(hygieneDiffPerSrc, COUNT(inFieldList) * 6, xSummary(LEFT, COUNTER, myTimeStamp, LEFT.txt + '_src', LEFT.txt + '_src')));
 
    RETURN hygieneDiffOverall_Standard & hygieneDiffPerSrc_Standard;
  END;
END;
