import official_records, lib_keylib,lib_fileservices,ut,Standard;

// party_roxie Full File

party_roxie_fullfile := dataset('~thor_200::base::official_records_party_roxie',Standard.official_records_party,thor);

party_roxie_increment := dataset('~thor_200::in::official_records_party_roxie_'+official_records.Version_Development,standard.official_records_party,thor);

concat_party_roxie_funnel :=  party_roxie_fullfile(~(state_origin = 'FL' and trim(county_name_origin) = 'MIAMI-DADE')) + party_roxie_increment;

Standard.official_records_party proj_party_rec(concat_party_roxie_funnel l) := transform
	self.county_name_origin := if ( l.county_name_origin = 'MIAMI DADE','MIAMI-DADE',l.county_name_origin);
	self := l;
end;

concat_party_roxie := project(concat_party_roxie_funnel,proj_party_rec(left));

sort_party_roxie := sort(concat_party_roxie,vendor,
state_origin,
county_name_origin,
official_record_key,
doc_instrument_or_clerk_filing_num,
doc_filed_date,
doc_type_desc,
entity_sequence,
entity_type_code,
entity_type_desc,
entity_name,
entity_name_format,
dob,
ssn,
pname_1_title,
pname_1_fname,
pname_1_mname,
pname_1_lname,
pname_1_name_suffix,
pname_1_name_score,
cname_1,
pname_2_title,
pname_2_fname,
pname_2_mname,
pname_2_lname,
pname_2_name_suffix,
pname_2_name_score,
cname_2,
pname_3_title,
pname_3_fname,
pname_3_mname,
pname_3_lname,
pname_3_name_suffix,
pname_3_name_score,
cname_3,
pname_4_title,
pname_4_fname,
pname_4_mname,
pname_4_lname,
pname_4_name_suffix,
pname_4_name_score,
cname_4,
pname_5_title,
pname_5_fname,
pname_5_mname,
pname_5_lname,
pname_5_name_suffix,
pname_5_name_score,
cname_5,-process_date);

dedup_concat_party_roxie := dedup(sort_party_roxie,vendor,
state_origin,
county_name_origin,
official_record_key,
doc_instrument_or_clerk_filing_num,
doc_filed_date,
doc_type_desc,
entity_sequence,
entity_type_code,
entity_type_desc,
entity_name,
entity_name_format,
dob,
ssn,
pname_1_title,
pname_1_fname,
pname_1_mname,
pname_1_lname,
pname_1_name_suffix,
pname_1_name_score,
cname_1,
pname_2_title,
pname_2_fname,
pname_2_mname,
pname_2_lname,
pname_2_name_suffix,
pname_2_name_score,
cname_2,
pname_3_title,
pname_3_fname,
pname_3_mname,
pname_3_lname,
pname_3_name_suffix,
pname_3_name_score,
cname_3,
pname_4_title,
pname_4_fname,
pname_4_mname,
pname_4_lname,
pname_4_name_suffix,
pname_4_name_score,
cname_4,
pname_5_title,
pname_5_fname,
pname_5_mname,
pname_5_lname,
pname_5_name_suffix,
pname_5_name_score,
cname_5);

output_party_roxie := output(dedup_concat_party_roxie,,'~thor_200::in::official_records_party_roxie_full_'+official_records.Version_Development,__compressed__,overwrite);


// document_roxie Full File

document_roxie_fullfile := dataset('~thor_200::base::official_records_document_roxie',Standard.official_records_document,thor);

document_roxie_increment := dataset('~thor_200::in::official_records_document_roxie_'+official_records.Version_Development,Standard.official_records_document,thor);

concat_document_roxie_funnel :=  document_roxie_fullfile(~(state_origin = 'FL' and trim(county_name_origin) = 'MIAMI-DADE')) + document_roxie_increment;

Standard.official_records_document proj_document_rec(concat_document_roxie_funnel l) := transform
	self.county_name_origin := if ( l.county_name_origin = 'MIAMI DADE','MIAMI-DADE',l.county_name_origin);
	self := l;
end;

concat_document_roxie := project(concat_document_roxie_funnel,proj_document_rec(left));

sort_document_roxie := sort(concat_document_roxie,vendor,
state_origin,
county_name_origin,
fips_st_origin,
fips_county_origin,
official_record_key,
batch_id,
doc_serial_num,
doc_instrument_or_clerk_filing_num,
doc_num_dummy_flag,
doc_filed_date,
doc_record_date,
doc_type_code,
doc_type_desc,
doc_other_desc,
doc_page_count,
doc_names_count,
doc_status_code,
doc_status_desc,
doc_amend_code,
doc_amend_desc,
execution_date,
consideration_amount,
assumption_amount,
certified_mail_fee,
service_charge,
trust_amount,
transfer_amount,
mortgage,
intangible_tax_amount,
intangible_tax_penalty,
excise_tax_amount,
recording_fee,
documentary_stamps_fee,
doc_stamps_mtg_fee,
book_num,
page_num,
book_type_code,
book_type_desc,
parcel_or_case_num,
formatted_parcel_num,
legal_desc_1,
legal_desc_2,
legal_desc_3,
legal_desc_4,
legal_desc_5,
verified_flag,
address_line_1,
address_line_2,
address_line_3,
address_line_4,
prior_doc_file_num,
prior_doc_type_code,
prior_doc_type_desc,
prior_book_num,
prior_page_num,
prior_book_type_code,
prior_book_type_desc,
prim_range,
predir,
prim_name,
addr_suffix,
postdir,
unit_desig,
sec_range,
v_city_name,
st,
zip5,
zip4,
addr_rec_type,
fips_state,
fips_county,
geo_lat,
geo_long,
cbsa,
geo_blk,
geo_match,
err_stat,-process_date);

dedup_concat_document_roxie := dedup(sort_document_roxie,vendor,
state_origin,
county_name_origin,
fips_st_origin,
fips_county_origin,
official_record_key,
batch_id,
doc_serial_num,
doc_instrument_or_clerk_filing_num,
doc_num_dummy_flag,
doc_filed_date,
doc_record_date,
doc_type_code,
doc_type_desc,
doc_other_desc,
doc_page_count,
doc_names_count,
doc_status_code,
doc_status_desc,
doc_amend_code,
doc_amend_desc,
execution_date,
consideration_amount,
assumption_amount,
certified_mail_fee,
service_charge,
trust_amount,
transfer_amount,
mortgage,
intangible_tax_amount,
intangible_tax_penalty,
excise_tax_amount,
recording_fee,
documentary_stamps_fee,
doc_stamps_mtg_fee,
book_num,
page_num,
book_type_code,
book_type_desc,
parcel_or_case_num,
formatted_parcel_num,
legal_desc_1,
legal_desc_2,
legal_desc_3,
legal_desc_4,
legal_desc_5,
verified_flag,
address_line_1,
address_line_2,
address_line_3,
address_line_4,
prior_doc_file_num,
prior_doc_type_code,
prior_doc_type_desc,
prior_book_num,
prior_page_num,
prior_book_type_code,
prior_book_type_desc,
prim_range,
predir,
prim_name,
addr_suffix,
postdir,
unit_desig,
sec_range,
v_city_name,
st,
zip5,
zip4,
addr_rec_type,
fips_state,
fips_county,
geo_lat,
geo_long,
cbsa,
geo_blk,
geo_match,
err_stat
);

output_document_roxie := output(dedup_concat_document_roxie,,'~thor_200::in::official_records_document_roxie_full_'+official_records.Version_Development,__compressed__,overwrite);

// Super File Transaction - party_roxie

superfile_transaction_party_roxie := sequential(output_party_roxie,
				FileServices.StartSuperFileTransaction(),
				FileServices.AddSuperFile('~thor_200::base::official_records_party_roxie_delete','~thor_200::base::official_records_party_roxie_grandfather',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_party_roxie_grandfather'),
				FileServices.AddSuperFile('~thor_200::base::official_records_party_roxie_grandfather','~thor_200::base::official_records_party_roxie_father',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_party_roxie_father'),
				FileServices.AddSuperFile('~thor_200::base::official_records_party_roxie_father', '~thor_200::base::official_records_party_roxie',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_party_roxie'),
				FileServices.AddSuperFile('~thor_200::base::official_records_party_roxie', '~thor_200::in::official_records_party_roxie_full_'+official_records.Version_Development),
				FileServices.FinishSuperFileTransaction(),
				FileServices.ClearSuperFile('~thor_200::base::official_records_party_roxie_delete',true));
				
// Super File Transaction - document_roxie

superfile_transaction_document_roxie := sequential(output_document_roxie,
				FileServices.StartSuperFileTransaction(),
				FileServices.AddSuperFile('~thor_200::base::official_records_document_roxie_delete','~thor_200::base::official_records_document_roxie_grandfather',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_document_roxie_grandfather'),
				FileServices.AddSuperFile('~thor_200::base::official_records_document_roxie_grandfather','~thor_200::base::official_records_document_roxie_father',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_document_roxie_father'),
				FileServices.AddSuperFile('~thor_200::base::official_records_document_roxie_father', '~thor_200::base::official_records_document_roxie',, true),
				FileServices.ClearSuperFile('~thor_200::base::official_records_document_roxie'),
				FileServices.AddSuperFile('~thor_200::base::official_records_document_roxie', '~thor_200::in::official_records_document_roxie_full_'+official_records.Version_Development),
				FileServices.FinishSuperFileTransaction(),
				FileServices.ClearSuperFile('~thor_200::base::official_records_document_roxie_delete',true));
				

export Roxie_Official_Records_Full_File := parallel(superfile_transaction_party_roxie,superfile_transaction_document_roxie);