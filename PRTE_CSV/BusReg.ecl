IMPORT BusReg, PRTE_BIP, PRTE_CSV, ut;

EXPORT BusReg(STRING pversion = '') := MODULE

	EXPORT ds_BusReg  := prte_csv.BusReg_Files(pversion).input_busreg.using;

	//Produce roxie keys for busreg	
	//Build Company Bdid key	
  PRTE_CSV.BusReg_Key_Layouts.rthor_data400__key__busreg__company_bdid CompBdid(RECORDOF(ds_BusReg) L) := TRANSFORM
    SELF.bdid                              := L.bdid;
    SELF.br_id                             := L.br_id;
    SELF.dt_first_seen                     := (STRING)L.dt_first_seen;
    SELF.dt_last_seen                      := (STRING)L.dt_last_seen;
    SELF.record_type                       := L.record_type;
    SELF.record_date                       := (STRING)L.record_date;
    SELF.ofc1_name                         := L.rawfields.ofc1_name;
    SELF.ofc1_title                        := L.rawfields.ofc1_title;
    SELF.first_name                        := L.rawfields.first;
    SELF.mi                                := L.rawfields.mi;
    SELF.last_name                         := L.rawfields.last;
    SELF.suffix                            := L.rawfields.suffix;
    SELF.gender                            := L.rawfields.gender;
    SELF.ownr_code                         := L.rawfields.ownr_code;
    SELF.xcode                             := L.rawfields.xcode;
    SELF.company_name                      := L.rawfields.company;
    SELF.mail_add                          := L.rawfields.mail_add;
    SELF.mail_suite                        := L.rawfields.mail_suite;
    SELF.mail_city                         := L.rawfields.mail_city;
    SELF.mail_state                        := L.rawfields.mail_state;
    SELF.mail_zip_orig                     := L.rawfields.mail_zip;
    SELF.mail_zip4_orig                    := L.rawfields.mail_zip4;
    SELF.mail_key                          := L.rawfields.mail_key;
    SELF.county                            := L.rawfields.county;
    SELF.country                           := L.rawfields.country;
    SELF.district                          := L.rawfields.district;
    SELF.citylimits                        := L.rawfields.citylimits;
    SELF.biz_ac                            := L.rawfields.biz_ac;
    SELF.biz_phone                         := L.rawfields.biz_phone;
    SELF.fax_ac                            := L.rawfields.fax_ac;
    SELF.fax_num                           := L.rawfields.fax_num;
    SELF.sic                               := L.rawfields.sic;
    SELF.naics                             := L.rawfields.naics;
    SELF.descript                          := L.rawfields.descript;
    SELF.emp_size                          := L.rawfields.emp_size;
    SELF.own_size                          := L.rawfields.own_size;
    SELF.corpcode                          := L.rawfields.corpcode;
    SELF.sos_code                          := L.rawfields.sos_code;
    SELF.filing_cod                        := L.rawfields.filing_cod;
    SELF.state_code                        := L.rawfields.state_code;
    SELF.status                            := L.rawfields.status;
    SELF.stat_des                          := L.rawfields.stat_des;
    SELF.lic_sts                           := L.rawfields.lic_sts;
    SELF.lic_type                          := L.rawfields.lic_type;
    SELF.filing_num                        := L.rawfields.filing_num;
    SELF.licid                             := L.rawfields.licid;
    SELF.acct_num                          := L.rawfields.acct_num;
    SELF.co_fei                            := L.rawfields.co_fei;
    SELF.ctrl_num                          := L.rawfields.ctrl_num;
    SELF.start_date                        := L.rawfields.start_date;
    SELF.file_date                         := L.rawfields.file_date;
    SELF.ccyymmdd                          := L.rawfields.ccyymmdd;
    SELF.form_date                         := L.rawfields.form_date;
    SELF.exp_date                          := L.rawfields.exp_date;
    SELF.disol_date                        := L.rawfields.disol_date;
    SELF.rpt_date                          := L.rawfields.rpt_date;
    SELF.renew_date                        := L.rawfields.renew_date;
    SELF.chang_date                        := L.rawfields.chang_date;
    SELF.appt_date                         := L.rawfields.appt_date;
    SELF.fisc_date_                        := L.rawfields.fisc_date_;
    SELF.duration                          := L.rawfields.duration;
    SELF.loc_add                           := L.rawfields.loc_add;
    SELF.loc_suite                         := L.rawfields.loc_suite;
    SELF.loc_city                          := L.rawfields.loc_city;
    SELF.loc_state                         := L.rawfields.loc_state;
    SELF.loc_zip_orig                      := L.rawfields.loc_zip;
    SELF.loc_zip4_orig                     := L.rawfields.loc_zip4;
    SELF.loc_idx                           := L.rawfields.loc_idx;
    SELF.ofc1_add                          := L.rawfields.ofc1_add;
    SELF.ofc1_suite                        := L.rawfields.ofc1_suite;
    SELF.ofc1_city                         := L.rawfields.ofc1_city;
    SELF.ofc1_state                        := L.rawfields.ofc1_state;
    SELF.ofc1_zip_orig                     := L.rawfields.ofc1_zip;
    SELF.ofc1_ac                           := L.rawfields.ofc1_ac;
    SELF.ofc1_phone                        := L.rawfields.ofc1_phone;
    SELF.ofc1_fein                         := L.rawfields.ofc1_fein;
    SELF.ofc1_ssn                          := L.rawfields.ofc1_ssn;
    SELF.ofc1_type                         := L.rawfields.ofc1_type;
    SELF.ra_date                           := L.rawfields.ra_date;
    SELF.ra_file                           := L.rawfields.ra_file;
    SELF.ra_name                           := L.rawfields.ra_name;
    SELF.ra_add                            := L.rawfields.ra_add;
    SELF.ra_suite                          := L.rawfields.ra_suite;
    SELF.ra_city                           := L.rawfields.ra_city;
    SELF.ra_state                          := L.rawfields.ra_state;
    SELF.ra_zip_orig                       := L.rawfields.ra_zip;
    SELF.ra_ac                             := L.rawfields.ra_ac;
    SELF.ra_phone                          := L.rawfields.ra_phone;
    SELF.class                             := L.rawfields.class;
    SELF.stock_iss                         := L.rawfields.stock_iss;
    SELF.stock_par                         := L.rawfields.stock_par;
    SELF.stock_type                        := L.rawfields.stock_type;
    SELF.stock_cap                         := L.rawfields.stock_cap;
    SELF.paidn_cap                         := L.rawfields.paidn_cap;
    SELF.fee                               := L.rawfields.fee;
    SELF.fee_2                             := L.rawfields.fee_2;
    SELF.fee_3                             := L.rawfields.fee_3;
    SELF.tax_cl                            := L.rawfields.tax_cl;
    SELF.act                               := L.rawfields.act;
    SELF.chapter                           := L.rawfields.chapter;
    SELF.page                              := L.rawfields.page;
    SELF.volume                            := L.rawfields.volume;
    SELF.comments                          := L.rawfields.comments;
    SELF.email_addr                        := L.rawfields.email;
    SELF.user_name                         := L.rawfields.user_name;
    SELF.dsf                               := L.rawfields.dsf;
    SELF.hmbase                            := L.rawfields.hmbase;
    SELF.ho                                := L.rawfields.ho;
    SELF.solicit                           := L.rawfields.solicit;
    SELF.fips                              := L.rawfields.fips;
    SELF.record_no                         := L.rawfields.record_no;
    SELF.misc_code                         := L.rawfields.misc_code;
    SELF.agent_key                         := L.rawfields.agent_key;
    SELF.proc_date                         := L.rawfields.proc_date;
    SELF.mail_prim_range                   := L.clean_mailing_address.prim_range;
    SELF.mail_predir                       := L.clean_mailing_address.predir;
    SELF.mail_prim_name                    := L.clean_mailing_address.prim_name;
    SELF.mail_addr_suffix                  := L.clean_mailing_address.addr_suffix;
    SELF.mail_postdir                      := L.clean_mailing_address.postdir;
    SELF.mail_unit_desig                   := L.clean_mailing_address.unit_desig;
    SELF.mail_sec_range                    := L.clean_mailing_address.sec_range;
    SELF.mail_p_city_name                  := L.clean_mailing_address.p_city_name;
    SELF.mail_v_city_name                  := L.clean_mailing_address.v_city_name;
    SELF.mail_st                           := L.clean_mailing_address.st;
    SELF.mail_zip                          := L.clean_mailing_address.zip;
    SELF.mail_zip4                         := L.clean_mailing_address.zip4;
    SELF.mail_cart                         := L.clean_mailing_address.cart;
    SELF.mail_cr_sort_sz                   := L.clean_mailing_address.cr_sort_sz;
    SELF.mail_lot                          := L.clean_mailing_address.lot;
    SELF.mail_lot_order                    := L.clean_mailing_address.lot_order;
    SELF.mail_dpbc                         := L.clean_mailing_address.dbpc;
    SELF.mail_chk_digit                    := L.clean_mailing_address.chk_digit;
    SELF.mail_record_type                  := L.clean_mailing_address.rec_type;
    SELF.mail_ace_fips_st                  := L.clean_mailing_address.fips_state;
    SELF.mail_fipscounty                   := L.clean_mailing_address.fips_county;
    SELF.mail_geo_lat                      := L.clean_mailing_address.geo_lat;
    SELF.mail_geo_long                     := L.clean_mailing_address.geo_long;
    SELF.mail_msa                          := L.clean_mailing_address.msa;
    SELF.mail_geo_blk                      := L.clean_mailing_address.geo_blk;
    SELF.mail_geo_match                    := L.clean_mailing_address.geo_match;
    SELF.mail_err_stat                     := L.clean_mailing_address.err_stat;
    SELF.loc_prim_range                    := L.clean_location_address.prim_range;
    SELF.loc_predir                        := L.clean_location_address.predir;
    SELF.loc_prim_name                     := L.clean_location_address.prim_name;
    SELF.loc_addr_suffix                   := L.clean_location_address.addr_suffix;
    SELF.loc_postdir                       := L.clean_location_address.postdir;
    SELF.loc_unit_desig                    := L.clean_location_address.unit_desig;
    SELF.loc_sec_range                     := L.clean_location_address.sec_range;
    SELF.loc_p_city_name                   := L.clean_location_address.p_city_name;
    SELF.loc_v_city_name                   := L.clean_location_address.v_city_name;
    SELF.loc_st                            := L.clean_location_address.st;
    SELF.loc_zip                           := L.clean_location_address.zip;
    SELF.loc_zip4                          := L.clean_location_address.zip4;
    SELF.loc_cart                          := L.clean_location_address.cart;
    SELF.loc_cr_sort_sz                    := L.clean_location_address.cr_sort_sz;
    SELF.loc_lot                           := L.clean_location_address.lot;
    SELF.loc_lot_order                     := L.clean_location_address.lot_order;
    SELF.loc_dpbc                          := L.clean_location_address.dbpc;
    SELF.loc_chk_digit                     := L.clean_location_address.chk_digit;
    SELF.loc_record_type                   := L.clean_location_address.rec_type;
    SELF.loc_ace_fips_st                   := L.clean_location_address.fips_state;
    SELF.loc_fipscounty                    := L.clean_location_address.fips_county;
    SELF.loc_geo_lat                       := L.clean_location_address.geo_lat;
    SELF.loc_geo_long                      := L.clean_location_address.geo_long;
    SELF.loc_msa                           := L.clean_location_address.msa;
    SELF.loc_geo_blk                       := L.clean_location_address.geo_blk;
    SELF.loc_geo_match                     := L.clean_location_address.geo_match;
    SELF.loc_err_stat                      := L.clean_location_address.err_stat;
    SELF.ofc1_name_prefix                  := L.clean_officer1_name.title;
    SELF.ofc1_name_first                   := L.clean_officer1_name.fname;
    SELF.ofc1_name_middle                  := L.clean_officer1_name.mname;
    SELF.ofc1_name_last                    := L.clean_officer1_name.lname;
    SELF.ofc1_name_suffix                  := L.clean_officer1_name.name_suffix;
    SELF.ofc1_name_score                   := L.clean_officer1_name.name_score;
    SELF.ofc1_prim_range                   := L.clean_officer1_address.prim_range;
    SELF.ofc1_predir                       := L.clean_officer1_address.predir;
    SELF.ofc1_prim_name                    := L.clean_officer1_address.prim_name;
    SELF.ofc1_addr_suffix                  := L.clean_officer1_address.addr_suffix;
    SELF.ofc1_postdir                      := L.clean_officer1_address.postdir;
    SELF.ofc1_unit_desig                   := L.clean_officer1_address.unit_desig;
    SELF.ofc1_sec_range                    := L.clean_officer1_address.sec_range;
    SELF.ofc1_p_city_name                  := L.clean_officer1_address.p_city_name;
    SELF.ofc1_v_city_name                  := L.clean_officer1_address.v_city_name;
    SELF.ofc1_st                           := L.clean_officer1_address.st;
    SELF.ofc1_zip                          := L.clean_officer1_address.zip;
    SELF.ofc1_zip4                         := L.clean_officer1_address.zip4;
    SELF.ofc1_cart                         := L.clean_officer1_address.cart;
    SELF.ofc1_cr_sort_sz                   := L.clean_officer1_address.cr_sort_sz;
    SELF.ofc1_lot                          := L.clean_officer1_address.lot;
    SELF.ofc1_lot_order                    := L.clean_officer1_address.lot_order;
    SELF.ofc1_dpbc                         := L.clean_officer1_address.dbpc;
    SELF.ofc1_chk_digit                    := L.clean_officer1_address.chk_digit;
    SELF.ofc1_record_type                  := L.clean_officer1_address.rec_type;
    SELF.ofc1_ace_fips_st                  := L.clean_officer1_address.fips_state;
    SELF.ofc1_fipscounty                   := L.clean_officer1_address.fips_county;
    SELF.ofc1_geo_lat                      := L.clean_officer1_address.geo_lat;
    SELF.ofc1_geo_long                     := L.clean_officer1_address.geo_long;
    SELF.ofc1_msa                          := L.clean_officer1_address.msa;
    SELF.ofc1_geo_blk                      := L.clean_officer1_address.geo_blk;
    SELF.ofc1_geo_match                    := L.clean_officer1_address.geo_match;
    SELF.ofc1_err_stat                     := L.clean_officer1_address.err_stat;
    SELF.ra_prim_range                     := L.clean_ra_address.prim_range;
    SELF.ra_predir                         := L.clean_ra_address.predir;
    SELF.ra_prim_name                      := L.clean_ra_address.prim_name;
    SELF.ra_addr_suffix                    := L.clean_ra_address.addr_suffix;
    SELF.ra_postdir                        := L.clean_ra_address.postdir;
    SELF.ra_unit_desig                     := L.clean_ra_address.unit_desig;
    SELF.ra_sec_range                      := L.clean_ra_address.sec_range;
    SELF.ra_p_city_name                    := L.clean_ra_address.p_city_name;
    SELF.ra_v_city_name                    := L.clean_ra_address.v_city_name;
    SELF.ra_st                             := L.clean_ra_address.st;
    SELF.ra_zip                            := L.clean_ra_address.zip;
    SELF.ra_zip4                           := L.clean_ra_address.zip4;
    SELF.ra_cart                           := L.clean_ra_address.cart;
    SELF.ra_cr_sort_sz                     := L.clean_ra_address.cr_sort_sz;
    SELF.ra_lot                            := L.clean_ra_address.lot;
    SELF.ra_lot_order                      := L.clean_ra_address.lot_order;
    SELF.ra_dpbc                           := L.clean_ra_address.dbpc;
    SELF.ra_chk_digit                      := L.clean_ra_address.chk_digit;
    SELF.ra_record_type                    := L.clean_ra_address.rec_type;
    SELF.ra_ace_fips_st                    := L.clean_ra_address.fips_state;
    SELF.ra_fipscounty                     := L.clean_ra_address.fips_county;
    SELF.ra_geo_lat                        := L.clean_ra_address.geo_lat;
    SELF.ra_geo_long                       := L.clean_ra_address.geo_long;
    SELF.ra_msa                            := L.clean_ra_address.msa;
    SELF.ra_geo_blk                        := L.clean_ra_address.geo_blk;
    SELF.ra_geo_match                      := L.clean_ra_address.geo_match;
    SELF.ra_err_stat                       := L.clean_ra_address.err_stat;
    SELF.company_phone10                   := L.clean_phones.biz_phone;
    SELF.ofc1_phone10                      := L.clean_phones.ofc1_phone;
    SELF.ra_phone10                        := L.clean_phones.ra_phone;
		SELF 							                     := L;
		SELF 							                     := [];	  
	END;

	EXPORT dthor_data400__key__BusReg__company_bdid := PROJECT(ds_BusReg(TRIM(rawfields.company,ALL) <> ''), CompBdid(LEFT));


	//Build Contact did key	
  PRTE_CSV.BusReg_Key_Layouts.rthor_data400__key__busreg__contact_bdid ContBdid(RECORDOF(ds_BusReg) L) := TRANSFORM
    SELF.bdid                              := L.bdid;
    SELF.did                               := 0;
    SELF.br_id                             := L.br_id;
    SELF.dt_first_seen                     := (STRING)L.dt_first_seen;
    SELF.dt_last_seen                      := (STRING)L.dt_last_seen;
    SELF.record_type                       := L.record_type;
		
    SELF.name                              := L.rawfields.ofc1_name;
    SELF.title                             := L.rawfields.ofc1_title;		
    SELF.add                               := L.Clean_officer1_address1;
    SELF.csz                               := L.Clean_officer1_address2;
    SELF.fein                              := L.rawfields.ofc1_fein;
    SELF.ssn                               := L.rawfields.ofc1_ssn;
    SELF.phone                             := L.clean_phones.ofc1_phone;
		
    SELF.name_prefix                       := L.clean_officer1_name.title;
    SELF.name_first                        := L.clean_officer1_name.fname;
    SELF.name_middle                       := L.clean_officer1_name.mname;
    SELF.name_last                         := L.clean_officer1_name.lname;
    SELF.name_suffix                       := L.clean_officer1_name.name_suffix;
    SELF.name_score                        := L.clean_officer1_name.name_score;
		
    SELF.prim_range                        := L.clean_officer1_address.prim_range;
    SELF.predir                            := L.clean_officer1_address.predir;
    SELF.prim_name                         := L.clean_officer1_address.prim_name;
    SELF.addr_suffix                       := L.clean_officer1_address.addr_suffix;
    SELF.postdir                           := L.clean_officer1_address.postdir;
    SELF.unit_desig                        := L.clean_officer1_address.unit_desig;
    SELF.sec_range                         := L.clean_officer1_address.sec_range;
    SELF.p_city_name                       := L.clean_officer1_address.p_city_name;
    SELF.v_city_name                       := L.clean_officer1_address.v_city_name;
    SELF.st                                := L.clean_officer1_address.st;
    SELF.zip                               := L.clean_officer1_address.zip;
    SELF.zip4                              := L.clean_officer1_address.zip4;
    SELF.cart                              := L.clean_officer1_address.cart;
    SELF.cr_sort_sz                        := L.clean_officer1_address.cr_sort_sz;
    SELF.lot                               := L.clean_officer1_address.lot;
    SELF.lot_order                         := L.clean_officer1_address.lot_order;
    SELF.dpbc                              := L.clean_officer1_address.dbpc;
    SELF.chk_digit                         := L.clean_officer1_address.chk_digit;
    SELF.rec_type                          := L.clean_officer1_address.rec_type;
    SELF.ace_fips_st                       := L.clean_officer1_address.fips_state;
    SELF.fipscounty                        := L.clean_officer1_address.fips_county;
    SELF.geo_lat                           := L.clean_officer1_address.geo_lat;
    SELF.geo_long                          := L.clean_officer1_address.geo_long;
    SELF.msa                               := L.clean_officer1_address.msa;
    SELF.geo_blk                           := L.clean_officer1_address.geo_blk;
    SELF.geo_match                         := L.clean_officer1_address.geo_match;
    SELF.err_stat                          := L.clean_officer1_address.err_stat;
		SELF                                   := L;
		SELF                                   := [];
  END;
																																						 
	EXPORT dthor_data400__key__BusReg__contact_bdid := PROJECT(ds_BusReg(TRIM(clean_officer1_name.fname + clean_officer1_name.lname, ALL) <> ''), ContBdid(LEFT));


	//Build Linkids Key
	temp_layout := RECORD
		UNSIGNED8 	unique_id;
		RECORDOF(ds_BusReg);
	END;

	project_2_temp_layout				:= PROJECT(ds_BusReg, TRANSFORM(temp_layout, SELF := LEFT; SELF.unique_id := 0;));

	ut.MAC_Sequence_Records(project_2_temp_layout, unique_id, PROJECT_infile_2_temp_layout_seq);
	
	prte_bip.Layout_Append_FakeIDs.LinkIds MakeLinkIDLayout(temp_layout L) := TRANSFORM
	  SELF.company_name 	:= L.rawfields.company;
	  SELF.company_fein 	:= L.rawfields.co_fei;
	  SELF.prim_range 	  := L.Clean_mailing_address.prim_range;
	  SELF.prim_name 	    := L.Clean_mailing_address.prim_name;
	  SELF.sec_range 	    := L.Clean_mailing_address.sec_range;
	  SELF.p_city_name 	  := L.Clean_mailing_address.p_city_name;
	  SELF.v_city_name 	  := L.Clean_mailing_address.v_city_name;
	  SELF.st 	          := L.Clean_mailing_address.st;
	  SELF.zip            := L.Clean_mailing_address.zip;
	  SELF.zip4 	        := L.Clean_mailing_address.zip4;
	  SELF.fname 	        := L.clean_officer1_name.fname;
	  SELF.mname 	        := L.clean_officer1_name.mname;
	  SELF.lname 	        := L.clean_officer1_name.lname;
		SELF 							  := L;
		SELF 							  := [];
	END;
	
	project_2_fakeId_layout			:= PROJECT(project_infile_2_temp_layout_seq, MakeLinkIDLayout(LEFT));

	stamp_infile_with_linkids		:= prte_bip.fn_Append_Fake_LinkIDs(project_2_fakeId_layout);

	PRTE_CSV.BusReg_Key_Layouts.rthor_data400__key__busreg__company_linkids AssignIDs(temp_layout l, prte_bip.Layout_Append_FakeIDs.LinkIds r) := TRANSFORM
		SELF.DotID			:= r.DotID;
		SELF.DotScore		:= r.DotScore;
		SELF.DotWeight	:= r.DotWeight;
		SELF.EmpID			:= r.EmpID;
		SELF.EmpScore		:= r.EmpScore;
		SELF.EmpWeight	:= r.EmpWeight;
		SELF.POWID			:= r.POWID;
		SELF.POWScore		:= r.POWScore;
		SELF.POWWeight	:= r.POWWeight;
		SELF.ProxID			:= r.ProxID;
		SELF.ProxScore	:= r.ProxScore;
		SELF.ProxWeight	:= r.ProxWeight;
		SELF.SELEID			:= r.SELEID;
		SELF.SELEScore	:= r.SELEScore;
		SELF.SELEWeight	:= r.SELEWeight;	
		SELF.OrgID			:= r.OrgID;
		SELF.OrgScore		:= r.OrgScore;
		SELF.OrgWeight	:= r.OrgWeight;
		SELF.UltID			:= r.UltID;
		SELF.UltScore		:= r.UltScore;
		SELF.UltWeight	:= r.UltWeight;
		SELF 						:= l;
		SELF						:= [];
	END;

	stamped_busreg_company_linkids										  := JOIN(project_infile_2_temp_layout_seq,
																														  stamp_infile_with_linkids,
																														  LEFT.unique_id = RIGHT.unique_id,
																														  AssignIDs(LEFT, RIGHT),
																														  LEFT OUTER);

	EXPORT dthor_data400__key__BusReg__company_linkids	:= stamped_busreg_company_linkids(ut.fnTrim2Upper(rawfields.company)<>'');
																																														 
END;