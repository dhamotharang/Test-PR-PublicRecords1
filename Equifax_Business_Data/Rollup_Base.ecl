IMPORT ut;

EXPORT Rollup_Base(DATASET(Equifax_Business_Data.Layouts.Base) pDataset) := FUNCTION

	pDataset_Dist := DISTRIBUTE(pDataset, HASH(efx_id));
	pDataset_sort := SORT( pDataset_Dist 
												,EFX_ID
												,EFX_NAME
												,EFX_LEGAL_NAME
												,EFX_ADDRESS
												,EFX_CITY
												,EFX_STATE
												,EFX_STATEC
												,EFX_ZIPCODE
												,EFX_ZIP4
												,EFX_LAT
												,EFX_LON
												,EFX_GEOPREC
												,EFX_REGION
												,EFX_CTRYISOCD
												,EFX_CTRYNUM
												,EFX_CTRYNAME
												,EFX_COUNTYNM
												,EFX_COUNTY
												,EFX_CMSA
												,EFX_CMSADESC
												,EFX_SOHO
												,EFX_BIZ
												,EFX_RES
												,EFX_CMRA
												,EFX_CONGRESS
												,EFX_SECADR
												,EFX_SECCTY
												,EFX_SECSTAT
												,EFX_STATEC2
												,EFX_SECZIP
												,EFX_SECZIP4
												,EFX_SECLAT
												,EFX_SECLON
												,EFX_SECGEOPREC
												,EFX_SECREGION
												,EFX_SECCTRYISOCD
												,EFX_SECCTRYNUM
												,EFX_SECCTRYNAME
												,EFX_CTRYTELCD
												,EFX_PHONE
												,EFX_FAXPHONE
												,EFX_BUSSTAT
												,EFX_BUSSTATCD
												,EFX_WEB
												,EFX_YREST
												,EFX_CORPEMPCNT
												,EFX_LOCEMPCNT
												,EFX_CORPEMPCD
												,EFX_LOCEMPCD
												,EFX_CORPAMOUNT
												,EFX_CORPAMOUNTCD
												,EFX_CORPAMOUNTTP
												,EFX_CORPAMOUNTPREC
												,EFX_LOCAMOUNT
												,EFX_LOCAMOUNTCD
												,EFX_LOCAMOUNTTP
												,EFX_LOCAMOUNTPREC
												,EFX_PUBLIC
												,EFX_STKEXC
												,EFX_TCKSYM
												,EFX_PRIMSIC
												,EFX_SECSIC1
												,EFX_SECSIC2
												,EFX_SECSIC3
												,EFX_SECSIC4
												,EFX_PRIMSICDESC
												,EFX_SECSICDESC1
												,EFX_SECSICDESC2
												,EFX_SECSICDESC3
												,EFX_SECSICDESC4
												,EFX_PRIMNAICSCODE
												,EFX_SECNAICS1
												,EFX_SECNAICS2
												,EFX_SECNAICS3
												,EFX_SECNAICS4
												,EFX_PRIMNAICSDESC
												,EFX_SECNAICSDESC1
												,EFX_SECNAICSDESC2
												,EFX_SECNAICSDESC3
												,EFX_SECNAICSDESC4
												,EFX_DEAD
												,EFX_DEADDT
												,EFX_MRKT_TELEVER
												,EFX_MRKT_TELESCORE
												,EFX_MRKT_TOTALSCORE
												,EFX_MRKT_TOTALIND
												,EFX_MRKT_VACANT
												,EFX_MRKT_SEASONAL
												,EFX_MBE
												,EFX_WBE
												,EFX_MWBE
												,EFX_SDB
												,EFX_HUBZONE
												,EFX_DBE
												,EFX_VET
												,EFX_DVET
												,EFX_8a
												,EFX_8aEXPDT
												,EFX_DIS
												,EFX_SBE
												,EFX_BUSSIZE
												,EFX_LBE
												,EFX_GOV
												,EFX_FGOV
												,EFX_GOV1057
												,EFX_NONPROFIT
												,EFX_MERCTYPE
												,EFX_HBCU
												,EFX_GAYLESBIAN
												,EFX_WSBE
												,EFX_VSBE
												,EFX_DVSBE
												,EFX_MWBESTATUS
												,EFX_NMSDC
												,EFX_WBENC
												,EFX_CA_PUC
												,EFX_TX_HUB
												,EFX_TX_HUBCERTNUM
												,EFX_GSAX
												,EFX_CALTRANS
												,EFX_EDU
												,EFX_MI
												,EFX_ANC
												,AT_CERT1
												,AT_CERT2
												,AT_CERT3
												,AT_CERT4
												,AT_CERT5
												,AT_CERT6
												,AT_CERT7
												,AT_CERT8
												,AT_CERT9
												,AT_CERT10
												,AT_CERTDESC1
												,AT_CERTDESC2
												,AT_CERTDESC3
												,AT_CERTDESC4
												,AT_CERTDESC5
												,AT_CERTDESC6
												,AT_CERTDESC7
												,AT_CERTDESC8
												,AT_CERTDESC9
												,AT_CERTDESC10
												,AT_CERTSRC1
												,AT_CERTSRC2
												,AT_CERTSRC3
												,AT_CERTSRC4
												,AT_CERTSRC5
												,AT_CERTSRC6
												,AT_CERTSRC7
												,AT_CERTSRC8
												,AT_CERTSRC9
												,AT_CERTSRC10
												,AT_CERTLEV1
												,AT_CERTLEV2
												,AT_CERTLEV3
												,AT_CERTLEV4
												,AT_CERTLEV5
												,AT_CERTLEV6
												,AT_CERTLEV7
												,AT_CERTLEV8
												,AT_CERTLEV9
												,AT_CERTLEV10
												,AT_CERTNUM1
												,AT_CERTNUM2
												,AT_CERTNUM3
												,AT_CERTNUM4
												,AT_CERTNUM5
												,AT_CERTNUM6
												,AT_CERTNUM7
												,AT_CERTNUM8
												,AT_CERTNUM9
												,AT_CERTNUM10
												,AT_CERTEXP1
												,AT_CERTEXP2
												,AT_CERTEXP3
												,AT_CERTEXP4
												,AT_CERTEXP5
												,AT_CERTEXP6
												,AT_CERTEXP7
												,AT_CERTEXP8
												,AT_CERTEXP9
												,AT_CERTEXP10
												,EFX_EXTRACT_DATE
												,EFX_FOREIGN
                        ,Record_Update_Refresh_Date
												,EFX_DATE_CREATED
												,NormCompany_Name
												,NormCompany_Type
												,Norm_Address
												,NormAddress_Type
												,LOCAL );
	
	Equifax_Business_Data.Layouts.Base RollupUpdate(Equifax_Business_Data.Layouts.Base L, Equifax_Business_Data.Layouts.Base R) := TRANSFORM
		
		Earliest_Date                 := ut.EarliestDate(L.dt_vendor_first_reported, R.dt_vendor_first_reported);
		
		SELF.dt_first_seen 						:= ut.EarliestDate(ut.EarliestDate(L.dt_first_seen, R.dt_first_seen)
																						        ,ut.EarliestDate(L.dt_last_seen,  R.dt_last_seen));
		SELF.dt_last_seen 						:= max(L.dt_last_seen, R.dt_last_seen);
		SELF.dt_vendor_last_reported 	:= max(L.dt_vendor_last_reported, R.dt_vendor_last_reported);
		SELF.dt_vendor_first_reported := Earliest_Date;
		SELF.record_type							:= IF(L.record_type = 'C' OR R.record_type = 'C', 'C', 'H');
		SELF.rcid						          := IF(Earliest_Date = L.dt_vendor_first_reported, L.rcid, R.rcid);  //Use the earliest rcid

		SELF                          := L;
	END;

	pDataset_rollup := ROLLUP(pDataset_sort
														,RollupUpdate(LEFT, RIGHT)
															,EFX_ID
												,EFX_NAME
												,EFX_LEGAL_NAME
												,EFX_ADDRESS
												,EFX_CITY
												,EFX_STATE
												,EFX_STATEC
												,EFX_ZIPCODE
												,EFX_ZIP4
												,EFX_LAT
												,EFX_LON
												,EFX_GEOPREC
												,EFX_REGION
												,EFX_CTRYISOCD
												,EFX_CTRYNUM
												,EFX_CTRYNAME
												,EFX_COUNTYNM
												,EFX_COUNTY
												,EFX_CMSA
												,EFX_CMSADESC
												,EFX_SOHO
												,EFX_BIZ
												,EFX_RES
												,EFX_CMRA
												,EFX_CONGRESS
												,EFX_SECADR
												,EFX_SECCTY
												,EFX_SECSTAT
												,EFX_STATEC2
												,EFX_SECZIP
												,EFX_SECZIP4
												,EFX_SECLAT
												,EFX_SECLON
												,EFX_SECGEOPREC
												,EFX_SECREGION
												,EFX_SECCTRYISOCD
												,EFX_SECCTRYNUM
												,EFX_SECCTRYNAME
												,EFX_CTRYTELCD
												,EFX_PHONE
												,EFX_FAXPHONE
												,EFX_BUSSTAT
												,EFX_BUSSTATCD
												,EFX_WEB
												,EFX_YREST
												,EFX_CORPEMPCNT
												,EFX_LOCEMPCNT
												,EFX_CORPEMPCD
												,EFX_LOCEMPCD
												,EFX_CORPAMOUNT
												,EFX_CORPAMOUNTCD
												,EFX_CORPAMOUNTTP
												,EFX_CORPAMOUNTPREC
												,EFX_LOCAMOUNT
												,EFX_LOCAMOUNTCD
												,EFX_LOCAMOUNTTP
												,EFX_LOCAMOUNTPREC
												,EFX_PUBLIC
												,EFX_STKEXC
												,EFX_TCKSYM
												,EFX_PRIMSIC
												,EFX_SECSIC1
												,EFX_SECSIC2
												,EFX_SECSIC3
												,EFX_SECSIC4
												,EFX_PRIMSICDESC
												,EFX_SECSICDESC1
												,EFX_SECSICDESC2
												,EFX_SECSICDESC3
												,EFX_SECSICDESC4
												,EFX_PRIMNAICSCODE
												,EFX_SECNAICS1
												,EFX_SECNAICS2
												,EFX_SECNAICS3
												,EFX_SECNAICS4
												,EFX_PRIMNAICSDESC
												,EFX_SECNAICSDESC1
												,EFX_SECNAICSDESC2
												,EFX_SECNAICSDESC3
												,EFX_SECNAICSDESC4
												,EFX_DEAD
												,EFX_DEADDT
												,EFX_MRKT_TELEVER
												,EFX_MRKT_TELESCORE
												,EFX_MRKT_TOTALSCORE
												,EFX_MRKT_TOTALIND
												,EFX_MRKT_VACANT
												,EFX_MRKT_SEASONAL
												,EFX_MBE
												,EFX_WBE
												,EFX_MWBE
												,EFX_SDB
												,EFX_HUBZONE
												,EFX_DBE
												,EFX_VET
												,EFX_DVET
												,EFX_8a
												,EFX_8aEXPDT
												,EFX_DIS
												,EFX_SBE
												,EFX_BUSSIZE
												,EFX_LBE
												,EFX_GOV
												,EFX_FGOV
												,EFX_GOV1057
												,EFX_NONPROFIT
												,EFX_MERCTYPE
												,EFX_HBCU
												,EFX_GAYLESBIAN
												,EFX_WSBE
												,EFX_VSBE
												,EFX_DVSBE
												,EFX_MWBESTATUS
												,EFX_NMSDC
												,EFX_WBENC
												,EFX_CA_PUC
												,EFX_TX_HUB
												,EFX_TX_HUBCERTNUM
												,EFX_GSAX
												,EFX_CALTRANS
												,EFX_EDU
												,EFX_MI
												,EFX_ANC
												,AT_CERT1
												,AT_CERT2
												,AT_CERT3
												,AT_CERT4
												,AT_CERT5
												,AT_CERT6
												,AT_CERT7
												,AT_CERT8
												,AT_CERT9
												,AT_CERT10
												,AT_CERTDESC1
												,AT_CERTDESC2
												,AT_CERTDESC3
												,AT_CERTDESC4
												,AT_CERTDESC5
												,AT_CERTDESC6
												,AT_CERTDESC7
												,AT_CERTDESC8
												,AT_CERTDESC9
												,AT_CERTDESC10
												,AT_CERTSRC1
												,AT_CERTSRC2
												,AT_CERTSRC3
												,AT_CERTSRC4
												,AT_CERTSRC5
												,AT_CERTSRC6
												,AT_CERTSRC7
												,AT_CERTSRC8
												,AT_CERTSRC9
												,AT_CERTSRC10
												,AT_CERTLEV1
												,AT_CERTLEV2
												,AT_CERTLEV3
												,AT_CERTLEV4
												,AT_CERTLEV5
												,AT_CERTLEV6
												,AT_CERTLEV7
												,AT_CERTLEV8
												,AT_CERTLEV9
												,AT_CERTLEV10
												,AT_CERTNUM1
												,AT_CERTNUM2
												,AT_CERTNUM3
												,AT_CERTNUM4
												,AT_CERTNUM5
												,AT_CERTNUM6
												,AT_CERTNUM7
												,AT_CERTNUM8
												,AT_CERTNUM9
												,AT_CERTNUM10
												,AT_CERTEXP1
												,AT_CERTEXP2
												,AT_CERTEXP3
												,AT_CERTEXP4
												,AT_CERTEXP5
												,AT_CERTEXP6
												,AT_CERTEXP7
												,AT_CERTEXP8
												,AT_CERTEXP9
												,AT_CERTEXP10
												,EFX_EXTRACT_DATE
												,EFX_FOREIGN
                        ,Record_Update_Refresh_Date
												,NormCompany_Name
												,NormCompany_Type
												,Norm_Address
												,NormAddress_Type
												,LOCAL );

	RETURN pDataset_rollup;

END;