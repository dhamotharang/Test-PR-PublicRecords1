IMPORT SALT311,STD;
EXPORT Delta(DATASET(Layout_Property_Characteristics)old_s, DATASET(Layout_Property_Characteristics) new_s) := MODULE//Routines to compute the differences between two instances of a file
  SHARED inFieldList := ['property_rid','dt_vendor_first_reported','dt_vendor_last_reported','tax_sortby_date','deed_sortby_date','vendor_source','fares_unformatted_apn','property_street_address','property_city_state_zip','property_raw_aid','prim_range','predir','prim_name','addr_suffix','postdir','unit_desig','sec_range','p_city_name','v_city_name','st','zip','zip4','cart','cr_sort_sz','lot','lot_order','dbpc','chk_digit','rec_type','county','geo_lat','geo_long','msa','geo_blk','geo_match','err_stat','building_square_footage','src_building_square_footage','tax_dt_building_square_footage','air_conditioning_type','src_air_conditioning_type','tax_dt_air_conditioning_type','basement_finish','src_basement_finish','tax_dt_basement_finish','construction_type','src_construction_type','tax_dt_construction_type','exterior_wall','src_exterior_wall','tax_dt_exterior_wall','fireplace_ind','src_fireplace_ind','tax_dt_fireplace_ind','fireplace_type','src_fireplace_type','tax_dt_fireplace_type','flood_zone_panel','src_flood_zone_panel','tax_dt_flood_zone_panel','garage','src_garage','tax_dt_garage','first_floor_square_footage','src_first_floor_square_footage','tax_dt_first_floor_square_footage','heating','src_heating','tax_dt_heating','living_area_square_footage','src_living_area_square_footage','tax_dt_living_area_square_footage','no_of_baths','src_no_of_baths','tax_dt_no_of_baths','no_of_bedrooms','src_no_of_bedrooms','tax_dt_no_of_bedrooms','no_of_fireplaces','src_no_of_fireplaces','tax_dt_no_of_fireplaces','no_of_full_baths','src_no_of_full_baths','tax_dt_no_of_full_baths','no_of_half_baths','src_no_of_half_baths','tax_dt_no_of_half_baths','no_of_stories','src_no_of_stories','tax_dt_no_of_stories','parking_type','src_parking_type','tax_dt_parking_type','pool_indicator','src_pool_indicator','tax_dt_pool_indicator','pool_type','src_pool_type','tax_dt_pool_type','roof_cover','src_roof_cover','tax_dt_roof_cover','year_built','src_year_built','tax_dt_year_built','foundation','src_foundation','tax_dt_foundation','basement_square_footage','src_basement_square_footage','tax_dt_basement_square_footage','effective_year_built','src_effective_year_built','tax_dt_effective_year_built','garage_square_footage','src_garage_square_footage','tax_dt_garage_square_footage','stories_type','src_stories_type','tax_dt_stories_type','apn_number','src_apn_number','tax_dt_apn_number','census_tract','src_census_tract','tax_dt_census_tract','range','src_range','tax_dt_range','zoning','src_zoning','tax_dt_zoning','block_number','src_block_number','tax_dt_block_number','county_name','src_county_name','tax_dt_county_name','fips_code','src_fips_code','tax_dt_fips_code','subdivision','src_subdivision','tax_dt_subdivision','municipality','src_municipality','tax_dt_municipality','township','src_township','tax_dt_township','homestead_exemption_ind','src_homestead_exemption_ind','tax_dt_homestead_exemption_ind','land_use_code','src_land_use_code','tax_dt_land_use_code','latitude','src_latitude','tax_dt_latitude','longitude','src_longitude','tax_dt_longitude','location_influence_code','src_location_influence_code','tax_dt_location_influence_code','acres','src_acres','tax_dt_acres','lot_depth_footage','src_lot_depth_footage','tax_dt_lot_depth_footage','lot_front_footage','src_lot_front_footage','tax_dt_lot_front_footage','lot_number','src_lot_number','tax_dt_lot_number','lot_size','src_lot_size','tax_dt_lot_size','property_type_code','src_property_type_code','tax_dt_property_type_code','structure_quality','src_structure_quality','tax_dt_structure_quality','water','src_water','tax_dt_water','sewer','src_sewer','tax_dt_sewer','assessed_land_value','src_assessed_land_value','tax_dt_assessed_land_value','assessed_year','src_assessed_year','tax_dt_assessed_year','tax_amount','src_tax_amount','tax_dt_tax_amount','tax_year','src_tax_year','market_land_value','src_market_land_value','tax_dt_market_land_value','improvement_value','src_improvement_value','tax_dt_improvement_value','percent_improved','src_percent_improved','tax_dt_percent_improved','total_assessed_value','src_total_assessed_value','tax_dt_total_assessed_value','total_calculated_value','src_total_calculated_value','tax_dt_total_calculated_value','total_land_value','src_total_land_value','tax_dt_total_land_value','total_market_value','src_total_market_value','tax_dt_total_market_value','floor_type','src_floor_type','tax_dt_floor_type','frame_type','src_frame_type','tax_dt_frame_type','fuel_type','src_fuel_type','tax_dt_fuel_type','no_of_bath_fixtures','src_no_of_bath_fixtures','tax_dt_no_of_bath_fixtures','no_of_rooms','src_no_of_rooms','tax_dt_no_of_rooms','no_of_units','src_no_of_units','tax_dt_no_of_units','style_type','src_style_type','tax_dt_style_type','assessment_document_number','src_assessment_document_number','tax_dt_assessment_document_number','assessment_recording_date','src_assessment_recording_date','tax_dt_assessment_recording_date','deed_document_number','src_deed_document_number','rec_dt_deed_document_number','deed_recording_date','src_deed_recording_date','full_part_sale','src_full_part_sale','rec_dt_full_part_sale','sale_amount','src_sale_amount','rec_dt_sale_amount','sale_date','src_sale_date','rec_dt_sale_date','sale_type_code','src_sale_type_code','rec_dt_sale_type_code','mortgage_company_name','src_mortgage_company_name','rec_dt_mortgage_company_name','loan_amount','src_loan_amount','rec_dt_loan_amount','second_loan_amount','src_second_loan_amount','rec_dt_second_loan_amount','loan_type_code','src_loan_type_code','rec_dt_loan_type_code','interest_rate_type_code','src_interest_rate_type_code','rec_dt_interest_rate_type_code'];
  EXPORT Differences := SALT311.mod_Delta.mac_DifferencesByFieldList(old_s, new_s, inFieldList);
  EXPORT DifferenceSummary(BOOLEAN Glob = TRUE) := hygiene(old_s).Summary('Old',Glob) + hygiene(new_s).Summary('New',Glob) + hygiene(PROJECT(Differences(deleted), TRANSFORM(Layout_Property_Characteristics, SELF := LEFT.old_rec))).Summary('Deletions',Glob) + hygiene(PROJECT(Differences(added), TRANSFORM(Layout_Property_Characteristics, SELF := LEFT.new_rec))).Summary('Additions',Glob);
  EXPORT StandardStats(BOOLEAN doHygieneSummaryGlobal = TRUE, BOOLEAN doHygieneSummaryPerSrc = TRUE) := FUNCTION
    myTimeStamp := (UNSIGNED6)SALT311.Fn_Now('YYYYMMDDHHMMSS') : INDEPENDENT;
    hygieneDiffOverall := DifferenceSummary(TRUE);
    hygieneDiffPerSrc := DifferenceSummary(FALSE);
    SALT311.mod_StandardStatsTransforms.mac_hygieneSummaryTransform(Scrubs_Property_Characteristics, Fields, 'RECORDOF(hygieneDiffOverall)', TRUE);
    hygieneDiffOverall_Standard := IF(doHygieneSummaryGlobal, NORMALIZE(hygieneDiffOverall, COUNT(inFieldList) * 6, xSummary(LEFT, COUNTER, myTimeStamp, LEFT.txt + '_all', LEFT.txt + '_all')));
    hygieneDiffPerSrc_Standard := IF(doHygieneSummaryPerSrc, NORMALIZE(hygieneDiffPerSrc, COUNT(inFieldList) * 6, xSummary(LEFT, COUNTER, myTimeStamp, LEFT.txt + '_src', LEFT.txt + '_src')));
 
    RETURN hygieneDiffOverall_Standard & hygieneDiffPerSrc_Standard;
  END;
END;
