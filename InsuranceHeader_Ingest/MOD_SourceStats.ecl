IMPORT IDL_Header, LinkingTools, STD, ut;

EXPORT MOD_SourceStats(DATASET(IDL_Header.Layout_Header_Link) newInputFile,string version) := MODULE
	shared versionUse := STD.str.filterout(version,' ')[..6];

	shared p_newInputFile := PROJECT(newInputFile,TRANSFORM(RECORDOF(left),self.src := IF(LEFT.src[..3] IN ['ICA','ICP','IVS'],LEFT.src[..3],LEFT.src),self:=left));
	shared p_saltOutput := PROJECT(idl_header.files.DS_SALT_ITER_OUTPUT,TRANSFORM(RECORDOF(left),self.src := IF(LEFT.src[..3] IN ['ICA','ICP','IVS'],LEFT.src[..3],LEFT.src),self:=left));
	shared in_fields := ['ssn','dob','dl_nbr','dl_state','fname','mname','lname','sname','prim_range','prim_name','sec_range','city','st','zip','phone','policy_number','claim_number'];
	shared dt_fields := ['dt_first_seen','dt_last_seen','dt_vendor_first_reported','dt_vendor_last_reported'];
	shared ss := LinkingTools.SourceStats(p_newInputFile,p_saltOutput,rid,src,in_fields,source_rid,dt_fields);
	
	export ss_rec := RECORD
		string timestamp;
		string9 src;
		unsigned8 cnt;
		unsigned8 cntnew;
		unsigned8 cntdeleted;
		unsigned8 cntunchanged;
		unsigned8 cntnew_recdefining;
		unsigned8 cntupdated;
		unsigned8 ssn_added;
		unsigned8 ssn_removed;
		unsigned8 ssn_modified;
		unsigned8 ssn_newlyadded;
		real8 ssn_base_population;
		real8 ssn_new_population;
		unsigned8 dob_added;
		unsigned8 dob_removed;
		unsigned8 dob_modified;
		unsigned8 dob_newlyadded;
		real8 dob_base_population;
		real8 dob_new_population;
		unsigned8 dl_nbr_added;
		unsigned8 dl_nbr_removed;
		unsigned8 dl_nbr_modified;
		unsigned8 dl_nbr_newlyadded;
		real8 dl_nbr_base_population;
		real8 dl_nbr_new_population;
		unsigned8 dl_state_added;
		unsigned8 dl_state_removed;
		unsigned8 dl_state_modified;
		unsigned8 dl_state_newlyadded;
		real8 dl_state_base_population;
		real8 dl_state_new_population;
		unsigned8 fname_added;
		unsigned8 fname_removed;
		unsigned8 fname_modified;
		unsigned8 fname_newlyadded;
		real8 fname_base_population;
		real8 fname_new_population;
		unsigned8 mname_added;
		unsigned8 mname_removed;
		unsigned8 mname_modified;
		unsigned8 mname_newlyadded;
		real8 mname_base_population;
		real8 mname_new_population;
		unsigned8 lname_added;
		unsigned8 lname_removed;
		unsigned8 lname_modified;
		unsigned8 lname_newlyadded;
		real8 lname_base_population;
		real8 lname_new_population;
		unsigned8 sname_added;
		unsigned8 sname_removed;
		unsigned8 sname_modified;
		unsigned8 sname_newlyadded;
		real8 sname_base_population;
		real8 sname_new_population;
		unsigned8 prim_range_added;
		unsigned8 prim_range_removed;
		unsigned8 prim_range_modified;
		unsigned8 prim_range_newlyadded;
		real8 prim_range_base_population;
		real8 prim_range_new_population;
		unsigned8 prim_name_added;
		unsigned8 prim_name_removed;
		unsigned8 prim_name_modified;
		unsigned8 prim_name_newlyadded;
		real8 prim_name_base_population;
		real8 prim_name_new_population;
		unsigned8 sec_range_added;
		unsigned8 sec_range_removed;
		unsigned8 sec_range_modified;
		unsigned8 sec_range_newlyadded;
		real8 sec_range_base_population;
		real8 sec_range_new_population;
		unsigned8 city_added;
		unsigned8 city_removed;
		unsigned8 city_modified;
		unsigned8 city_newlyadded;
		real8 city_base_population;
		real8 city_new_population;
		unsigned8 st_added;
		unsigned8 st_removed;
		unsigned8 st_modified;
		unsigned8 st_newlyadded;
		real8 st_base_population;
		real8 st_new_population;
		unsigned8 zip_added;
		unsigned8 zip_removed;
		unsigned8 zip_modified;
		unsigned8 zip_newlyadded;
		real8 zip_base_population;
		real8 zip_new_population;
		unsigned8 phone_added;
		unsigned8 phone_removed;
		unsigned8 phone_modified;
		unsigned8 phone_newlyadded;
		real8 phone_base_population;
		real8 phone_new_population;
		unsigned8 policy_number_added;
		unsigned8 policy_number_removed;
		unsigned8 policy_number_modified;
		unsigned8 policy_number_newlyadded;
		real8 policy_number_base_population;
		real8 policy_number_new_population;
		unsigned8 claim_number_added;
		unsigned8 claim_number_removed;
		unsigned8 claim_number_modified;
		unsigned8 claim_number_newlyadded;
		real8 claim_number_base_population;
		real8 claim_number_new_population;
		unsigned8 new_dt_first_seen_future;
		unsigned8 new_dt_first_seen_current;
		unsigned8 new_dt_first_seen_6_months;
		unsigned8 new_dt_first_seen_12_months;
		unsigned8 new_dt_first_seen_older;
		unsigned8 change_dt_first_seen_from_zero;
		unsigned8 change_dt_first_seen_to_zero;
		unsigned8 change_dt_first_seen_modified_1_month;
		unsigned8 change_dt_first_seen_modified_6_months;
		unsigned8 change_dt_first_seen_modified_12_months;
		unsigned8 change_dt_first_seen_modified_longer;
		unsigned8 new_dt_last_seen_future;
		unsigned8 new_dt_last_seen_current;
		unsigned8 new_dt_last_seen_6_months;
		unsigned8 new_dt_last_seen_12_months;
		unsigned8 new_dt_last_seen_older;
		unsigned8 change_dt_last_seen_from_zero;
		unsigned8 change_dt_last_seen_to_zero;
		unsigned8 change_dt_last_seen_modified_1_month;
		unsigned8 change_dt_last_seen_modified_6_months;
		unsigned8 change_dt_last_seen_modified_12_months;
		unsigned8 change_dt_last_seen_modified_longer;
		unsigned8 new_dt_vendor_first_reported_future;
		unsigned8 new_dt_vendor_first_reported_current;
		unsigned8 new_dt_vendor_first_reported_6_months;
		unsigned8 new_dt_vendor_first_reported_12_months;
		unsigned8 new_dt_vendor_first_reported_older;
		unsigned8 change_dt_vendor_first_reported_from_zero;
		unsigned8 change_dt_vendor_first_reported_to_zero;
		unsigned8 change_dt_vendor_first_reported_modified_1_month;
		unsigned8 change_dt_vendor_first_reported_modified_6_months;
		unsigned8 change_dt_vendor_first_reported_modified_12_months;
		unsigned8 change_dt_vendor_first_reported_modified_longer;
		unsigned8 new_dt_vendor_last_reported_future;
		unsigned8 new_dt_vendor_last_reported_current;
		unsigned8 new_dt_vendor_last_reported_6_months;
		unsigned8 new_dt_vendor_last_reported_12_months;
		unsigned8 new_dt_vendor_last_reported_older;
		unsigned8 change_dt_vendor_last_reported_from_zero;
		unsigned8 change_dt_vendor_last_reported_to_zero;
		unsigned8 change_dt_vendor_last_reported_modified_1_month;
		unsigned8 change_dt_vendor_last_reported_modified_6_months;
		unsigned8 change_dt_vendor_last_reported_modified_12_months;
		unsigned8 change_dt_vendor_last_reported_modified_longer;
	END;

	
	export filename := '~thor::insuranceheader_ingest::stats::source_stats::' + versionUse + '_'+WORKUNIT;
	export superfilename := '~thor::insuranceheader::validation::source_stats::current';
	export ds := DATASET(superfilename,ss_rec,THOR);
	
	shared ss_projected := PROJECT(ss,TRANSFORM(ss_rec,
																							SELF.timestamp := versionUse;
																							SELF.new_dt_first_seen_6_months := LEFT.new_dt_first_seen_3_months + LEFT.new_dt_first_seen_6_months;
																							SELF.new_dt_first_seen_older := LEFT.new_dt_first_seen_24_months + LEFT.new_dt_first_seen_older;
																							SELF.change_dt_first_seen_modified_6_months := LEFT.change_dt_first_seen_modified_3_months + LEFT.change_dt_first_seen_modified_6_months;
																							SELF.change_dt_first_seen_modified_longer := LEFT.change_dt_first_seen_modified_24_months + LEFT.change_dt_first_seen_modified_longer;
																							SELF.new_dt_last_seen_6_months := LEFT.new_dt_last_seen_3_months + LEFT.new_dt_last_seen_6_months;
																							SELF.new_dt_last_seen_older := LEFT.new_dt_last_seen_24_months + LEFT.new_dt_last_seen_older;
																							SELF.change_dt_last_seen_modified_6_months := LEFT.change_dt_last_seen_modified_3_months + LEFT.change_dt_last_seen_modified_6_months;
																							SELF.change_dt_last_seen_modified_longer := LEFT.change_dt_last_seen_modified_24_months + LEFT.change_dt_last_seen_modified_longer;
																							SELF.new_dt_vendor_first_reported_6_months := LEFT.new_dt_vendor_first_reported_3_months + LEFT.new_dt_vendor_first_reported_6_months;
																							SELF.new_dt_vendor_first_reported_older := LEFT.new_dt_vendor_first_reported_24_months + LEFT.new_dt_vendor_first_reported_older;
																							SELF.change_dt_vendor_first_reported_modified_6_months := LEFT.change_dt_vendor_first_reported_modified_3_months + LEFT.change_dt_vendor_first_reported_modified_6_months;
																							SELF.change_dt_vendor_first_reported_modified_longer := LEFT.change_dt_vendor_first_reported_modified_24_months + LEFT.change_dt_vendor_first_reported_modified_longer;
																							SELF.new_dt_vendor_last_reported_6_months := LEFT.new_dt_vendor_last_reported_3_months + LEFT.new_dt_vendor_last_reported_6_months;
																							SELF.new_dt_vendor_last_reported_older := LEFT.new_dt_vendor_last_reported_24_months + LEFT.new_dt_vendor_last_reported_older;
																							SELF.change_dt_vendor_last_reported_modified_6_months := LEFT.change_dt_vendor_last_reported_modified_3_months + LEFT.change_dt_vendor_last_reported_modified_6_months;
																							SELF.change_dt_vendor_last_reported_modified_longer := LEFT.change_dt_vendor_last_reported_modified_24_months + LEFT.change_dt_vendor_last_reported_modified_longer;
																							self.ssn_base_population := (real8)left.ssn_base_population;
																							self.ssn_new_population := (real8)left.ssn_new_population;
																							self.dob_base_population := (real8)left.dob_base_population;
																							self.dob_new_population := (real8)left.dob_new_population;
																							self.dl_nbr_base_population := (real8)left.dl_nbr_base_population;
																							self.dl_nbr_new_population := (real8)left.dl_nbr_new_population;
																							self.dl_state_base_population := (real8)left.dl_state_base_population;
																							self.dl_state_new_population := (real8)left.dl_state_new_population;
																							self.fname_base_population := (real8)left.fname_base_population;
																							self.fname_new_population := (real8)left.fname_new_population;
																							self.mname_base_population := (real8)left.mname_base_population;
																							self.mname_new_population := (real8)left.mname_new_population;
																							self.lname_base_population := (real8)left.lname_base_population;
																							self.lname_new_population := (real8)left.lname_new_population;
																							self.sname_base_population := (real8)left.sname_base_population;
																							self.sname_new_population := (real8)left.sname_new_population;
																							self.prim_range_base_population := (real8)left.prim_range_base_population;
																							self.prim_range_new_population := (real8)left.prim_range_new_population;
																							self.prim_name_base_population := (real8)left.prim_name_base_population;
																							self.prim_name_new_population := (real8)left.prim_name_new_population;
																							self.sec_range_base_population := (real8)left.sec_range_base_population;
																							self.sec_range_new_population := (real8)left.sec_range_new_population;
																							self.city_base_population := (real8)left.city_base_population;
																							self.city_new_population := (real8)left.city_new_population;
																							self.st_base_population := (real8)left.st_base_population;
																							self.st_new_population := (real8)left.st_new_population;
																							self.zip_base_population := (real8)left.zip_base_population;
																							self.zip_new_population := (real8)left.zip_new_population;
																							self.phone_base_population := (real8)left.phone_base_population;
																							self.phone_new_population := (real8)left.phone_new_population;
																							self.policy_number_base_population := (real8)left.policy_number_base_population;
																							self.policy_number_new_population := (real8)left.policy_number_new_population;
																							self.claim_number_base_population := (real8)left.claim_number_base_population;
																							self.claim_number_new_population := (real8)left.claim_number_new_population;
																							SELF := LEFT));

	export output_stats := SEQUENTIAL(OUTPUT(SORT(ss_projected+ds,-timestamp,src),,filename,compressed,overwrite),
																		STD.file.promoteSuperfileList([superfilename],filename));

END;