import ut;
advo_all_d := distribute(Files().Base.built (zip <> ''), hash(State_code,zip_5,STREET_NUM, STREET_PRE_DIRectional, STREET_NAME));

advo_all_s := sort( advo_all_d, 
				    State_Code	,
					ZIP_5	,
					STREET_NUM	,
					STREET_PRE_DIRectional	,
					STREET_NAME	,
					STREET_POST_DIRectional	,
					STREET_SUFFIX	,
					Secondary_Unit_Designator	,
					Secondary_Unit_Number	,
					Route_Num	,
					ZIP_4   	,
					Throw_Back_Indicator	,
					Seasonal_Delivery_Indicator	,
					Seasonal_Start_Suppression_Date	,
					Seasonal_End_Suppression_Date	,
					DND_Indicator	,
					College_Indicator	,
					College_Start_Suppression_Date	,
					College_End_Suppression_Date	,
					Address_Style_Flag	,
					Simplify_Address_Count	,
					Drop_Indicator	,
					Residential_or_Business_Ind	,
					DPBC_Digit	,
					DPBC_Check_Digit	,
					Override_file_release_date	,
					County_Num	,
					County_Name	,
					City_Name	,
					State_Num	,
					Congressional_District_Number	,
					OWGM_Indicator	,
					Record_Type_Code	,
					ADVO_Key	,
					Address_Type	,
					Mixed_Address_Usage	,
					prim_range,
					predir,
					prim_name,
					addr_suffix,
					postdir,
					unit_desig,
					sec_range,
					p_city_name,
					v_city_name,
					st,
					zip,
					zip4,
				  -date_last_seen,
					-active_flag,
					-Address_Vacancy_Indicator,
					-vac_begdt,
					-vac_enddt,
					-months_vac_curr,
					-months_vac_max,
					-vac_count,
local);

Advo.Layouts.Layout_Common_Out t_rollup (advo_all_s le, advo_all_s ri) := transform
 self.date_first_seen := (string8) ut.min2((unsigned)le.date_first_seen, (unsigned)ri.date_first_seen);
 self.date_last_seen :=  (string8)max((unsigned)le.date_last_seen, (unsigned)ri.date_last_seen);
 self.date_vendor_first_reported := (string8)ut.min2((unsigned)le.date_vendor_first_reported, (unsigned)ri.date_vendor_first_reported);
 self.date_vendor_last_reported := (string8) max((unsigned)le.date_vendor_last_reported, (unsigned)ri.date_vendor_last_reported);
 self.active_flag := if(le.active_flag > ri.active_flag, le.active_flag, ri.active_flag);
 self := le;
  
end;

advo_all_r := rollup(advo_all_s, 
					t_rollup(left, right), record,
					except WALK_Sequence,
									update_date , 
							   file_release_date, 
								 date_first_seen,
								 date_last_seen, 
								 date_vendor_first_reported, 
								 date_vendor_last_reported, 
								 Override_file_release_date,
								 cart,
							   cr_sort_sz,
								 lot,
								 lot_order,
								 dbpc,
								 chk_digit,
								 rec_type,
								 geo_lat,
					       geo_long,
					       msa,
					       geo_blk,
					       geo_match,
								 err_stat,
								 fips_county,
					       county,
								 RawAID,
								 cleanAID,
								 addresstype,
								 active_flag,
								 vac_begdt,
					             vac_enddt,
					             months_vac_curr,
					             months_vac_max,
					             vac_count,
					local);
 

EXPORT Rollup_History := advo_all_r; 

